"use strict";(()=>{var A=Math.PI/180,K=180/Math.PI,j=3600*180/Math.PI;function Ft(){let e=(document.querySelector('form [name="p"]')?.value.trim()??"").split(/\s*[,;]\s*/),r=parseFloat(e[0])*A,o=parseFloat(e[1])*A;return e[0]?.endsWith("S")&&(r*=-1),e[1]?.endsWith("W")&&(o*=-1),{lat:r,lon:o}}function Rt(){return document.querySelector('form [name="t"]')?.value.trim()}function et(){return{location:Ft(),time:Rt()}}var y=class{phi;theta;r;constructor(e,r,o=1){this.phi=e,this.theta=r,this.r=o}};var{abs:X}=Math;function rt(t,e,r){return(t<0||e<0||r<0?-1:1)*(X(t)+X(e)/60+X(r)/3600)}var{floor:q}=Math;function k(t){t=t instanceof Date?t:new Date(t);let e=t.getUTCFullYear(),r=t.getUTCMonth()+1,o=t.getUTCDate(),l=t.getUTCHours(),n=t.getUTCMinutes(),i=t.getUTCSeconds();r<=2&&(r+=12,e--);let s;1e4*e+100*r+o<=15821004?s=-2+q((e+4716)/4)-1179:s=q(e/400)-q(e/100)+q(e/4);let m=365*e-679004+s+q(30.6001*(r+1))+o,a=rt(l,n,i)/24;return m+a}var{PI:Nt,floor:Ht}=Math,Q=86400,Jt=2*Nt;function ot(t){let e=k(t),r=Ht(e),o=Q*(e-r),l=(r-51544.5)/36525,n=(e-51544.5)/36525,i=24110.54841+8640184812866e-6*l+1.0027379093*o+(.093104-62e-7*n)*n*n;return Jt/Q*(i%Q)}var{PI:Bt,sqrt:nt,atan2:it,sin:lt,cos:st}=Math,T=class t{x;y;z;constructor(e=0,r=0,o=0){this.x=e,this.y=r,this.z=o}toPolar(){let{x:e,y:r,z:o}=this,l=e*e+r*r,n=nt(l+o*o),i=it(r,e),s=it(o,nt(l));return i<0&&(i+=2*Bt),new y(i,s,n)}static fromPolar(e){let{phi:r,theta:o,r:l}=e,n=l*st(o);return new t(n*st(r),n*lt(r),l*lt(o))}};function Ut(t,e){let r=0;for(let o=0,l=Math.min(t.length,e.length);o<l;o++)r+=t[o]*e[o];return r}var $=class t{value;rows;columns;constructor(e){this.value=e;let r=[];for(let o=0,l=e.length;o<l;o++)for(let n=0,i=e[o].length;n<i;n++)r[n]||(r[n]=new Array(l)),r[n][o]=e[o][n];this.rows=e,this.columns=r}multiplyByVec(e){return this.multiplyBy(t.fromVector(e)).toCartesianVector()}multiplyBy(e){let r=[];for(let o=0,l=this.rows.length;o<l;o++)for(let n=0,i=e.columns.length;n<i;n++)r[o]||(r[o]=new Array(i)),r[o][n]=Ut(this.rows[o],e.columns[n]);return new t(r)}toCartesianVector(){return new T(this.columns[0][0],this.columns[0][1],this.columns[0][2])}static fromVector(e){if(e instanceof T)return new t([[e.x],[e.y],[e.z]]);if(e instanceof y)return t.fromVector(T.fromPolar(e))}};var{sin:F,cos:R}=Math,P=class extends ${constructor(e){super([[1,0,0],[0,+R(e),+F(e)],[0,-F(e),+R(e)]])}},N=class extends ${constructor(e){super([[+R(e),0,-F(e)],[0,1,0],[+F(e),0,+R(e)]])}};function H({phi:t,theta:e},r,{lat:o,lon:l}){let n=ot(r)+l-t,i=new y(n,e);return new N(Math.PI/2-o).multiplyByVec(i).toPolar()}function x(t){return t-Math.floor(t)}var{sin:mt}=Math,Z=2*Math.PI;function J(t,e=0){let r=(k(t)-51544.5)/36525+e,o=Z*x(.993133+99.997361*r),l=Z*x(.7859453+o/Z+(6893*mt(o)+72*mt(2*o)+6191.2*r)/1296e3);return new y(l,0)}var Ot=23.43929111*A;function ut(t){let e=J(t);return new P(-Ot).multiplyByVec(e).toPolar()}function D(t,e){return H(ut(t),t,e)}var{sin:p}=Math,I=2*Math.PI;function B(t){let e=(k(t)-51544.5)/36525,r=x(.606433+1336.855225*e),o=I*x(.374897+1325.55241*e),l=I*x(.993133+99.997361*e),n=I*x(.827361+1236.853086*e),i=I*x(.259086+1342.227825*e),s=22640*p(o)-4586*p(o-2*n)+2370*p(2*n)+769*p(2*o)-668*p(l)-412*p(2*i)-212*p(2*o-2*n)-206*p(o+l-2*n)+192*p(o+2*n)-165*p(l-2*n)-125*p(n)-110*p(o+l)+148*p(o-l)-55*p(2*i-2*n),m=i+(s+412*p(2*i)+541*p(l))/j,a=i-2*n,c=-526*p(a)+44*p(o+a)-31*p(-o+a)-23*p(l+a)+11*p(-l+a)-25*p(-2*o+i)+21*p(-o+i);return new y(I*x(r+s/1296e3),(18520*p(m)+c)/j)}var Wt=23.43929111*A;function at(t){let e=B(t);return new P(-Wt).multiplyByVec(e).toPolar()}function V(t,e){return H(at(t),t,e)}var tt=2*Math.PI,Yt=-8.32/(1440*36525);function ct(t){return(B(t).phi-J(t,Yt).phi+tt)%tt/tt}var Kt=2*Math.PI,gt=1e3,G=60*gt,v=60*G;function C({phi:t,theta:e}){let r=(t+Math.PI)%Kt*K,o=e*K;return[r,o]}function jt(t){return typeof t=="number"?t:t===void 0||t===""?Date.now():(t instanceof Date?t:new Date(t)).getTime()}var U=-.25;function pt(t,e){if((t.refTime===null||e.time>=t.refTime)&&t.prevAlt!==null&&t.prevTime!==null&&Math.sign(e.alt-U)!==Math.sign(t.prevAlt-U)){let r=Math.abs(t.prevAlt-U)<Math.abs(e.alt-U),o={time:r?t.prevTime:e.time,alt:r?t.prevAlt:e.alt,type:t.prevAlt<e.alt?"rise":"set"};t.events.push(o),t.refTime=o.time}t.prevAlt=e.alt,t.prevTime=e.time}var ft=-2.5*v,dt=22.5*v,Xt=25*v,ht={refTime:null,prevAlt:null,prevTime:null};function bt(t,e){let r=jt(e),o=[],l=[],n={...ht,refTime:r-5*G,events:[]};for(let m=ft;m<Xt;m+=G){let a=r+m,c=C(D(a,t));pt(n,{time:a,alt:c[1]}),m<dt&&(o.push(c),l.push(C(V(a,t))))}for(let m of n.events){let a={...ht,events:[]};for(let u=-G;u<G;u+=gt){let b=m.time+u,E=C(D(b,t));pt(a,{time:b,alt:E[1]})}let c=a.events[0];c&&(m.time=c.time,m.alt=c.alt)}let i=[],s=[];for(let m=0;m>=ft;m-=v)i.push(C(D(r+m,t))),s.push(C(V(r+m,t)));for(let m=v;m<dt;m+=v)i.push(C(D(r+m,t))),s.push(C(V(r+m,t)));return{sun:{position:C(D(r,t)),track:o,ticks:i,events:n.events},moon:{position:C(V(r,t)),track:l,ticks:s,phase:ct(r)}}}function yt({location:t,time:e}){return!t||isNaN(t.lat)||isNaN(t.lon)?!1:e===void 0||e===""||typeof e=="number"?!0:!isNaN(new Date(e).getTime())}function xt({element:t}){let e=t.parentElement;if(!e)return;t.setAttribute("style","display: none");let{width:r,height:o}=e.getBoundingClientRect();t.setAttribute("width",String(r)),t.setAttribute("height",String(o)),t.setAttribute("viewBox",`0 0 ${r} ${o}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}var O=null,Ct="";function f({element:t}){let e=t.getAttribute("data-size");return e===Ct&&O!==null||(O={width:Number(t.getAttribute("width")),height:Number(t.getAttribute("height"))},Ct=e),O}var d="http://www.w3.org/2000/svg",S={default:20,sun:42},L=24,St=0,W=23.5/180*Math.PI;function At([t,e],r){let{width:o,height:l}=f(r),n=(r.location.lat<W?t/o+.5:t/o)*360,i=(.5-(e-L)/(l-2*L))*180;for(;n<0;)n+=360;for(;n>=360;)n-=360;return[n,i]}var Qt=5,wt=["N","E","S","W"];function Mt(t){let e=t.element.querySelector(".directions"),{width:r,height:o}=f(t),l=Array.from(e.querySelectorAll(".tick")),n=Array.from(e.querySelectorAll(".tick-label"));for(;l.length<5;){let i=document.createElementNS(d,"line");i.setAttribute("class","tick"),e.appendChild(i),l.push(i)}for(;n.length<5;){let i=document.createElementNS(d,"text");e.appendChild(i),n.push(i)}for(let i=0;i<l.length;i++){let s=l[i],m=i/4*r;s.setAttribute("x1",String(m)),s.setAttribute("y1",String(o/2-Qt)),s.setAttribute("x2",String(m)),s.setAttribute("y2",String(o/2))}for(let i=0;i<n.length;i++){let s=n[i],m=i/4*r,[a]=At([m,0],t);s.setAttribute("x",String(m)),s.setAttribute("y",String(o/2+12)),s.textContent=wt[Math.floor(a/90)%wt.length],m<1?s.setAttribute("class","leftmost tick-label"):m>r-1?s.setAttribute("class","rightmost tick-label"):s.setAttribute("class","tick-label")}}function Zt(){return new Promise((t,e)=>{if(!navigator.geolocation)return e(new Error("Geolocation is not supported by the browser."));navigator.geolocation.getCurrentPosition(r=>{if(!r||!r.coords)return e(new Error("Failed to retrieve current location."));t({lat:r.coords.latitude,lon:r.coords.longitude})},()=>{e(new Error(`Failed to retrieve current location.
Make sure geolocation is enabled.`))})})}var _t={p:"55.76\xB0 N, 37.62\xB0 E"};function kt(){let t=new URLSearchParams(window.location.search);for(let r of["p","t"]){let o=(t.get(r)??"").trim(),l=document.querySelector(`form [name="${r}"]`);l instanceof HTMLInputElement&&(l.value=o||(_t[r]??""))}let e=document.querySelector("#set-current-location");e&&e.addEventListener("click",()=>{Zt().then(r=>{let{searchParams:o}=new URL(window.location.href);o.set("p",`${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`),window.location.search=o.toString()}).catch(r=>{alert(r.message)})})}function h([t,e],r){let{width:o,height:l}=f(r),n=(r.location.lat<W?t/360-.5:t/360)*o,i=L+(.5-e/180)*(l-2*L);for(;n<0;)n+=o;for(;n>=o;)n-=o;return[n,i]}function Tt(t){let e=t.element.querySelector(".horizon"),{width:r,height:o}=f(t),l=[Array.from(e.querySelectorAll(".under")),Array.from(e.querySelectorAll(".above"))];for(let n=0;n<l.length;n++)for(;l[n].length<3;){let i=document.createElementNS(d,"rect");i.setAttribute("class",n===0?"under":"above"),i.setAttribute("x","0"),e.appendChild(i),l[n].push(i)}for(let n=0;n<3;n++){let i=l[0][n],s=l[1][n],m=h([0,-n*6],t)[1];i.setAttribute("y",String(m)),i.setAttribute("width",String(r)),i.setAttribute("height",String(o-m-St)),s.setAttribute("y","0"),s.setAttribute("width",String(r)),s.setAttribute("height",String(m))}}function Pt(t){let{width:e,height:r}=f(t),o=t.element.querySelector("g.grid"),l=Array.from(o.querySelectorAll("line")),n=0;for(let i=-90;i<=90;i+=30){let s=l[n++],m=h([0,i],t)[1];s||(s=document.createElementNS(d,"line"),o.appendChild(s)),s.setAttribute("x1","0"),s.setAttribute("y1",String(m)),s.setAttribute("x2",String(e)),s.setAttribute("y2",String(m)),s.setAttribute("data-alt",String(i))}for(let i=30;i<360;i+=30){let s=l[n++],m=h([i,0],t)[0];s||(s=document.createElementNS(d,"line"),o.appendChild(s)),s.setAttribute("x1",String(m)),s.setAttribute("y1","0"),s.setAttribute("x2",String(m)),s.setAttribute("y2",String(r))}for(let i=n;i<l.length;i++)l[i].remove()}function Dt(t,e,r){let o=r.element.querySelector(`.markers [data-id="${e}"]`),l=S[e]??S.default,[n,i]=h(t,r);return o.setAttribute("data-id",e),o.setAttribute("x",String(n-l/2)),o.setAttribute("y",String(i-l/2)),o.setAttribute("width",String(l)),o.setAttribute("height",String(l)),o}function vt(t){let{tracks:{sun:e,moon:r}}=t;Dt(e.position,"sun",t),Dt(r.position,"moon",t)}function Lt(t,e,r){let{width:o,height:l}=f(r),n=r.element.querySelector("g.marker-lines"),i=Array.from(n.querySelectorAll(`line[data-id="${e}"]`));for(;i.length<4;){let u=document.createElementNS(d,"line");u.setAttribute("data-id",e),n.appendChild(u),i.push(u)}let[s,m]=h(t,r),a=(S[e]??S.default)/2,c=[[[0,m],[s-a,m]],[[s+a,m],[o,m]],[[s,e==="sun"?0:l/2],[s,m-a]],[[s,m+a],[s,e==="sun"?l/2:l]]];for(let u=0;u<i.length;u++){let b=c[u][1][0]-c[u][0][0],E=c[u][1][1]-c[u][0][1];b<1&&E<1?i[u].setAttribute("class","hidden"):i[u].hasAttribute("class")&&i[u].removeAttribute("class"),i[u].setAttribute("x1",String(c[u][0][0])),i[u].setAttribute("y1",String(c[u][0][1])),i[u].setAttribute("x2",String(c[u][1][0])),i[u].setAttribute("y2",String(c[u][1][1]))}}function Et(t){let{tracks:{sun:e,moon:r}}=t;Lt(e.position,"sun",t),Lt(r.position,"moon",t)}var w=S.moon??S.default,g=w/2;function qt(t){let e=t.element.querySelector("g.markers"),r=e.querySelector('[data-id="moon-phase"]');r||(r=document.createElementNS(d,"svg"),r.setAttribute("data-id","moon-phase"),r.setAttribute("viewBox",`0 0 ${w} ${w}`),r.setAttribute("width",String(w)),r.setAttribute("height",String(w)),e.appendChild(r));let o=r.querySelector("path");o||(o=document.createElementNS(d,"path"),o.setAttribute("class","phase-shadow"),r.appendChild(o));let{position:l,phase:n}=t.tracks.moon;n>=1&&(n-=1);let i=Math.floor(n/.25),s=g*(n%.25/.25),m,a,c,u;switch(i){case 0:m=g,c=1,a=g-s,u=1;break;case 1:m=g,c=1,a=s,u=0;break;case 2:m=g-s,c=0,a=g,u=1;break;default:m=s,c=1,a=g,u=1}o.setAttribute("d",`M ${g},${w} A ${m} ${g} 180 0 ${c} ${g},0 A ${a} ${g} 180 0 ${u} ${g},${w}`);let[b,E]=h(l,t);r.setAttribute("x",String(b-g)),r.setAttribute("y",String(E-g))}function $t(t,e){let{width:r}=f(e),o=document.querySelector(`.pos[data-id="${t}"]`),{position:l}=e.tracks[t];if(o.querySelector(".az .value").textContent=`${l[0].toFixed(1)}\xB0`,o.querySelector(".alt .value").textContent=`${l[1].toFixed(1)}\xB0`,t==="moon")o.querySelector(".ph .value").textContent=`${Math.round(e.tracks.moon.phase*100)}%`;else if(t==="sun"){let s=e.tracks.sun.events.slice(0,2),m="";for(let{time:a,type:c}of s){let u=new Date(a),b=`${String(u.getHours()).padStart(2,"0")}:${String(u.getMinutes()).padStart(2,"0")}`;m+=`${m?" ":""}<span class="event"><span class="type">${c==="rise"?"Rise":"Set"}</span> <span class="value">${b}</span></span>`}o.querySelector(".events").innerHTML=m}let[n]=h(l,e),{width:i}=o.querySelector("span").getBoundingClientRect();o.style.setProperty("--x",`${Math.min(n-6,r-i)}px`)}function It(t){$t("sun",t),$t("moon",t)}function Vt(t,e,r){let{width:o,height:l}=f(r),n=document.createElementNS(d,"path"),i="",s=null,m=null;for(let a=0;a<t.length;a++){let c=i?" L":"M",[u,b]=h(t[a],r);(s!==null&&Math.abs(u-s)>.95*o||m!==null&&Math.abs(b-m)>.95*l)&&(c=" M"),i+=`${c}${u},${b}`,s=u,m=b}return n.setAttribute("d",i),n.setAttribute("class","track"),n.setAttribute("data-id",e),n}function Gt(t,e,r){let o=document.createDocumentFragment();for(let l of t){let n=document.createElementNS(d,"circle"),[i,s]=h(l,r);n.setAttribute("cx",String(i)),n.setAttribute("cy",String(s)),n.setAttribute("r","1.5"),n.setAttribute("class","tick"),n.setAttribute("data-id",e),o.appendChild(n)}return o}function zt(t){let{element:e,tracks:{sun:r,moon:o}}=t,l=e.querySelector("g.tracks");l.innerHTML="",l.appendChild(Vt(r.track,"sun",t)),l.appendChild(Gt(r.ticks,"sun",t)),l.appendChild(Vt(o.track,"moon",t)),l.appendChild(Gt(o.ticks,"moon",t))}var z=null,M=null;function Y(t){if(!M&&(kt(),M=et(),!yt(M))){document.documentElement.classList.add("error");return}let e={...M,element:document.querySelector("#screen svg"),tracks:bt(M.location,M.time)};xt(e),Tt(e),Pt(e),Mt(e),zt(e),vt(e),Et(e),It(e),qt(e),t&&!M.time&&(z!==null&&clearTimeout(z),z=setTimeout(()=>Y(!0),15e3))}function te(){let t=null;window.addEventListener("resize",()=>{t!==null&&clearTimeout(t),t=setTimeout(()=>Y(),200)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?Y(!0):z!==null&&clearTimeout(z)}),Y(!0),document.documentElement.classList.remove("loading")}te();})();
