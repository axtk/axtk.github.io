"use strict";(()=>{var N="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",E={stars:`${N}/stars_m6.json`,constellationLabels:`${N}/constellation_labels.json`,constellationNames:`${N}/constellation_names.json`,constellationLines:`${N}/constellation_lines.json`},p="http://www.w3.org/2000/svg",X={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},Y=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];function pt(t){let o={};for(let n of t){let e=n[5]?.split(", ").at(-1)||`#${n[3]}`;o[e]=[n[0],n[1]]}return o}async function V(){let[t,o,n,e]=await Promise.all([E.stars,E.constellationLabels,E.constellationNames,E.constellationLines].map(i=>fetch(i).then(m=>m.json()))),r=pt(t),l=[];for(let[i,m]of Object.entries(e))for(let s of m){let a=[];for(let u of s){let c;u.includes(" #")||u.startsWith("#")?c=u.split(" ").at(-1):!u.includes(" ")&&i!=="_"?c=`${u} ${i}`:c=u,c&&r[c]&&a.push(r[c])}a.length!==0&&l.push(a)}return{stars:t,constellationLabels:o,constellationNames:n,constellationLines:l}}var T=null,_="";function A({element:t}){let o=t.getAttribute("data-size");if(o===_&&T!==null)return T;let n=Number(t.getAttribute("width")),e=Number(t.getAttribute("height"));return T={width:n,height:e,r:Math.sqrt(n*n+e*e)/1.65,x0:n/2,y0:e/2},_=o,T}var{sin:$,cos:h}=Math;function f(t,o,n,e=.25){let{tilt:[r,l]}=n,{width:i,height:m,x0:s,y0:a,r:u}=A(n),c=u*h(o)*h(t),M=u*$(o),v=u*h(o)*$(t),D=c*h(r)+v*$(r),k=M,P=-c*$(r)+v*h(r),b=D,g=k*h(l)-P*$(l),q=k*$(l)+P*h(l);return b=s+b,g=a-g,q<0||b<-e*i||b>(1+e)*i||g<-e*m||g>(1+e)*m?null:[b,g,q]}var{PI:d}=Math,R=d/100,w=d/12,K=d/50;function H(t){let o=t.element.querySelector("g.grid"),n=o.querySelector("path");n||(n=document.createElementNS(p,"path"),o.appendChild(n));let e,r="",l="";for(let i=-d/2+w;i<=d/2-w+R;i+=w){let m="",s=!1;for(let a=0;a<=2*d+R;a+=K){if(e=f(a,i,t,.5),l=m&&!s?" L":"M",e===null){s=!0;continue}s&&(s=!1),m+=`${l}${e[0].toFixed(3)},${e[1].toFixed(3)}`}r+=`${r?" ":""}${m}`}for(let i=0;i<=2*d-w+R;i+=w){let m="",s=!1;for(let a=-d/2;a<=d/2+R;a+=K){if(e=f(i,a,t,.5),l=m&&!s?" L":"M",e===null){s=!0;continue}s&&(s=!1),m+=`${l}${e[0].toFixed(3)},${e[1].toFixed(3)}`}r+=`${r?" ":""}${m}`}n.setAttribute("d",r)}function L(t,o){return o.mode==="fantasy"?2*(6.75-t[2]):.5*(6.75-t[2])}var{floor:j,random:y,sin:O,cos:J,PI:W}=Math;function dt(){return`#${["","",""].map(()=>j(50+120*y()).toString(16)).join("")}`}var bt=30,z=[];function gt(){if(z.length===bt)return z[j(y()*z.length)];let t="",o=Array.from({length:2}).map(()=>dt());for(let n=0;n<2;n++)for(let e=.25*n;e<5;e++){let r=2*W*y(),l=5+e*J(r),i=5+e*O(r),m=r+W*(.5+.5*y()),s=5+e*J(m),a=5+e*O(m),u=o[j(y()*o.length)];t+=`<path d="M${l} ${i} A ${e} ${e} 0 1 0 ${s} ${a}" stroke="${u}" stroke-width="${(.75+y()).toFixed(3)}" stroke-opacity="${(.35+.55*y()).toFixed(3)}"/>`}return z.push(t),t}function Q(t){let o=t.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("svg")),e=null;for(let u of o.querySelectorAll("circle"))u.remove();let r,l,i,m,s,a=0;for(let u=0;u<t.stars.length;u++)r=t.stars[u],i=f(r[0],r[1],t),i!==null&&(l=n[a++],l||(e||(e=document.createDocumentFragment()),l=document.createElementNS(p,"svg"),l.setAttribute("viewBox","0 0 10 10"),l.innerHTML=gt(),e.appendChild(l)),m=L(r,t),s=(2*m).toFixed(3),l.setAttribute("x",(i[0]-m).toFixed(3)),l.setAttribute("y",(i[1]-m).toFixed(3)),l.setAttribute("width",s),l.setAttribute("height",s),l.setAttribute("data-spcl",r[4]));e&&o.appendChild(e);for(let u=a;u<n.length;u++)n[u].remove()}function U(t){if(t.mode==="fantasy")return Q(t);let o=t.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("circle")),e=null;for(let s of o.querySelectorAll("svg"))s.remove();let r,l,i,m=0;for(let s=0;s<t.stars.length;s++)r=t.stars[s],i=f(r[0],r[1],t),i!==null&&(l=n[m++],l||(e||(e=document.createDocumentFragment()),l=document.createElementNS(p,"circle"),e.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",L(r,t).toFixed(3)),l.setAttribute("data-spcl",r[4]));e&&o.appendChild(e);for(let s=m;s<n.length;s++)n[s].remove()}function ht(t){if(!t[5])return;let n=t[5].split(", ").at(-1)?.split(" ")?.[0]?.match(/^([^\d]+)(\d+)?$/);if(!n||n.length<2)return;let e=X[n[1]]??n[1]??"";if(!e)return;let r=n[2]?Y[Number(n[2])]??"":"";return`${e}${r}`}function Z(t){let o=t.element.querySelector("g.star-labels"),n=Array.from(o.querySelectorAll("text")),e=null,r,l,i,m,s=0;for(let a=0;a<t.stars.length;a++){if(r=t.stars[a],l=ht(r),!l||(m=f(r[0],r[1],t),m===null))continue;i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(p,"text"),e.appendChild(i));let u=L(r,t);i.setAttribute("x",(m[0]+u+2).toFixed(3)),i.setAttribute("y",(m[1]+2).toFixed(3)),i.setAttribute("data-x",r[2]<3?"1":"0"),i.textContent=l}e&&o.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function yt(t,o){if(t[2])return o.constellationNames[t[2]]??t[2]}function tt(t){let o=t.element.querySelector("g.constellation-labels"),n=Array.from(o.querySelectorAll("text")),e=null,r,l,i,m,s=0;for(let a=0;a<t.constellationLabels.length;a++)r=t.constellationLabels[a],l=yt(r,t),!(!r[2]||!l)&&(m=f(r[0],r[1],t),m!==null&&(i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(p,"text"),e.appendChild(i)),i.setAttribute("x",m[0].toFixed(3)),i.setAttribute("y",m[1].toFixed(3)),i.textContent=l));e&&o.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function et(t){let o=t.element.querySelector("g.constellation-lines"),n=Array.from(o.querySelectorAll("path")),e=null,r,l,i,m,s=0;for(let a=0;a<t.constellationLines.length;a++){r=t.constellationLines[a],l="";for(let u of r)m=f(u[0],u[1],t,1),m!==null&&(l+=`${l?" L":"M"}${m[0]},${m[1]}`);l&&(i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(p,"path"),e.appendChild(i)),i.setAttribute("d",l))}e&&o.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function C(t){H(t),U(t),Z(t),tt(t),et(t)}var nt="stars.",S={read(t){try{let o=localStorage.getItem(`${nt}${t}`);return o===null?null:JSON.parse(o)}catch{return null}},write(t,o){try{localStorage.setItem(`${nt}${t}`,JSON.stringify(o))}catch{}}};function F(t,o=0,n=2*Math.PI,e){for(;t<o;)t+=n-o;if(e)for(;t>n;)t-=n-o;else for(;t>=n;)t-=n-o;return t}var{PI:rt,asin:ot}=Math,x=!1;function lt(t,o,n){let{tilt:e}=t,{r}=A(t),l=ot(o/r),i=ot(n/r),m=e[0]+l,s=e[1]+i;e[0]=F(m),s>=-rt/2&&s<=rt/2&&(e[1]=s),x||(requestAnimationFrame(()=>{C(t),S.write("tilt",e),x=!1}),x=!0)}function Ct(t){let{element:o}=t,n=null,e=null;o.addEventListener("mousedown",r=>{n=r.offsetX,e=r.offsetY,x=!1}),o.addEventListener("mouseup",()=>{n=null,e=null,x=!1}),o.addEventListener("mousemove",r=>{n!==null&&e!==null&&(lt(t,r.offsetX-n,r.offsetY-e),n=r.offsetX,e=r.offsetY)})}function St(t){let{element:o}=t,n=null,e=null;o.addEventListener("touchstart",r=>{n=r.changedTouches[0].pageX,e=r.changedTouches[0].pageY,x=!1}),o.addEventListener("touchend",()=>{n=null,e=null,x=!1}),o.addEventListener("touchmove",r=>{n!==null&&e!==null&&(lt(t,r.changedTouches[0].pageX-n,r.changedTouches[0].pageY-e),n=r.changedTouches[0].pageX,e=r.changedTouches[0].pageY)})}function it(t){Ct(t),St(t)}var{sin:I,cos:G,asin:xt,atan2:At,sqrt:$t,PI:st}=Math;function at(t,o,n){let{tilt:[e,r]}=n,{r:l,x0:i,y0:m}=A(n),s=t-i,a=m-o,u=l*l-s*s-a*a;if(u<0)return null;let c=$t(u),M=s,v=a*G(-r)-c*I(-r),D=a*I(-r)+c*G(-r),k=M*G(-e)+D*I(-e),P=v,b=-M*I(-e)+D*G(-e),g=F(At(b,k)),q=F(xt(P/l),-st/2,st/2,!0);return[g,q]}var{abs:mt}=Math,ut=5;function Lt(t,o){return t[2]-o[2]}function ft(t){document.addEventListener("click",o=>{if(!t.element.contains(o.target))return;let{left:n,top:e}=t.element.getBoundingClientRect(),r=o.offsetX-n,l=o.offsetY-e,i=at(r,l,t);if(console.log("click",i),i===null)return;let m=[];for(let s of t.stars){let a=f(s[0],s[1],t);a!==null&&mt(a[0]-r)<=ut&&mt(a[1]-l)<=ut&&m.push(s)}m.sort(Lt);for(let s of m)console.log(`#${s[3]}; ${s[5]}`,s[2]),window.sendEvent?.(["click star",String(s[5]??s[3])])})}function ct(t){let o=document.querySelector("#screen form");for(let n of o.querySelectorAll('[name="mode"]'))n.checked=n.value===t.mode;o.addEventListener("change",n=>{let e=n.target;if(e instanceof HTMLInputElement&&e.name==="mode"){let r=t.mode,l=e.value;document.documentElement.dataset.mode=l,t.mode=l,(l==="fantasy"||r==="fantasy")&&C(t),S.write("mode",l),window.sendEvent?.(["set mode",l])}})}function B({element:t}){let o=t.parentElement;if(!o)return;t.setAttribute("style","display: none");let{width:n,height:e}=o.getBoundingClientRect();t.setAttribute("width",String(n)),t.setAttribute("height",String(e)),t.setAttribute("viewBox",`0 0 ${n} ${e}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}async function Et(){let t=document.querySelector("#screen svg"),o=await V(),n=S.read("mode")??document.documentElement.dataset.mode,e={...o,element:t,tilt:S.read("tilt")??[-.12,0],mode:n};document.documentElement.dataset.mode!==n&&(document.documentElement.dataset.mode=n);let r=null;window.addEventListener("resize",()=>{r!==null&&cancelAnimationFrame(r),r=requestAnimationFrame(()=>{B(e),C(e)})}),B(e),ct(e),C(e),it(e),ft(e)}Et();})();
