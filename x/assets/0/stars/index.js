"use strict";(()=>{var X="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",T={stars:`${X}/stars_m6_bsc5.csv`,constellations:`${X}/constellations.csv`,hintLines:`${X}/constellation_lines.csv`},g="http://www.w3.org/2000/svg",_={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},J=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"],U={O:"#c0ffff",B:"#c0ffff",A:"#ffffff",F:"#ffffff",G:"#f9f9d8",K:"#ffe0c0",M:"#f9cdcd"};var q=class{abbr;name;label;constructor({abbr:t,name:r,label:n}){this.abbr=t,this.name=r,this.label=n}};function v(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function Z(e){return e.trim().split(/\r?\n/).slice(1).map(t=>{let[r,n,o,l]=t.split(",");return new q({abbr:r,name:v(l),label:{ra:Number(n),dec:Number(o)}})})}function M(e){let t=e?.match(/^([^\d]+)(\d+)?$/);if(!t)return e;let[,r="",n=""]=t;return _[r]&&(r=_[r]),n&&(n=J[Number(n)]??n),`${r}${n}`}function Te(e){let t={};for(let r of e){let n=r.bayerName||`#${r.id}`;t[n]=r}return t}function G(e){return e?[e.ra,e.dec]:null}function qe(e,t){return e.magnitude-t.magnitude}var He=[1,2,3],Re=["A","B"];function ze(e,t,r){let n=[];for(let l of He){let i=r[`${M(`${e}${l}`)} ${t}`];i&&n.push(i)}let o=M(e);for(let l of Re){let i=r[`${o} ${t} ${l}`];i&&n.push(i)}return n.sort(qe)[0]}function ee(e,t){let r=Te(t);return e.trim().split(/\r?\n/).slice(1).map(n=>{let o=n.split(","),l=[],i=o[0],s=v(o[1]).split(" ");for(let m of s){let a=null;if(m.includes("=")&&(a=G(r[`#${m.split("=").at(-1)}`])),a){l.push(a);continue}let f="",d="";if(m.includes("_")){let u=m.indexOf("_");f=m.slice(0,u),d=m.slice(u+1).replace(/_/g," ")}else f=m,d=i;f&&d&&(a=G(r[`${M(f)} ${d}`]),a||(a=G(ze(f,d,r)))),a&&l.push(a)}return l})}var H=class{ra;dec;magnitude;id;spectralClass;bayerKey;bayerName;properName;constructor({ra:t,dec:r,magnitude:n,id:o,spectralClass:l,bayerName:i,properName:s}){if(this.ra=t,this.dec=r,this.magnitude=n,this.id=o,this.spectralClass=l,this.properName=s,i){let[m,...a]=i.split(" "),f=M(m);this.bayerKey=f,this.bayerName=f?`${f}${a.length===0?"":` ${a.join(" ")}`}`:void 0}}get name(){let{bayerName:t}=this;if(t!==void 0)return this.properName?`${this.properName}, ${t}`:t}};function Be(e,t){return e.magnitude-t.magnitude}function te(e){return e.trim().split(/\r?\n/).slice(1).map(t=>{let[r,n,o,l,i,s,m]=t.split(",");return new H({ra:Number(r),dec:Number(n),magnitude:Number(o),id:i,spectralClass:l,bayerName:v(s),properName:v(m)})}).sort(Be)}async function Ie(e){return fetch(e).then(t=>t.text())}async function ne(){let[e,t,r]=await Promise.all([T.stars,T.constellations,T.hintLines].map(Ie)),n=te(e),o=Z(t),l=ee(r,n);return{stars:n,constellations:o,hintLines:l}}function D(){document.querySelector("#screenmenu")?.classList.add("hidden")}var R=null,re="";function y({element:e}){let t=e.getAttribute("data-size");if(t===re&&R!==null)return R;let r=Number(e.getAttribute("width")),n=Number(e.getAttribute("height"));return R={width:r,height:n,r:.65*Math.sqrt(r*r+n*n),x0:r/2,y0:n/2},re=t,R}function F(e,t=0,r=2*Math.PI,n){for(;e<t;)e+=r-t;if(n)for(;e>r;)e-=r-t;else for(;e>=r;)e-=r-t;return e}var{sin:z,cos:B,asin:Ke,atan2:Ye,sqrt:Xe,PI:oe}=Math;function ie(e,t,r){let{tilt:[n,o]}=r,{r:l,x0:i,y0:s}=y(r),m=e-i,a=s-t,f=l*l-m*m-a*a;if(f<0)return null;let d=Xe(f),u=m,p=a*B(-o)-d*z(-o),h=a*z(-o)+d*B(-o),b=u*B(-n)+h*z(-n),L=p,S=-u*z(-n)+h*B(-n),C=F(Ye(S,b)),k=F(Ke(L/l),-oe/2,oe/2,!0);return[C,k]}var{sin:A,cos:w}=Math;function c(e,t,r,n=.25){let{tilt:[o,l]}=r,{width:i,height:s,x0:m,y0:a,r:f}=y(r),d=f*w(t)*w(e),u=f*A(t),p=f*w(t)*A(e),h=d*w(o)+p*A(o),b=u,L=-d*A(o)+p*w(o),S=h,C=b*w(l)-L*A(l),k=b*A(l)+L*w(l);return S=m+S,C=a-C,k<0||S<-n*i||S>(1+n)*i||C<-n*s||C>(1+n)*s?null:[S,C,k]}function O(e,t){let r=document.createElement("td");return r.className=`${t?"":"x "}${e}`,r.textContent=t||"\u2022",r}function le(e){let t=document.createDocumentFragment(),r=document.createElement("table"),n=e.some(({properName:o})=>!!o);for(let o of e){let l=document.createElement("tr");n&&l.append(O("n",o.properName)),l.append(O("b",o.bayerName||`HD ${o.id}`)),l.append(O("m",`${o.magnitude}\u1D50`)),r.append(l)}return t.append(r),t}var j=240;function me(e,t,r,n){let{width:o,height:l}=y(n),i=document.querySelector("#screenmenu");if(i||(i=document.createElement("div"),i.id="screenmenu",n.element.parentElement?.appendChild(i)),r.children.length===0){i.classList.add("hidden");return}i.innerHTML="",i.style.width="",i.append(r),i.classList.remove("hidden");let{width:s,height:m}=i.getBoundingClientRect();s>j?(i.style.width=`${j}px`,i.classList.add("wide"),s=j):i.classList.remove("wide");let a=Math.min(e+4,o-s-6),f=Math.min(t+4,l-m-6);i.style.setProperty("--x",`${a}px`),i.style.setProperty("--y",`${f}px`)}var{abs:ae}=Math,se=5;function _e(e,t){return e.magnitude-t.magnitude}function ue(e){document.addEventListener("click",t=>{if(!e.element.contains(t.target))return;let{left:r,top:n}=e.element.getBoundingClientRect(),o=t.offsetX-r,l=t.offsetY-n;if(ie(o,l,e)===null)return;let s=[];for(let m of e.stars){let a=c(m.ra,m.dec,e);a!==null&&ae(a[0]-o)<=se&&ae(a[1]-l)<=se&&s.push(m)}s.sort(_e);for(let m of s)window.sendEvent?.(["click star",m.name??`#${m.id}`]);me(o,l,le(s),e)})}function fe(e){let t=e.element.querySelector("g.constellation-labels"),r=Array.from(t.querySelectorAll("text")),n=null,o,l,i,s=0;for(let m=0;m<e.constellations.length;m++)o=e.constellations[m],o.name&&(i=c(o.label.ra,o.label.dec,e),i!==null&&(l=r[s++],l||(n||(n=document.createDocumentFragment()),l=document.createElementNS(g,"text"),n.appendChild(l)),l.setAttribute("x",i[0].toFixed(3)),l.setAttribute("y",i[1].toFixed(3)),l.textContent=o.name));n&&t.appendChild(n);for(let m=s;m<r.length;m++)r[m].remove()}var{PI:x}=Math,I=x/100,P=x/12,de=x/50;function pe(e){let t=e.element.querySelector("g.grid"),r=t.querySelector("path");r||(r=document.createElementNS(g,"path"),t.appendChild(r));let n,o="",l="";for(let i=-x/2+P;i<=x/2-P+I;i+=P){let s="",m=!1;for(let a=0;a<=2*x+I;a+=de){if(n=c(a,i,e,.5),l=s&&!m?" L":"M",n===null){m=!0;continue}m&&(m=!1),s+=`${l}${n[0].toFixed(3)},${n[1].toFixed(3)}`}o+=`${o?" ":""}${s}`}for(let i=0;i<=2*x-P+I;i+=P){let s="",m=!1;for(let a=-x/2;a<=x/2+I;a+=de){if(n=c(i,a,e,.5),l=s&&!m?" L":"M",n===null){m=!0;continue}m&&(m=!1),s+=`${l}${n[0].toFixed(3)},${n[1].toFixed(3)}`}o+=`${o?" ":""}${s}`}r.setAttribute("d",o)}function ce(e){let t=e.element.querySelector("g.hint-lines"),r=Array.from(t.querySelectorAll("path")),n=null,o,l,i,s,m=0;for(let a=0;a<e.hintLines.length;a++){o=e.hintLines[a],l="";for(let f of o)s=c(f[0],f[1],e,1),s!==null&&(l+=`${l?" L":"M"}${s[0]},${s[1]}`);l&&(i=r[m++],i||(n||(n=document.createDocumentFragment()),i=document.createElementNS(g,"path"),n.appendChild(i)),i.setAttribute("d",l))}n&&t.appendChild(n);for(let a=m;a<r.length;a++)r[a].remove()}var he=!1,ge='html[data-mode="dark"] #screen .stars circle';function be(e){if(e.mode!=="dark"||he)return;let t=e.element.parentElement,r=t.querySelector("defs"),n=r?.querySelector("#spcl")?.outerHTML;if(!r||!n)return;let o=document.createElement("style"),l="",i="",s="";i+=`${ge}:not([r^="0."]){fill:url(#spcl);}`;for(let[m,a]of Object.entries(U)){let f=`${ge}[data-spcl^="${m}"]`;l+=`${f}[r^="0."]{fill:${a};}`,i+=`${f}:not([r^="0."]){fill:url(#spcl_${m});}`,s+=`
${n}`.replace('id="spcl"',`id="spcl_${m}"`).replaceAll("currentColor",a)}r.innerHTML+=s,o.innerHTML=l,o.innerHTML=i,t.prepend(o),he=!0}var{floor:ye,max:Ge}=Math,K=class{grid={};cellSizeX;cellSizeY;constructor(t=30,r){this.cellSizeX=t,this.cellSizeY=r??t}push(t,r,n){let o=`${ye(r/this.cellSizeX)},${ye(n/this.cellSizeY)}`;this.grid[o]||(this.grid[o]=[]),this.grid[o].push(t)}_getNeightborCellIndices(t){let[r,n]=t.split(",").map(Number),o=[];for(let l=-1;l<=1;l++)for(let i=-1;i<=1;i++){let s=this.grid[`${r+l},${n+i}`];s&&o.push(...s)}return o}resolve(t){let r=new Set;for(let n of Object.keys(this.grid)){let o=this._getNeightborCellIndices(n);if(!(o.length<2))for(let l of o)for(let i of o){if(l===i||r.has(l)||r.has(i)||!t[l]||!t[i])continue;let s=t[l].getBoundingClientRect(),m=t[i].getBoundingClientRect();s.left<m.right&&s.right>m.left&&s.top<m.bottom&&s.bottom>m.top&&r.add(Ge(l,i))}}return r}};function Y(e,t){return t.mode==="fantasy"?2*(6.75-e.magnitude):t.mode==="light"?.6*(6.75-e.magnitude):.7*(6.75-e.magnitude)}function Se(e){let{r:t}=y(e),r=t<640?3.5:4,n=e.element.querySelector("g.star-labels"),o=Array.from(n.querySelectorAll("text")),l=null,i,s,m,a=0,f=new K;for(let u=0;u<e.stars.length;u++){if(i=e.stars[u],!i.bayerKey)continue;if(i.magnitude>r)break;if(m=c(i.ra,i.dec,e),m===null)continue;s=o[a],s||(l||(l=document.createDocumentFragment()),s=document.createElementNS(g,"text"),l.appendChild(s),o.push(s));let p=Y(i,e),h=m[0]+p+2,b=m[1]+2;f.push(a,h,b),s.setAttribute("x",h.toFixed(3)),s.setAttribute("y",b.toFixed(3)),s.textContent=i.bayerKey,a++}l&&n.appendChild(l);let d=f.resolve(o);for(let u=a;u<o.length;u++)o[u].remove();for(let u of d)o[u]?.remove()}var{floor:Ee,random:N,sin:Ce,cos:xe,PI:$e}=Math;function Oe(){return`#${["","",""].map(()=>Ee(50+120*N()).toString(16)).join("")}`}var ve=30,we=!1,je='html[data-mode="fantasy"] #screen .stars circle';function Le(e){if(e.mode!=="fantasy"||we)return;let t=e.element.parentElement,r=t.querySelector("defs");if(!r)return;let n=document.createDocumentFragment(),o="";for(let i=0;i<ve;i++){let s="",m=Array.from({length:2}).map(()=>Oe());for(let f=0;f<2;f++)for(let d=.25*f;d<5;d++){let u=2*$e*N(),p=5+d*xe(u),h=5+d*Ce(u),b=u+$e*(.5+.5*N()),L=5+d*xe(b),S=5+d*Ce(b),C=m[Ee(N()*m.length)];s+=`<path d="M${p} ${h} A ${d} ${d} 0 1 0 ${L} ${S}" class="p" stroke="${C}" stroke-width="${(.75+N()).toFixed(3)}" stroke-opacity="${(.35+.55*N()).toFixed(3)}"/>`}let a=document.createElementNS(g,"pattern");a.setAttribute("id",`p_${i}`),a.setAttribute("viewBox","0 0 10 10"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.innerHTML=s,n.append(a),o+=`${je}:nth-child(${ve}n+${i}){fill:url(#p_${i});}`}let l=document.createElement("style");l.innerHTML=o,t.append(l),r.append(n),we=!0}function Me(e,t){return t.mode==="fantasy"?Math.min(.5+.2*(6.75-e.magnitude),1):Math.min(.2+.15*(6.75-e.magnitude),1)}function Ae(e){let t=e.element.querySelector("g.stars"),r=Array.from(t.querySelectorAll("circle")),n=null,o,l,i,s=0,m=e.moving?.5:.1;for(let a=0;a<e.stars.length;a++){if(o=e.stars[a],i=c(o.ra,o.dec,e),i===null)continue;let f=Y(o,e);f<m||(l=r[s++],l||(n||(n=document.createDocumentFragment()),l=document.createElementNS(g,"circle"),n.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",f.toFixed(2)),l.setAttribute("fill-opacity",Me(o,e).toFixed(2)),l.setAttribute("data-spcl",o.spectralClass??""))}n&&t.appendChild(n);for(let a=s;a<r.length;a++)r[a].remove()}function $(e){e.element.dataset.moving=String(e.moving??""),pe(e),be(e),Ae(e),Se(e),Le(e),fe(e),ce(e)}var Ne="stars.",E={read(e){try{let t=localStorage.getItem(`${Ne}${e}`);return t===null?null:JSON.parse(t)}catch{return null}},write(e,t){try{localStorage.setItem(`${Ne}${e}`,JSON.stringify(t))}catch{}}};var{PI:De,asin:Fe}=Math,V=null;function Q(e,t,r){V!==null&&cancelAnimationFrame(V);let{tilt:n}=e,{r:o}=y(e),l=Fe(t/o),i=Fe(r/o),s=n[0]+l,m=n[1]+i;n[0]=F(s),m>=-De/2&&m<=De/2&&(n[1]=m),V=requestAnimationFrame(()=>{$(e)})}function Pe(e){let{element:t}=e,r=null,n=null,o=Date.now();function l(u,p){u===void 0||p===void 0||(D(),r=u,n=p,o=Date.now())}function i(u,p){u===void 0||p===void 0||(r!==null&&n!==null&&Q(e,u-r,p-n),s())}function s(){e.moving=!1,r=null,n=null,requestAnimationFrame(()=>{E.write("tilt",e.tilt),$(e)})}function m(u,p){if(u===void 0||p===void 0)return;let h=Date.now();r===null||n===null||h-o<100||(e.moving||(e.moving=!0),Q(e,u-r,p-n),r=u,n=p,o=h)}let a=null,f=null;t.addEventListener("mousedown",u=>{l(u.offsetX,u.offsetY),a||(a=p=>{p.preventDefault(),m(p.offsetX,p.offsetY)},t.addEventListener("mousemove",a))}),t.addEventListener("mouseup",u=>{a&&(i(u.offsetX,u.offsetY),t.removeEventListener("mousemove",a),a=null)}),t.addEventListener("touchstart",u=>{l(u.touches[0]?.pageX,u.touches[0]?.pageY),f||(f=p=>{p.preventDefault(),m(p.touches[0]?.pageX,p.touches[0]?.pageY)},t.addEventListener("touchmove",f))}),t.addEventListener("touchend",u=>{f&&(i(u.touches[0]?.pageX,u.touches[0]?.pageY),t.removeEventListener("touchmove",f),f=null)}),t.addEventListener("touchcancel",u=>{f&&(i(u.touches[0]?.pageX,u.touches[0]?.pageY),t.removeEventListener("touchmove",f),f=null)});let d=null;t.addEventListener("wheel",u=>{u.preventDefault(),e.moving||(e.moving=!0,D()),d&&clearTimeout(d),Q(e,-u.deltaX,-u.deltaY),d=setTimeout(()=>{d=null,s()},250)})}function ke(e){let t=document.querySelector("#screen form");for(let r of t.querySelectorAll('[name="mode"]'))r.checked=r.value===e.mode;t.addEventListener("change",r=>{let n=r.target;if(n instanceof HTMLInputElement&&n.name==="mode"){let o=n.value;document.documentElement.dataset.mode=o,e.mode=o,$(e),E.write("mode",o),window.sendEvent?.(["set mode",o])}})}function W({element:e}){let t=e.parentElement;if(!t)return;e.setAttribute("style","display: none");let{width:r,height:n}=t.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(n)),e.setAttribute("viewBox",`0 0 ${r} ${n}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}var Ve=[1.7,1.05];async function Qe(){let e=document.querySelector("#screen svg"),t=await ne(),r=document.documentElement.dataset.mode||E.read("mode"),n={...t,element:e,tilt:E.read("tilt")??Ve,mode:r};document.documentElement.dataset.mode!==r&&(document.documentElement.dataset.mode=r);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{D(),W(n),$(n)})}),W(n),ke(n),$(n),Pe(n),ue(n),window.sendEvent?.(["load mode",r])}Qe();})();
