"use strict";(()=>{var R="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",E={stars:`${R}/stars_m6.csv`,constellationLabels:`${R}/constellation_labels.csv`,constellationNames:`${R}/constellation_names.csv`,constellationLines:`${R}/constellation_lines.csv`},p="http://www.w3.org/2000/svg",_={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},W=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];function N(e){let r=e?.match(/^([^\d]+)(\d+)?$/);if(!r)return e;let[,n="",t=""]=r;return _[n]&&(n=_[n]),t&&(t=W[Number(t)]??t),`${n}${t}`}var K=class{ra;dec;magnitude;id;spectralClass;bayerKey;constellation;properName;constructor({ra:r,dec:n,magnitude:t,id:o,spectralClass:l,bayerName:i,properName:a}){this.ra=r,this.dec=n,this.magnitude=t,this.id=o,this.spectralClass=l,this.properName=a,i&&([this.bayerKey,this.constellation]=i.split(" "),this.bayerKey=N(this.bayerKey))}get bayerName(){if(this.bayerKey!==void 0)return this.constellation===void 0?this.bayerKey:`${this.bayerKey} ${this.constellation}`}get name(){let{bayerName:r}=this;if(r!==void 0)return this.properName?`${this.properName}, ${r}`:r}};function v(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function J(e){return e.trim().split(/\r?\n/).slice(1).map(r=>{let[n,t,o,l,i,a,s]=r.split(",");return new K({ra:Number(n),dec:Number(t),magnitude:Number(o),id:l,spectralClass:i,bayerName:v(a),properName:v(s)})})}var z=class{ra;dec;name;constructor({ra:r,dec:n,name:t}){this.ra=r,this.dec=n,this.name=t}};function j(e){return e.trim().split(/\r?\n/).slice(1).map(r=>{let[n,t,o]=r.split(",");return new z({ra:Number(t),dec:Number(o),name:n})})}function we(e){let r={};for(let n of e){let t=n.bayerName||`#${n.id}`;r[t]=[n.ra,n.dec]}return r}function U(e,r){let n=we(r);return e.trim().split(/\r?\n/).map(t=>{let o=t.split(","),l=[],i=o[0],a=o[1].slice(1,-1).split(" ");for(let s of a){let m;if(s.includes("="))m=`#${s.split("=").at(-1)}`;else if(s.includes("_")){let u=s.indexOf("_");m=`${N(s.slice(0,u))} ${s.slice(u+1)}`}else m=`${N(s)} ${i}`;m&&n[m]&&l.push(n[m])}return l})}function Z(e){return e.trim().split(/\r?\n/).slice(1).reduce((r,n)=>{let[t,o]=n.split(",").map(v);return t&&o&&(r[t]=o),r},{})}async function Ae(e){return fetch(e).then(r=>r.text())}async function ee(){let[e,r,n,t]=await Promise.all([E.stars,E.constellationLabels,E.constellationNames,E.constellationLines].map(Ae)),o=J(e),l=j(r),i=U(t,o),a=Z(n);return{stars:o,constellationLabels:l,constellationNames:a,constellationLines:i}}var B=null,te="";function d({element:e}){let r=e.getAttribute("data-size");if(r===te&&B!==null)return B;let n=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return B={width:n,height:t,r:Math.sqrt(n*n+t*t)/1.65,x0:n/2,y0:t/2},te=r,B}function I(){document.querySelector("#screenmenu")?.classList.add("hidden")}var{sin:A,cos:x}=Math;function f(e,r,n,t=.25){let{tilt:[o,l]}=n,{width:i,height:a,x0:s,y0:m,r:u}=d(n),c=u*x(r)*x(e),g=u*A(r),b=u*x(r)*A(e),P=c*x(o)+b*A(o),k=g,q=-c*A(o)+b*x(o),y=P,C=k*x(l)-q*A(l),T=k*A(l)+q*x(l);return y=s+y,C=m-C,T<0||y<-t*i||y>(1+t)*i||C<-t*a||C>(1+t)*a?null:[y,C,T]}var{PI:h}=Math,G=h/100,F=h/12,ne=h/50;function re(e){let r=e.element.querySelector("g.grid"),n=r.querySelector("path");n||(n=document.createElementNS(p,"path"),r.appendChild(n));let t,o="",l="";for(let i=-h/2+F;i<=h/2-F+G;i+=F){let a="",s=!1;for(let m=0;m<=2*h+G;m+=ne){if(t=f(m,i,e,.5),l=a&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),a+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}for(let i=0;i<=2*h-F+G;i+=F){let a="",s=!1;for(let m=-h/2;m<=h/2+G;m+=ne){if(t=f(i,m,e,.5),l=a&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),a+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}n.setAttribute("d",o)}function M(e,r){return r.mode==="fantasy"?2*(6.75-e.magnitude):.5*(6.75-e.magnitude)}var{floor:H,random:S,sin:oe,cos:ie,PI:le}=Math;function Me(){return`#${["","",""].map(()=>H(50+120*S()).toString(16)).join("")}`}var Ee=30,X=[];function Ne(){if(X.length===Ee)return X[H(S()*X.length)];let e="",r=Array.from({length:2}).map(()=>Me());for(let n=0;n<2;n++)for(let t=.25*n;t<5;t++){let o=2*le*S(),l=5+t*ie(o),i=5+t*oe(o),a=o+le*(.5+.5*S()),s=5+t*ie(a),m=5+t*oe(a),u=r[H(S()*r.length)];e+=`<path d="M${l} ${i} A ${t} ${t} 0 1 0 ${s} ${m}" stroke="${u}" stroke-width="${(.75+S()).toFixed(3)}" stroke-opacity="${(.35+.55*S()).toFixed(3)}"/>`}return X.push(e),e}function se(e){let r=e.element.querySelector("g.stars"),n=Array.from(r.querySelectorAll("svg")),t=null;for(let u of r.querySelectorAll("circle"))u.remove();let o,l,i,a,s,m=0;for(let u=0;u<e.stars.length;u++)o=e.stars[u],i=f(o.ra,o.dec,e),i!==null&&(l=n[m++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(p,"svg"),l.setAttribute("viewBox","0 0 10 10"),l.innerHTML=Ne(),t.appendChild(l)),a=M(o,e),s=(2*a).toFixed(3),l.setAttribute("x",(i[0]-a).toFixed(3)),l.setAttribute("y",(i[1]-a).toFixed(3)),l.setAttribute("width",s),l.setAttribute("height",s),l.setAttribute("data-spcl",o.spectralClass));t&&r.appendChild(t);for(let u=m;u<n.length;u++)n[u].remove()}function ae(e){if(e.mode==="fantasy")return se(e);let r=e.element.querySelector("g.stars"),n=Array.from(r.querySelectorAll("circle")),t=null;for(let s of r.querySelectorAll("svg"))s.remove();let o,l,i,a=0;for(let s=0;s<e.stars.length;s++)o=e.stars[s],i=f(o.ra,o.dec,e),i!==null&&(l=n[a++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(p,"circle"),t.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",M(o,e).toFixed(3)),l.setAttribute("data-spcl",o.spectralClass??""));t&&r.appendChild(t);for(let s=a;s<n.length;s++)n[s].remove()}function me(e){let{r}=d(e),n=r<640?3:4,t=e.element.querySelector("g.star-labels"),o=Array.from(t.querySelectorAll("text")),l=null,i,a,s,m=0;for(let u=0;u<e.stars.length;u++){if(i=e.stars[u],!i.bayerKey||i.magnitude>n||(s=f(i.ra,i.dec,e),s===null))continue;a=o[m++],a||(l||(l=document.createDocumentFragment()),a=document.createElementNS(p,"text"),l.appendChild(a));let c=M(i,e);a.setAttribute("x",(s[0]+c+2).toFixed(3)),a.setAttribute("y",(s[1]+2).toFixed(3)),a.textContent=i.bayerKey}l&&t.appendChild(l);for(let u=m;u<o.length;u++)o[u].remove()}function ve(e,r){if(e.name)return r.constellationNames[e.name]??e.name}function ue(e){let r=e.element.querySelector("g.constellation-labels"),n=Array.from(r.querySelectorAll("text")),t=null,o,l,i,a,s=0;for(let m=0;m<e.constellationLabels.length;m++)o=e.constellationLabels[m],l=ve(o,e),l&&(a=f(o.ra,o.dec,e),a!==null&&(i=n[s++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(p,"text"),t.appendChild(i)),i.setAttribute("x",a[0].toFixed(3)),i.setAttribute("y",a[1].toFixed(3)),i.textContent=l));t&&r.appendChild(t);for(let m=s;m<n.length;m++)n[m].remove()}function fe(e){let r=e.element.querySelector("g.constellation-lines"),n=Array.from(r.querySelectorAll("path")),t=null,o,l,i,a,s=0;for(let m=0;m<e.constellationLines.length;m++){o=e.constellationLines[m],l="";for(let u of o)a=f(u[0],u[1],e,1),a!==null&&(l+=`${l?" L":"M"}${a[0]},${a[1]}`);l&&(i=n[s++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(p,"path"),t.appendChild(i)),i.setAttribute("d",l))}t&&r.appendChild(t);for(let m=s;m<n.length;m++)n[m].remove()}function $(e){re(e),ae(e),me(e),ue(e),fe(e)}var pe="stars.",L={read(e){try{let r=localStorage.getItem(`${pe}${e}`);return r===null?null:JSON.parse(r)}catch{return null}},write(e,r){try{localStorage.setItem(`${pe}${e}`,JSON.stringify(r))}catch{}}};function D(e,r=0,n=2*Math.PI,t){for(;e<r;)e+=n-r;if(t)for(;e>n;)e-=n-r;else for(;e>=n;)e-=n-r;return e}var{PI:de,asin:ce}=Math,w=!1;function he(e,r,n){let{tilt:t}=e,{r:o}=d(e),l=ce(r/o),i=ce(n/o),a=t[0]+l,s=t[1]+i;t[0]=D(a),s>=-de/2&&s<=de/2&&(t[1]=s),w||(requestAnimationFrame(()=>{$(e),L.write("tilt",t),w=!1}),w=!0)}function Fe(e){let{element:r}=e,n=null,t=null;r.addEventListener("mousedown",o=>{n=o.offsetX,t=o.offsetY,w=!1}),r.addEventListener("mouseup",()=>{n=null,t=null,w=!1}),r.addEventListener("mousemove",o=>{n!==null&&t!==null&&(he(e,o.offsetX-n,o.offsetY-t),n=o.offsetX,t=o.offsetY)})}function De(e){let{element:r}=e,n=null,t=null;r.addEventListener("touchstart",o=>{n=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY,w=!1,I()}),r.addEventListener("touchend",()=>{n=null,t=null,w=!1}),r.addEventListener("touchmove",o=>{n!==null&&t!==null&&(he(e,o.changedTouches[0].pageX-n,o.changedTouches[0].pageY-t),n=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY)})}function ge(e){Fe(e),De(e)}var{sin:Y,cos:V,asin:Pe,atan2:ke,sqrt:qe,PI:be}=Math;function ye(e,r,n){let{tilt:[t,o]}=n,{r:l,x0:i,y0:a}=d(n),s=e-i,m=a-r,u=l*l-s*s-m*m;if(u<0)return null;let c=qe(u),g=s,b=m*V(-o)-c*Y(-o),P=m*Y(-o)+c*V(-o),k=g*V(-t)+P*Y(-t),q=b,y=-g*Y(-t)+P*V(-t),C=D(ke(y,k)),T=D(Pe(q/l),-be/2,be/2,!0);return[C,T]}var O=240;function Ce(e,r,n,t){let{width:o,height:l}=d(t),i=document.querySelector("#screenmenu");if(i||(i=document.createElement("div"),i.id="screenmenu",t.element.parentElement?.appendChild(i)),n.length===0){i.classList.add("hidden");return}let a=document.createElement("ul");for(let g of n){let b=document.createElement("li");b.textContent=g.name??`#${g.id}`,a.appendChild(b)}i.innerHTML="",i.style.width="",i.appendChild(a),i.classList.remove("hidden");let{width:s,height:m}=i.getBoundingClientRect();s>O?(i.style.width=`${O}px`,i.classList.add("wide"),s=O):i.classList.remove("wide");let u=Math.min(e+4,o-s-6),c=Math.min(r+4,l-m-6);i.style.setProperty("--x",`${u}px`),i.style.setProperty("--y",`${c}px`)}var{abs:xe}=Math,Se=5;function Te(e,r){return e.magnitude-r.magnitude}function $e(e){document.addEventListener("click",r=>{if(!e.element.contains(r.target))return;let{left:n,top:t}=e.element.getBoundingClientRect(),o=r.offsetX-n,l=r.offsetY-t,i=ye(o,l,e);if(console.log("click",i),i===null)return;let a=[];for(let s of e.stars){let m=f(s.ra,s.dec,e);m!==null&&xe(m[0]-o)<=Se&&xe(m[1]-l)<=Se&&a.push(s)}a.sort(Te);for(let s of a)console.log(`#${s.id}; ${s.name}`,s.magnitude),window.sendEvent?.(["click star",s.name??`#${s.id}`]);Ce(o,l,a,e)})}function Le(e){let r=document.querySelector("#screen form");for(let n of r.querySelectorAll('[name="mode"]'))n.checked=n.value===e.mode;r.addEventListener("change",n=>{let t=n.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let o=e.mode,l=t.value;document.documentElement.dataset.mode=l,e.mode=l,(l==="fantasy"||o==="fantasy")&&$(e),L.write("mode",l),window.sendEvent?.(["set mode",l])}})}function Q({element:e}){let r=e.parentElement;if(!r)return;e.setAttribute("style","display: none");let{width:n,height:t}=r.getBoundingClientRect();e.setAttribute("width",String(n)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${n} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}async function Re(){let e=document.querySelector("#screen svg"),r=await ee(),n=L.read("mode")??document.documentElement.dataset.mode,t={...r,element:e,tilt:L.read("tilt")??[-.12,0],mode:n};document.documentElement.dataset.mode!==n&&(document.documentElement.dataset.mode=n);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{I(),Q(t),$(t)})}),Q(t),Le(t),$(t),ge(t),$e(t)}Re();})();
