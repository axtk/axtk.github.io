"use strict";(()=>{var q="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",$={stars:`${q}/stars_m6.json`,constellationLabels:`${q}/constellation_labels.json`,constellationNames:`${q}/constellation_names.json`,constellationLines:`${q}/constellation_lines.json`},c="http://www.w3.org/2000/svg",V={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},_=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];var N=class{ra;dec;magnitude;id;spectralClass;name;constructor(o){[this.ra,this.dec,this.magnitude,this.id,this.spectralClass,this.name]=o}};var T=class{ra;dec;name;constructor(o){[this.ra,this.dec,this.name]=o}};function be(e){let o={};for(let n of e){let t=n.name?.split(", ").at(-1)||`#${n.id}`;o[t]=[n.ra,n.dec]}return o}function K(e,o){let n=be(o),t=[];for(let[r,l]of Object.entries(e))for(let a of l){let s=[];for(let i of a){let m;i.includes(" #")||i.startsWith("#")?m=i.split(" ").at(-1):!i.includes(" ")&&r!=="_"?m=`${i} ${r}`:m=i,m&&n[m]&&s.push(n[m])}s.length!==0&&t.push(s)}return t}async function H(){let[e,o,n,t]=await Promise.all([$.stars,$.constellationLabels,$.constellationNames,$.constellationLines].map(s=>fetch(s).then(i=>i.json()))),r=e.map(s=>new N(s)),l=o.map(s=>new T(s)),a=K(t,r);return{stars:r,constellationLabels:l,constellationNames:n,constellationLines:a}}var z=null,O="";function x({element:e}){let o=e.getAttribute("data-size");if(o===O&&z!==null)return z;let n=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return z={width:n,height:t,r:Math.sqrt(n*n+t*t)/1.65,x0:n/2,y0:t/2},O=o,z}var{sin:L,cos:b}=Math;function f(e,o,n,t=.25){let{tilt:[r,l]}=n,{width:a,height:s,x0:i,y0:m,r:u}=x(n),A=u*b(o)*b(e),M=u*L(o),R=u*b(o)*L(e),v=A*b(r)+R*L(r),D=M,k=-A*L(r)+R*b(r),p=v,g=D*b(l)-k*L(l),P=D*L(l)+k*b(l);return p=i+p,g=m-g,P<0||p<-t*a||p>(1+t)*a||g<-t*s||g>(1+t)*s?null:[p,g,P]}var{PI:d}=Math,I=d/100,E=d/12,J=d/50;function W(e){let o=e.element.querySelector("g.grid"),n=o.querySelector("path");n||(n=document.createElementNS(c,"path"),o.appendChild(n));let t,r="",l="";for(let a=-d/2+E;a<=d/2-E+I;a+=E){let s="",i=!1;for(let m=0;m<=2*d+I;m+=J){if(t=f(m,a,e,.5),l=s&&!i?" L":"M",t===null){i=!0;continue}i&&(i=!1),s+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}r+=`${r?" ":""}${s}`}for(let a=0;a<=2*d-E+I;a+=E){let s="",i=!1;for(let m=-d/2;m<=d/2+I;m+=J){if(t=f(a,m,e,.5),l=s&&!i?" L":"M",t===null){i=!0;continue}i&&(i=!1),s+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}r+=`${r?" ":""}${s}`}n.setAttribute("d",r)}function w(e,o){return o.mode==="fantasy"?2*(6.75-e.magnitude):.5*(6.75-e.magnitude)}var{floor:X,random:h,sin:Q,cos:U,PI:Z}=Math;function he(){return`#${["","",""].map(()=>X(50+120*h()).toString(16)).join("")}`}var Ce=30,G=[];function Se(){if(G.length===Ce)return G[X(h()*G.length)];let e="",o=Array.from({length:2}).map(()=>he());for(let n=0;n<2;n++)for(let t=.25*n;t<5;t++){let r=2*Z*h(),l=5+t*U(r),a=5+t*Q(r),s=r+Z*(.5+.5*h()),i=5+t*U(s),m=5+t*Q(s),u=o[X(h()*o.length)];e+=`<path d="M${l} ${a} A ${t} ${t} 0 1 0 ${i} ${m}" stroke="${u}" stroke-width="${(.75+h()).toFixed(3)}" stroke-opacity="${(.35+.55*h()).toFixed(3)}"/>`}return G.push(e),e}function ee(e){let o=e.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("svg")),t=null;for(let u of o.querySelectorAll("circle"))u.remove();let r,l,a,s,i,m=0;for(let u=0;u<e.stars.length;u++)r=e.stars[u],a=f(r.ra,r.dec,e),a!==null&&(l=n[m++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"svg"),l.setAttribute("viewBox","0 0 10 10"),l.innerHTML=Se(),t.appendChild(l)),s=w(r,e),i=(2*s).toFixed(3),l.setAttribute("x",(a[0]-s).toFixed(3)),l.setAttribute("y",(a[1]-s).toFixed(3)),l.setAttribute("width",i),l.setAttribute("height",i),l.setAttribute("data-spcl",r.spectralClass));t&&o.appendChild(t);for(let u=m;u<n.length;u++)n[u].remove()}function te(e){if(e.mode==="fantasy")return ee(e);let o=e.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("circle")),t=null;for(let i of o.querySelectorAll("svg"))i.remove();let r,l,a,s=0;for(let i=0;i<e.stars.length;i++)r=e.stars[i],a=f(r.ra,r.dec,e),a!==null&&(l=n[s++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"circle"),t.appendChild(l)),l.setAttribute("cx",a[0].toFixed(3)),l.setAttribute("cy",a[1].toFixed(3)),l.setAttribute("r",w(r,e).toFixed(3)),l.setAttribute("data-spcl",r.spectralClass));t&&o.appendChild(t);for(let i=s;i<n.length;i++)n[i].remove()}function ye(e){if(!e.name)return;let n=e.name?.split(", ").at(-1)?.split(" ")?.[0]?.match(/^([^\d]+)(\d+)?$/);if(!n||n.length<2)return;let t=V[n[1]]??n[1]??"";if(!t)return;let r=n[2]?_[Number(n[2])]??"":"";return`${t}${r}`}function ne(e){let o=e.element.querySelector("g.star-labels"),n=Array.from(o.querySelectorAll("text")),t=null,r,l,a,s,i=0;for(let m=0;m<e.stars.length;m++){if(r=e.stars[m],l=ye(r),!l||(s=f(r.ra,r.dec,e),s===null))continue;a=n[i++],a||(t||(t=document.createDocumentFragment()),a=document.createElementNS(c,"text"),t.appendChild(a));let u=w(r,e);a.setAttribute("x",(s[0]+u+2).toFixed(3)),a.setAttribute("y",(s[1]+2).toFixed(3)),a.setAttribute("data-x",r.magnitude<3?"1":"0"),a.textContent=l}t&&o.appendChild(t);for(let m=i;m<n.length;m++)n[m].remove()}function xe(e,o){if(e.name)return o.constellationNames[e.name]??e.name}function re(e){let o=e.element.querySelector("g.constellation-labels"),n=Array.from(o.querySelectorAll("text")),t=null,r,l,a,s,i=0;for(let m=0;m<e.constellationLabels.length;m++)r=e.constellationLabels[m],l=xe(r,e),l&&(s=f(r.ra,r.dec,e),s!==null&&(a=n[i++],a||(t||(t=document.createDocumentFragment()),a=document.createElementNS(c,"text"),t.appendChild(a)),a.setAttribute("x",s[0].toFixed(3)),a.setAttribute("y",s[1].toFixed(3)),a.textContent=l));t&&o.appendChild(t);for(let m=i;m<n.length;m++)n[m].remove()}function oe(e){let o=e.element.querySelector("g.constellation-lines"),n=Array.from(o.querySelectorAll("path")),t=null,r,l,a,s,i=0;for(let m=0;m<e.constellationLines.length;m++){r=e.constellationLines[m],l="";for(let u of r)s=f(u[0],u[1],e,1),s!==null&&(l+=`${l?" L":"M"}${s[0]},${s[1]}`);l&&(a=n[i++],a||(t||(t=document.createDocumentFragment()),a=document.createElementNS(c,"path"),t.appendChild(a)),a.setAttribute("d",l))}t&&o.appendChild(t);for(let m=i;m<n.length;m++)n[m].remove()}function C(e){W(e),te(e),ne(e),re(e),oe(e)}var le="stars.",S={read(e){try{let o=localStorage.getItem(`${le}${e}`);return o===null?null:JSON.parse(o)}catch{return null}},write(e,o){try{localStorage.setItem(`${le}${e}`,JSON.stringify(o))}catch{}}};function F(e,o=0,n=2*Math.PI,t){for(;e<o;)e+=n-o;if(t)for(;e>n;)e-=n-o;else for(;e>=n;)e-=n-o;return e}var{PI:ie,asin:ae}=Math,y=!1;function se(e,o,n){let{tilt:t}=e,{r}=x(e),l=ae(o/r),a=ae(n/r),s=t[0]+l,i=t[1]+a;t[0]=F(s),i>=-ie/2&&i<=ie/2&&(t[1]=i),y||(requestAnimationFrame(()=>{C(e),S.write("tilt",t),y=!1}),y=!0)}function Le(e){let{element:o}=e,n=null,t=null;o.addEventListener("mousedown",r=>{n=r.offsetX,t=r.offsetY,y=!1}),o.addEventListener("mouseup",()=>{n=null,t=null,y=!1}),o.addEventListener("mousemove",r=>{n!==null&&t!==null&&(se(e,r.offsetX-n,r.offsetY-t),n=r.offsetX,t=r.offsetY)})}function we(e){let{element:o}=e,n=null,t=null;o.addEventListener("touchstart",r=>{n=r.changedTouches[0].pageX,t=r.changedTouches[0].pageY,y=!1}),o.addEventListener("touchend",()=>{n=null,t=null,y=!1}),o.addEventListener("touchmove",r=>{n!==null&&t!==null&&(se(e,r.changedTouches[0].pageX-n,r.changedTouches[0].pageY-t),n=r.changedTouches[0].pageX,t=r.changedTouches[0].pageY)})}function me(e){Le(e),we(e)}var{sin:j,cos:B,asin:Ae,atan2:$e,sqrt:Ee,PI:ue}=Math;function fe(e,o,n){let{tilt:[t,r]}=n,{r:l,x0:a,y0:s}=x(n),i=e-a,m=s-o,u=l*l-i*i-m*m;if(u<0)return null;let A=Ee(u),M=i,R=m*B(-r)-A*j(-r),v=m*j(-r)+A*B(-r),D=M*B(-t)+v*j(-t),k=R,p=-M*j(-t)+v*B(-t),g=F($e(p,D)),P=F(Ae(k/l),-ue/2,ue/2,!0);return[g,P]}var{abs:ce}=Math,de=5;function Fe(e,o){return e.magnitude-o.magnitude}function pe(e){document.addEventListener("click",o=>{if(!e.element.contains(o.target))return;let{left:n,top:t}=e.element.getBoundingClientRect(),r=o.offsetX-n,l=o.offsetY-t,a=fe(r,l,e);if(console.log("click",a),a===null)return;let s=[];for(let i of e.stars){let m=f(i.ra,i.dec,e);m!==null&&ce(m[0]-r)<=de&&ce(m[1]-l)<=de&&s.push(i)}s.sort(Fe);for(let i of s)console.log(`#${i.id}; ${i.name}`,i.magnitude),window.sendEvent?.(["click star",String(i.name??`#${i.id}`)])})}function ge(e){let o=document.querySelector("#screen form");for(let n of o.querySelectorAll('[name="mode"]'))n.checked=n.value===e.mode;o.addEventListener("change",n=>{let t=n.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let r=e.mode,l=t.value;document.documentElement.dataset.mode=l,e.mode=l,(l==="fantasy"||r==="fantasy")&&C(e),S.write("mode",l),window.sendEvent?.(["set mode",l])}})}function Y({element:e}){let o=e.parentElement;if(!o)return;e.setAttribute("style","display: none");let{width:n,height:t}=o.getBoundingClientRect();e.setAttribute("width",String(n)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${n} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}async function Me(){let e=document.querySelector("#screen svg"),o=await H(),n=S.read("mode")??document.documentElement.dataset.mode,t={...o,element:e,tilt:S.read("tilt")??[-.12,0],mode:n};document.documentElement.dataset.mode!==n&&(document.documentElement.dataset.mode=n);let r=null;window.addEventListener("resize",()=>{r!==null&&cancelAnimationFrame(r),r=requestAnimationFrame(()=>{Y(t),C(t)})}),Y(t),ge(t),C(t),me(t),pe(t)}Me();})();
