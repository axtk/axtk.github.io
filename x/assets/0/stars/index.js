"use strict";(()=>{var G="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",v={stars:`${G}/stars_m6_ppm.csv`,constellations:`${G}/constellations.csv`,hintLines:`${G}/constellation_lines.csv`},d="http://www.w3.org/2000/svg",X={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},V=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"],Q={O:"#c0ffff",B:"#c0ffff",A:"#ffffff",F:"#ffffff",G:"#f9f9d8",K:"#ffe0c0",M:"#f9cdcd"};function F(e){let n=e?.match(/^([^\d]+)(\d+)?$/);if(!n)return e;let[,r="",t=""]=n;return X[r]&&(r=X[r]),t&&(t=V[Number(t)]??t),`${r}${t}`}var q=class{ra;dec;magnitude;id;spectralClass;bayerKey;constellation;properName;constructor({ra:n,dec:r,magnitude:t,id:o,spectralClass:s,bayerName:l,properName:a}){this.ra=n,this.dec=r,this.magnitude=t,this.id=o,this.spectralClass=s,this.properName=a,l&&([this.bayerKey,this.constellation]=l.split(" "),this.bayerKey=F(this.bayerKey))}get bayerName(){if(this.bayerKey!==void 0)return this.constellation===void 0?this.bayerKey:`${this.bayerKey} ${this.constellation}`}get name(){let{bayerName:n}=this;if(n!==void 0)return this.properName?`${this.properName}, ${n}`:n}};function D(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function W(e){return e.trim().split(/\r?\n/).slice(1).map(n=>{let[r,t,o,s,l,a,i]=n.split(",");return new q({ra:Number(r),dec:Number(t),magnitude:Number(o),id:l,spectralClass:s,bayerName:D(a),properName:D(i)})})}var K=class{abbr;name;label;constructor({abbr:n,name:r,label:t}){this.abbr=n,this.name=r,this.label=t}};function j(e){return e.trim().split(/\r?\n/).slice(1).map(n=>{let[r,t,o,s]=n.split(",");return new K({abbr:r,name:D(s),label:{ra:Number(t),dec:Number(o)}})})}function Ne(e){let n={};for(let r of e){let t=r.bayerName||`#${r.id}`;n[t]=[r.ra,r.dec]}return n}function J(e,n){let r=Ne(n);return e.trim().split(/\r?\n/).map(t=>{let o=t.split(","),s=[],l=o[0],a=o[1].slice(1,-1).split(" ");for(let i of a){let m=null;if(i.includes("=")&&(m=r[`#${i.split("=").at(-1)}`]),m){s.push(m);continue}if(i.includes("_")){let u=i.indexOf("_");m=r[`${F(i.slice(0,u))} ${i.slice(u+1)}`]}else m=r[`${F(i)} ${l}`];m&&s.push(m)}return s})}async function Fe(e){return fetch(e).then(n=>n.text())}async function U(){let[e,n,r]=await Promise.all([v.stars,v.constellations,v.hintLines].map(Fe)),t=W(e),o=j(n),s=J(r,t);return{stars:t,constellations:o,hintLines:s}}var H=null,Z="";function h({element:e}){let n=e.getAttribute("data-size");if(n===Z&&H!==null)return H;let r=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return H={width:r,height:t,r:.52*Math.sqrt(r*r+t*t),x0:r/2,y0:t/2},Z=n,H}function R(){document.querySelector("#screenmenu")?.classList.add("hidden")}var ee=!1;function te(e){if(e.mode!=="dark"||ee)return;let n=e.element.parentElement,r=n.querySelector("defs"),t=r?.querySelector("#spcl")?.outerHTML;if(!r||!t)return;let o=document.createElement("style"),s="",l="",a="";for(let[i,m]of Object.entries(Q)){let u=`html[data-mode="dark"] #screen .stars circle[data-spcl^="${i}"]`;s+=`${u}[r^="0."]{fill:${m};}`,l+=`${u}:not([r^="0."]){fill:url(#spcl_${i});}`,a+=`
${t}`.replace('id="spcl"',`id="spcl_${i}"`).replaceAll("currentColor",m)}r.innerHTML+=a,o.innerHTML=s,o.innerHTML=l,n.prepend(o),ee=!0}var{sin:A,cos:S}=Math;function p(e,n,r,t=.25){let{tilt:[o,s]}=r,{width:l,height:a,x0:i,y0:m,r:u}=h(r),f=u*S(n)*S(e),c=u*A(n),g=u*S(n)*A(e),L=f*S(o)+g*A(o),x=c,E=-f*A(o)+g*S(o),b=L,y=x*S(s)-E*A(s),k=x*A(s)+E*S(s);return b=i+b,y=m-y,k<0||b<-t*l||b>(1+t)*l||y<-t*a||y>(1+t)*a?null:[b,y,k]}var{PI:C}=Math,z=C/100,P=C/12,re=C/50;function ne(e){let n=e.element.querySelector("g.grid"),r=n.querySelector("path");r||(r=document.createElementNS(d,"path"),n.appendChild(r));let t,o="",s="";for(let l=-C/2+P;l<=C/2-P+z;l+=P){let a="",i=!1;for(let m=0;m<=2*C+z;m+=re){if(t=p(m,l,e,.5),s=a&&!i?" L":"M",t===null){i=!0;continue}i&&(i=!1),a+=`${s}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}for(let l=0;l<=2*C-P+z;l+=P){let a="",i=!1;for(let m=-C/2;m<=C/2+z;m+=re){if(t=p(l,m,e,.5),s=a&&!i?" L":"M",t===null){i=!0;continue}i&&(i=!1),a+=`${s}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}r.setAttribute("d",o)}function B(e,n){return n.mode==="fantasy"?2*(6.75-e.magnitude):n.mode==="light"?.6*(6.75-e.magnitude):.7*(6.75-e.magnitude)}function oe(e,n){return n.mode==="fantasy"?Math.min(.5+.2*(6.75-e.magnitude),1):Math.min(.2+.15*(6.75-e.magnitude),1)}function ie(e){let n=e.element.querySelector("g.stars"),r=Array.from(n.querySelectorAll("circle")),t=null,o,s,l,a=0;for(let i=0;i<e.stars.length;i++)o=e.stars[i],l=p(o.ra,o.dec,e),l!==null&&(s=r[a++],s||(t||(t=document.createDocumentFragment()),s=document.createElementNS(d,"circle"),t.appendChild(s)),s.setAttribute("cx",l[0].toFixed(3)),s.setAttribute("cy",l[1].toFixed(3)),s.setAttribute("r",B(o,e).toFixed(2)),s.setAttribute("fill-opacity",oe(o,e).toFixed(2)),s.setAttribute("data-spcl",o.spectralClass??""));t&&n.appendChild(t);for(let i=a;i<r.length;i++)r[i].remove()}function le(e){let{r:n}=h(e),r=n<640?3:4,t=e.element.querySelector("g.star-labels"),o=Array.from(t.querySelectorAll("text")),s=null,l,a,i,m=0;for(let u=0;u<e.stars.length;u++){if(l=e.stars[u],!l.bayerKey||l.magnitude>r||(i=p(l.ra,l.dec,e),i===null))continue;a=o[m++],a||(s||(s=document.createDocumentFragment()),a=document.createElementNS(d,"text"),s.appendChild(a));let f=B(l,e);a.setAttribute("x",(i[0]+f+2).toFixed(3)),a.setAttribute("y",(i[1]+2).toFixed(3)),a.textContent=l.bayerKey}s&&t.appendChild(s);for(let u=m;u<o.length;u++)o[u].remove()}var{floor:pe,random:N,sin:se,cos:ae,PI:me}=Math;function De(){return`#${["","",""].map(()=>pe(50+120*N()).toString(16)).join("")}`}var ue=30,fe=!1,Pe='html[data-mode="fantasy"] #screen .stars circle';function de(e){if(e.mode!=="fantasy"||fe)return;let n=e.element.parentElement,r=n.querySelector("defs");if(!r)return;let t=document.createDocumentFragment(),o="";for(let l=0;l<ue;l++){let a="",i=Array.from({length:2}).map(()=>De());for(let u=0;u<2;u++)for(let f=.25*u;f<5;f++){let c=2*me*N(),g=5+f*ae(c),L=5+f*se(c),x=c+me*(.5+.5*N()),E=5+f*ae(x),b=5+f*se(x),y=i[pe(N()*i.length)];a+=`<path d="M${g} ${L} A ${f} ${f} 0 1 0 ${E} ${b}" class="p" stroke="${y}" stroke-width="${(.75+N()).toFixed(3)}" stroke-opacity="${(.35+.55*N()).toFixed(3)}"/>`}let m=document.createElementNS(d,"pattern");m.setAttribute("id",`p_${l}`),m.setAttribute("viewBox","0 0 10 10"),m.setAttribute("width","100%"),m.setAttribute("height","100%"),m.innerHTML=a,t.append(m),o+=`${Pe}:nth-child(${ue}n+${l}){fill:url(#p_${l});}`}let s=document.createElement("style");s.innerHTML=o,n.append(s),r.append(t),fe=!0}function ce(e){let n=e.element.querySelector("g.constellation-labels"),r=Array.from(n.querySelectorAll("text")),t=null,o,s,l,a=0;for(let i=0;i<e.constellations.length;i++)o=e.constellations[i],o.name&&(l=p(o.label.ra,o.label.dec,e),l!==null&&(s=r[a++],s||(t||(t=document.createDocumentFragment()),s=document.createElementNS(d,"text"),t.appendChild(s)),s.setAttribute("x",l[0].toFixed(3)),s.setAttribute("y",l[1].toFixed(3)),s.textContent=o.name));t&&n.appendChild(t);for(let i=a;i<r.length;i++)r[i].remove()}function he(e){let n=e.element.querySelector("g.hint-lines"),r=Array.from(n.querySelectorAll("path")),t=null,o,s,l,a,i=0;for(let m=0;m<e.hintLines.length;m++){o=e.hintLines[m],s="";for(let u of o)a=p(u[0],u[1],e,1),a!==null&&(s+=`${s?" L":"M"}${a[0]},${a[1]}`);s&&(l=r[i++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(d,"path"),t.appendChild(l)),l.setAttribute("d",s))}t&&n.appendChild(t);for(let m=i;m<r.length;m++)r[m].remove()}function $(e){ne(e),te(e),ie(e),le(e),de(e),ce(e),he(e)}var ge="stars.",w={read(e){try{let n=localStorage.getItem(`${ge}${e}`);return n===null?null:JSON.parse(n)}catch{return null}},write(e,n){try{localStorage.setItem(`${ge}${e}`,JSON.stringify(n))}catch{}}};function T(e,n=0,r=2*Math.PI,t){for(;e<n;)e+=r-n;if(t)for(;e>r;)e-=r-n;else for(;e>=r;)e-=r-n;return e}var{PI:be,asin:ye}=Math,M=!1;function Ce(e,n,r){let{tilt:t}=e,{r:o}=h(e),s=ye(n/o),l=ye(r/o),a=t[0]+s,i=t[1]+l;t[0]=T(a),i>=-be/2&&i<=be/2&&(t[1]=i),M||(requestAnimationFrame(()=>{$(e),w.write("tilt",t),M=!1}),M=!0)}function Te(e){let{element:n}=e,r=null,t=null;n.addEventListener("mousedown",o=>{r=o.offsetX,t=o.offsetY,M=!1}),n.addEventListener("mouseup",()=>{r=null,t=null,M=!1}),n.addEventListener("mousemove",o=>{r!==null&&t!==null&&(Ce(e,o.offsetX-r,o.offsetY-t),r=o.offsetX,t=o.offsetY)})}function ke(e){let{element:n}=e,r=null,t=null;n.addEventListener("touchstart",o=>{r=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY,M=!1,R()}),n.addEventListener("touchend",()=>{r=null,t=null,M=!1}),n.addEventListener("touchmove",o=>{r!==null&&t!==null&&(Ce(e,o.changedTouches[0].pageX-r,o.changedTouches[0].pageY-t),r=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY)})}function xe(e){Te(e),ke(e)}var{sin:I,cos:_,asin:ve,atan2:qe,sqrt:Ke,PI:Se}=Math;function $e(e,n,r){let{tilt:[t,o]}=r,{r:s,x0:l,y0:a}=h(r),i=e-l,m=a-n,u=s*s-i*i-m*m;if(u<0)return null;let f=Ke(u),c=i,g=m*_(-o)-f*I(-o),L=m*I(-o)+f*_(-o),x=c*_(-t)+L*I(-t),E=g,b=-c*I(-t)+L*_(-t),y=T(qe(b,x)),k=T(ve(E/s),-Se/2,Se/2,!0);return[y,k]}var Y=240;function we(e,n,r,t){let{width:o,height:s}=h(t),l=document.querySelector("#screenmenu");if(l||(l=document.createElement("div"),l.id="screenmenu",t.element.parentElement?.appendChild(l)),r.length===0){l.classList.add("hidden");return}let a=document.createElement("ul");for(let c of r){let g=document.createElement("li");g.textContent=c.name??`#${c.id}`,a.appendChild(g)}l.innerHTML="",l.style.width="",l.appendChild(a),l.classList.remove("hidden");let{width:i,height:m}=l.getBoundingClientRect();i>Y?(l.style.width=`${Y}px`,l.classList.add("wide"),i=Y):l.classList.remove("wide");let u=Math.min(e+4,o-i-6),f=Math.min(n+4,s-m-6);l.style.setProperty("--x",`${u}px`),l.style.setProperty("--y",`${f}px`)}var{abs:Me}=Math,Le=5;function He(e,n){return e.magnitude-n.magnitude}function Ee(e){document.addEventListener("click",n=>{if(!e.element.contains(n.target))return;let{left:r,top:t}=e.element.getBoundingClientRect(),o=n.offsetX-r,s=n.offsetY-t,l=$e(o,s,e);if(console.log("click",l),l===null)return;let a=[];for(let i of e.stars){let m=p(i.ra,i.dec,e);m!==null&&Me(m[0]-o)<=Le&&Me(m[1]-s)<=Le&&a.push(i)}a.sort(He);for(let i of a)console.log(`#${i.id}; ${i.name}`,i.magnitude),window.sendEvent?.(["click star",i.name??`#${i.id}`]);we(o,s,a,e)})}function Ae(e){let n=document.querySelector("#screen form");for(let r of n.querySelectorAll('[name="mode"]'))r.checked=r.value===e.mode;n.addEventListener("change",r=>{let t=r.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let o=t.value;document.documentElement.dataset.mode=o,e.mode=o,$(e),w.write("mode",o),window.sendEvent?.(["set mode",o])}})}function O({element:e}){let n=e.parentElement;if(!n)return;e.setAttribute("style","display: none");let{width:r,height:t}=n.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${r} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}async function Re(){let e=document.querySelector("#screen svg"),n=await U(),r=w.read("mode")??document.documentElement.dataset.mode,t={...n,element:e,tilt:w.read("tilt")??[1.2,1.25],mode:r};document.documentElement.dataset.mode!==r&&(document.documentElement.dataset.mode=r);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{R(),O(t),$(t)})}),O(t),Ae(t),$(t),xe(t),Ee(t),window.sendEvent?.(["load mode",r])}Re();})();
