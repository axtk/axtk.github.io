"use strict";(()=>{var P="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",M={stars:`${P}/stars_m6.json`,constellationLabels:`${P}/constellation_labels.json`,constellationNames:`${P}/constellation_names.json`,constellationLines:`${P}/constellation_lines.json`},f="http://www.w3.org/2000/svg",V={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},H=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];var k=class{ra;dec;magnitude;id;spectralClass;originalName;_name;_bayerKey;constructor(o){[this.ra,this.dec,this.magnitude,this.id,this.spectralClass,this.originalName]=o}get name(){return this._updateNames(),this._name??void 0}get bayerKey(){return this._updateNames(),this._bayerKey??void 0}_updateNames(){if(this._name!==void 0)return;if(!this.originalName){this._name=null,this._bayerKey=null;return}let o=this.originalName.indexOf(","),r=o===-1?null:this.originalName.slice(0,o).trim(),n=(o===-1?this.originalName:this.originalName.slice(o+1).trim()).match(/^(\S+)\s+(.*)$/);if(!n||n.length<2){this._name=this.originalName,this._bayerKey=null;return}let[,i,l]=n;if(n=i.match(/^([^\d]+)(\d+)?$/),!n||n.length<2){this._name=this.originalName,this._bayerKey=i;return}let[,s,a]=n;this._bayerKey=V[s]??s,a&&(this._bayerKey+=H[Number(a)]??a),this._name=`${r?`${r}, `:""}${this._bayerKey} ${l}`}};var q=class{ra;dec;name;constructor(o){[this.ra,this.dec,this.name]=o}};function Ce(e){let o={};for(let r of e){let t=r.originalName?.split(", ").at(-1)||`#${r.id}`;o[t]=[r.ra,r.dec]}return o}function O(e,o){let r=Ce(o),t=[];for(let[n,i]of Object.entries(e))for(let l of i){let s=[];for(let a of l){let m;a.includes(" #")||a.startsWith("#")?m=a.split(" ").at(-1):!a.includes(" ")&&n!=="_"?m=`${a} ${n}`:m=a,m&&r[m]&&s.push(r[m])}s.length!==0&&t.push(s)}return t}async function J(){let[e,o,r,t]=await Promise.all([M.stars,M.constellationLabels,M.constellationNames,M.constellationLines].map(s=>fetch(s).then(a=>a.json()))),n=e.map(s=>new k(s)),i=o.map(s=>new q(s)),l=O(t,n);return{stars:n,constellationLabels:i,constellationNames:r,constellationLines:l}}var T=null,W="";function c({element:e}){let o=e.getAttribute("data-size");if(o===W&&T!==null)return T;let r=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return T={width:r,height:t,r:Math.sqrt(r*r+t*t)/1.65,x0:r/2,y0:t/2},W=o,T}function K(){document.querySelector("#screenmenu")?.classList.add("hidden")}var{sin:A,cos:S}=Math;function d(e,o,r,t=.25){let{tilt:[n,i]}=r,{width:l,height:s,x0:a,y0:m,r:u}=c(r),p=u*S(o)*S(e),g=u*A(o),b=u*S(o)*A(e),v=p*S(n)+b*A(n),D=g,R=-p*A(n)+b*S(n),y=v,C=D*S(i)-R*A(i),_=D*A(i)+R*S(i);return y=a+y,C=m-C,_<0||y<-t*l||y>(1+t)*l||C<-t*s||C>(1+t)*s?null:[y,C,_]}var{PI:h}=Math,z=h/100,N=h/12,Q=h/50;function U(e){let o=e.element.querySelector("g.grid"),r=o.querySelector("path");r||(r=document.createElementNS(f,"path"),o.appendChild(r));let t,n="",i="";for(let l=-h/2+N;l<=h/2-N+z;l+=N){let s="",a=!1;for(let m=0;m<=2*h+z;m+=Q){if(t=d(m,l,e,.5),i=s&&!a?" L":"M",t===null){a=!0;continue}a&&(a=!1),s+=`${i}${t[0].toFixed(3)},${t[1].toFixed(3)}`}n+=`${n?" ":""}${s}`}for(let l=0;l<=2*h-N+z;l+=N){let s="",a=!1;for(let m=-h/2;m<=h/2+z;m+=Q){if(t=d(l,m,e,.5),i=s&&!a?" L":"M",t===null){a=!0;continue}a&&(a=!1),s+=`${i}${t[0].toFixed(3)},${t[1].toFixed(3)}`}n+=`${n?" ":""}${s}`}r.setAttribute("d",n)}function E(e,o){return o.mode==="fantasy"?2*(6.75-e.magnitude):.5*(6.75-e.magnitude)}var{floor:X,random:x,sin:Z,cos:ee,PI:te}=Math;function Se(){return`#${["","",""].map(()=>X(50+120*x()).toString(16)).join("")}`}var xe=30,I=[];function Le(){if(I.length===xe)return I[X(x()*I.length)];let e="",o=Array.from({length:2}).map(()=>Se());for(let r=0;r<2;r++)for(let t=.25*r;t<5;t++){let n=2*te*x(),i=5+t*ee(n),l=5+t*Z(n),s=n+te*(.5+.5*x()),a=5+t*ee(s),m=5+t*Z(s),u=o[X(x()*o.length)];e+=`<path d="M${i} ${l} A ${t} ${t} 0 1 0 ${a} ${m}" stroke="${u}" stroke-width="${(.75+x()).toFixed(3)}" stroke-opacity="${(.35+.55*x()).toFixed(3)}"/>`}return I.push(e),e}function ne(e){let o=e.element.querySelector("g.stars"),r=Array.from(o.querySelectorAll("svg")),t=null;for(let u of o.querySelectorAll("circle"))u.remove();let n,i,l,s,a,m=0;for(let u=0;u<e.stars.length;u++)n=e.stars[u],l=d(n.ra,n.dec,e),l!==null&&(i=r[m++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(f,"svg"),i.setAttribute("viewBox","0 0 10 10"),i.innerHTML=Le(),t.appendChild(i)),s=E(n,e),a=(2*s).toFixed(3),i.setAttribute("x",(l[0]-s).toFixed(3)),i.setAttribute("y",(l[1]-s).toFixed(3)),i.setAttribute("width",a),i.setAttribute("height",a),i.setAttribute("data-spcl",n.spectralClass));t&&o.appendChild(t);for(let u=m;u<r.length;u++)r[u].remove()}function re(e){if(e.mode==="fantasy")return ne(e);let o=e.element.querySelector("g.stars"),r=Array.from(o.querySelectorAll("circle")),t=null;for(let a of o.querySelectorAll("svg"))a.remove();let n,i,l,s=0;for(let a=0;a<e.stars.length;a++)n=e.stars[a],l=d(n.ra,n.dec,e),l!==null&&(i=r[s++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(f,"circle"),t.appendChild(i)),i.setAttribute("cx",l[0].toFixed(3)),i.setAttribute("cy",l[1].toFixed(3)),i.setAttribute("r",E(n,e).toFixed(3)),i.setAttribute("data-spcl",n.spectralClass));t&&o.appendChild(t);for(let a=s;a<r.length;a++)r[a].remove()}function oe(e){let{r:o}=c(e),r=o<640?3:4,t=e.element.querySelector("g.star-labels"),n=Array.from(t.querySelectorAll("text")),i=null,l,s,a,m=0;for(let u=0;u<e.stars.length;u++){if(l=e.stars[u],!l.bayerKey||l.magnitude>r||(a=d(l.ra,l.dec,e),a===null))continue;s=n[m++],s||(i||(i=document.createDocumentFragment()),s=document.createElementNS(f,"text"),i.appendChild(s));let p=E(l,e);s.setAttribute("x",(a[0]+p+2).toFixed(3)),s.setAttribute("y",(a[1]+2).toFixed(3)),s.textContent=l.bayerKey}i&&t.appendChild(i);for(let u=m;u<n.length;u++)n[u].remove()}function we(e,o){if(e.name)return o.constellationNames[e.name]??e.name}function ie(e){let o=e.element.querySelector("g.constellation-labels"),r=Array.from(o.querySelectorAll("text")),t=null,n,i,l,s,a=0;for(let m=0;m<e.constellationLabels.length;m++)n=e.constellationLabels[m],i=we(n,e),i&&(s=d(n.ra,n.dec,e),s!==null&&(l=r[a++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(f,"text"),t.appendChild(l)),l.setAttribute("x",s[0].toFixed(3)),l.setAttribute("y",s[1].toFixed(3)),l.textContent=i));t&&o.appendChild(t);for(let m=a;m<r.length;m++)r[m].remove()}function le(e){let o=e.element.querySelector("g.constellation-lines"),r=Array.from(o.querySelectorAll("path")),t=null,n,i,l,s,a=0;for(let m=0;m<e.constellationLines.length;m++){n=e.constellationLines[m],i="";for(let u of n)s=d(u[0],u[1],e,1),s!==null&&(i+=`${i?" L":"M"}${s[0]},${s[1]}`);i&&(l=r[a++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(f,"path"),t.appendChild(l)),l.setAttribute("d",i))}t&&o.appendChild(t);for(let m=a;m<r.length;m++)r[m].remove()}function L(e){U(e),re(e),oe(e),ie(e),le(e)}var ae="stars.",w={read(e){try{let o=localStorage.getItem(`${ae}${e}`);return o===null?null:JSON.parse(o)}catch{return null}},write(e,o){try{localStorage.setItem(`${ae}${e}`,JSON.stringify(o))}catch{}}};function F(e,o=0,r=2*Math.PI,t){for(;e<o;)e+=r-o;if(t)for(;e>r;)e-=r-o;else for(;e>=r;)e-=r-o;return e}var{PI:se,asin:me}=Math,$=!1;function ue(e,o,r){let{tilt:t}=e,{r:n}=c(e),i=me(o/n),l=me(r/n),s=t[0]+i,a=t[1]+l;t[0]=F(s),a>=-se/2&&a<=se/2&&(t[1]=a),$||(requestAnimationFrame(()=>{L(e),w.write("tilt",t),$=!1}),$=!0)}function $e(e){let{element:o}=e,r=null,t=null;o.addEventListener("mousedown",n=>{r=n.offsetX,t=n.offsetY,$=!1}),o.addEventListener("mouseup",()=>{r=null,t=null,$=!1}),o.addEventListener("mousemove",n=>{r!==null&&t!==null&&(ue(e,n.offsetX-r,n.offsetY-t),r=n.offsetX,t=n.offsetY)})}function Ae(e){let{element:o}=e,r=null,t=null;o.addEventListener("touchstart",n=>{r=n.changedTouches[0].pageX,t=n.changedTouches[0].pageY,$=!1,K()}),o.addEventListener("touchend",()=>{r=null,t=null,$=!1}),o.addEventListener("touchmove",n=>{r!==null&&t!==null&&(ue(e,n.changedTouches[0].pageX-r,n.changedTouches[0].pageY-t),r=n.changedTouches[0].pageX,t=n.changedTouches[0].pageY)})}function de(e){$e(e),Ae(e)}var{sin:B,cos:G,asin:Ee,atan2:Me,sqrt:Ne,PI:fe}=Math;function ce(e,o,r){let{tilt:[t,n]}=r,{r:i,x0:l,y0:s}=c(r),a=e-l,m=s-o,u=i*i-a*a-m*m;if(u<0)return null;let p=Ne(u),g=a,b=m*G(-n)-p*B(-n),v=m*B(-n)+p*G(-n),D=g*G(-t)+v*B(-t),R=b,y=-g*B(-t)+v*G(-t),C=F(Me(y,D)),_=F(Ee(R/i),-fe/2,fe/2,!0);return[C,_]}var Y=240;function pe(e,o,r,t){let{width:n,height:i}=c(t),l=document.querySelector("#screenmenu");if(l||(l=document.createElement("div"),l.id="screenmenu",t.element.parentElement?.appendChild(l)),r.length===0){l.classList.add("hidden");return}let s=document.createElement("ul");for(let g of r){let b=document.createElement("li");b.textContent=g.name??`#${g.id}`,s.appendChild(b)}l.innerHTML="",l.style.width="",l.appendChild(s),l.classList.remove("hidden");let{width:a,height:m}=l.getBoundingClientRect();a>Y?(l.style.width=`${Y}px`,l.classList.add("wide"),a=Y):l.classList.remove("wide");let u=Math.min(e+4,n-a-6),p=Math.min(o+4,i-m-6);l.style.setProperty("--x",`${u}px`),l.style.setProperty("--y",`${p}px`)}var{abs:he}=Math,ge=5;function Fe(e,o){return e.magnitude-o.magnitude}function be(e){document.addEventListener("click",o=>{if(!e.element.contains(o.target))return;let{left:r,top:t}=e.element.getBoundingClientRect(),n=o.offsetX-r,i=o.offsetY-t,l=ce(n,i,e);if(console.log("click",l),l===null)return;let s=[];for(let a of e.stars){let m=d(a.ra,a.dec,e);m!==null&&he(m[0]-n)<=ge&&he(m[1]-i)<=ge&&s.push(a)}s.sort(Fe);for(let a of s)console.log(`#${a.id}; ${a.name}`,a.magnitude),window.sendEvent?.(["click star",a.name??`#${a.id}`]);pe(n,i,s,e)})}function ye(e){let o=document.querySelector("#screen form");for(let r of o.querySelectorAll('[name="mode"]'))r.checked=r.value===e.mode;o.addEventListener("change",r=>{let t=r.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let n=e.mode,i=t.value;document.documentElement.dataset.mode=i,e.mode=i,(i==="fantasy"||n==="fantasy")&&L(e),w.write("mode",i),window.sendEvent?.(["set mode",i])}})}function j({element:e}){let o=e.parentElement;if(!o)return;e.setAttribute("style","display: none");let{width:r,height:t}=o.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${r} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}async function ve(){let e=document.querySelector("#screen svg"),o=await J(),r=w.read("mode")??document.documentElement.dataset.mode,t={...o,element:e,tilt:w.read("tilt")??[-.12,0],mode:r};document.documentElement.dataset.mode!==r&&(document.documentElement.dataset.mode=r);let n=null;window.addEventListener("resize",()=>{n!==null&&cancelAnimationFrame(n),n=requestAnimationFrame(()=>{K(),j(t),L(t)})}),j(t),ye(t),L(t),de(t),be(t)}ve();})();
