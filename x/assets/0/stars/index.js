"use strict";(()=>{var X="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",k={stars:`${X}/stars_m6_bsc5.csv`,constellations:`${X}/constellations.csv`,hintLines:`${X}/constellation_lines.csv`},p="http://www.w3.org/2000/svg",G={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},W=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"],J={O:"#c0ffff",B:"#c0ffff",A:"#ffffff",F:"#ffffff",G:"#f9f9d8",K:"#ffe0c0",M:"#f9cdcd"};var q=class{abbr;name;label;constructor({abbr:t,name:n,label:r}){this.abbr=t,this.name=n,this.label=r}};function $(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function U(e){return e.trim().split(/\r?\n/).slice(1).map(t=>{let[n,r,o,i]=t.split(",");return new q({abbr:n,name:$(i),label:{ra:Number(r),dec:Number(o)}})})}function L(e){let t=e?.match(/^([^\d]+)(\d+)?$/);if(!t)return e;let[,n="",r=""]=t;return G[n]&&(n=G[n]),r&&(r=W[Number(r)]??r),`${n}${r}`}function ke(e){let t={};for(let n of e){let r=n.bayerName||`#${n.id}`;t[r]=n}return t}function O(e){return e?[e.ra,e.dec]:null}function qe(e,t){return e.magnitude-t.magnitude}var Re=[1,2,3],He=["A","B"];function ze(e,t,n){let r=[];for(let i of Re){let l=n[`${L(`${e}${i}`)} ${t}`];l&&r.push(l)}let o=L(e);for(let i of He){let l=n[`${o} ${t} ${i}`];l&&r.push(l)}return r.sort(qe)[0]}function Z(e,t){let n=ke(t);return e.trim().split(/\r?\n/).slice(1).map(r=>{let o=r.split(","),i=[],l=o[0],a=$(o[1]).split(" ");for(let s of a){let m=null;if(s.includes("=")&&(m=O(n[`#${s.split("=").at(-1)}`])),m){i.push(m);continue}let u="",f="";if(s.includes("_")){let d=s.indexOf("_");u=s.slice(0,d),f=s.slice(d+1).replace(/_/g," ")}else u=s,f=l;u&&f&&(m=O(n[`${L(u)} ${f}`]),m||(m=O(ze(u,f,n)))),m&&i.push(m)}return i})}var R=class{ra;dec;magnitude;id;spectralClass;bayerKey;bayerName;properName;constructor({ra:t,dec:n,magnitude:r,id:o,spectralClass:i,bayerName:l,properName:a}){if(this.ra=t,this.dec=n,this.magnitude=r,this.id=o,this.spectralClass=i,this.properName=a,l){let[s,...m]=l.split(" "),u=L(s);this.bayerKey=u,this.bayerName=u?`${u}${m.length===0?"":` ${m.join(" ")}`}`:void 0}}get name(){let{bayerName:t}=this;if(t!==void 0)return this.properName?`${this.properName}, ${t}`:t}};function Be(e,t){return e.magnitude-t.magnitude}function ee(e){return e.trim().split(/\r?\n/).slice(1).map(t=>{let[n,r,o,i,l,a,s]=t.split(",");return new R({ra:Number(n),dec:Number(r),magnitude:Number(o),id:l,spectralClass:i,bayerName:$(a),properName:$(s)})}).sort(Be)}async function Ie(e){return fetch(e).then(t=>t.text())}async function te(){let[e,t,n]=await Promise.all([k.stars,k.constellations,k.hintLines].map(Ie)),r=ee(e),o=U(t),i=Z(n,r);return{stars:r,constellations:o,hintLines:i}}function H(){document.querySelector("#screenmenu")?.classList.add("hidden")}var z=null,re="";function g({element:e}){let t=e.getAttribute("data-size");if(t===re&&z!==null)return z;let n=Number(e.getAttribute("width")),r=Number(e.getAttribute("height"));return z={width:n,height:r,r:.65*Math.sqrt(n*n+r*r),x0:n/2,y0:r/2},re=t,z}function D(e,t=0,n=2*Math.PI,r){for(;e<t;)e+=n-t;if(r)for(;e>n;)e-=n-t;else for(;e>=n;)e-=n-t;return e}var{sin:B,cos:I,asin:Ke,atan2:Ye,sqrt:_e,PI:ne}=Math;function oe(e,t,n){let{tilt:[r,o]}=n,{r:i,x0:l,y0:a}=g(n),s=e-l,m=a-t,u=i*i-s*s-m*m;if(u<0)return null;let f=_e(u),d=s,x=m*I(-o)-f*B(-o),b=m*B(-o)+f*I(-o),h=d*I(-r)+b*B(-r),M=x,y=-d*B(-r)+b*I(-r),S=D(Ye(y,h)),T=D(Ke(M/i),-ne/2,ne/2,!0);return[S,T]}var{sin:A,cos:w}=Math;function c(e,t,n,r=.25){let{tilt:[o,i]}=n,{width:l,height:a,x0:s,y0:m,r:u}=g(n),f=u*w(t)*w(e),d=u*A(t),x=u*w(t)*A(e),b=f*w(o)+x*A(o),h=d,M=-f*A(o)+x*w(o),y=b,S=h*w(i)-M*A(i),T=h*A(i)+M*w(i);return y=s+y,S=m-S,T<0||y<-r*l||y>(1+r)*l||S<-r*a||S>(1+r)*a?null:[y,S,T]}function j(e,t){let n=document.createElement("td");return n.className=`${t?"":"x "}${e}`,n.textContent=t||"\u2022",n}function ie(e){let t=document.createDocumentFragment(),n=document.createElement("table"),r=e.some(({properName:o})=>!!o);for(let o of e){let i=document.createElement("tr");r&&i.append(j("n",o.properName)),i.append(j("b",o.bayerName||`HD ${o.id}`)),i.append(j("m",`${o.magnitude}\u1D50`)),n.append(i)}return t.append(n),t}var V=240;function le(e,t,n,r){let{width:o,height:i}=g(r),l=document.querySelector("#screenmenu");if(l||(l=document.createElement("div"),l.id="screenmenu",r.element.parentElement?.appendChild(l)),n.children.length===0){l.classList.add("hidden");return}l.innerHTML="",l.style.width="",l.append(n),l.classList.remove("hidden");let{width:a,height:s}=l.getBoundingClientRect();a>V?(l.style.width=`${V}px`,l.classList.add("wide"),a=V):l.classList.remove("wide");let m=Math.min(e+4,o-a-6),u=Math.min(t+4,i-s-6);l.style.setProperty("--x",`${m}px`),l.style.setProperty("--y",`${u}px`)}var{abs:se}=Math,me=5;function Xe(e,t){return e.magnitude-t.magnitude}function ae(e){document.addEventListener("click",t=>{if(!e.element.contains(t.target))return;let{left:n,top:r}=e.element.getBoundingClientRect(),o=t.offsetX-n,i=t.offsetY-r;if(oe(o,i,e)===null)return;let a=[];for(let s of e.stars){let m=c(s.ra,s.dec,e);m!==null&&se(m[0]-o)<=me&&se(m[1]-i)<=me&&a.push(s)}a.sort(Xe);for(let s of a)window.sendEvent?.(["click star",s.name??`#${s.id}`]);le(o,i,ie(a),e)})}function ue(e){let t=e.element.querySelector("g.constellation-labels"),n=Array.from(t.querySelectorAll("text")),r=null,o,i,l,a=0;for(let s=0;s<e.constellations.length;s++)o=e.constellations[s],o.name&&(l=c(o.label.ra,o.label.dec,e),l!==null&&(i=n[a++],i||(r||(r=document.createDocumentFragment()),i=document.createElementNS(p,"text"),r.appendChild(i)),i.setAttribute("x",l[0].toFixed(3)),i.setAttribute("y",l[1].toFixed(3)),i.textContent=o.name));r&&t.appendChild(r);for(let s=a;s<n.length;s++)n[s].remove()}var{PI:C}=Math,K=C/100,F=C/12,fe=C/50;function de(e){let t=e.element.querySelector("g.grid"),n=t.querySelector("path");n||(n=document.createElementNS(p,"path"),t.appendChild(n));let r,o="",i="";for(let l=-C/2+F;l<=C/2-F+K;l+=F){let a="",s=!1;for(let m=0;m<=2*C+K;m+=fe){if(r=c(m,l,e,.5),i=a&&!s?" L":"M",r===null){s=!0;continue}s&&(s=!1),a+=`${i}${r[0].toFixed(3)},${r[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}for(let l=0;l<=2*C-F+K;l+=F){let a="",s=!1;for(let m=-C/2;m<=C/2+K;m+=fe){if(r=c(l,m,e,.5),i=a&&!s?" L":"M",r===null){s=!0;continue}s&&(s=!1),a+=`${i}${r[0].toFixed(3)},${r[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}n.setAttribute("d",o)}function ce(e){let t=e.element.querySelector("g.hint-lines"),n=Array.from(t.querySelectorAll("path")),r=null,o,i,l,a,s=0;for(let m=0;m<e.hintLines.length;m++){o=e.hintLines[m],i="";for(let u of o)a=c(u[0],u[1],e,1),a!==null&&(i+=`${i?" L":"M"}${a[0]},${a[1]}`);i&&(l=n[s++],l||(r||(r=document.createDocumentFragment()),l=document.createElementNS(p,"path"),r.appendChild(l)),l.setAttribute("d",i))}r&&t.appendChild(r);for(let m=s;m<n.length;m++)n[m].remove()}var pe=!1,he='html[data-mode="dark"] #screen .stars circle';function ge(e){if(e.mode!=="dark"||pe)return;let t=e.element.parentElement,n=t.querySelector("defs"),r=n?.querySelector("#spcl")?.outerHTML;if(!n||!r)return;let o=document.createElement("style"),i="",l="",a="";l+=`${he}:not([r^="0."]){fill:url(#spcl);}`;for(let[s,m]of Object.entries(J)){let u=`${he}[data-spcl^="${s}"]`;i+=`${u}[r^="0."]{fill:${m};}`,l+=`${u}:not([r^="0."]){fill:url(#spcl_${s});}`,a+=`
${r}`.replace('id="spcl"',`id="spcl_${s}"`).replaceAll("currentColor",m)}n.innerHTML+=a,o.innerHTML=i,o.innerHTML=l,t.prepend(o),pe=!0}function Y(e,t){return t.mode==="fantasy"?2*(6.75-e.magnitude):t.mode==="light"?.6*(6.75-e.magnitude):.7*(6.75-e.magnitude)}var{floor:be,max:Ge}=Math,_=class{grid={};cellSizeX;cellSizeY;constructor(t=50,n){this.cellSizeX=t,this.cellSizeY=n??t}push(t,n,r){let o=`${be(n/this.cellSizeX)},${be(r/this.cellSizeY)}`;this.grid[o]||(this.grid[o]=[]),this.grid[o].push(t)}_getNeightborCellIndices(t){let[n,r]=t.split(",").map(Number),o=[];for(let i=-1;i<=1;i++)for(let l=-1;l<=1;l++){let a=this.grid[`${n+i},${r+l}`];a&&o.push(...a)}return o}resolve(t){let n=new Set;for(let r of Object.keys(this.grid)){let o=this._getNeightborCellIndices(r);if(!(o.length<2))for(let i of o)for(let l of o){if(i===l||n.has(i)||n.has(l)||!t[i]||!t[l])continue;let a=t[i].getBoundingClientRect(),s=t[l].getBoundingClientRect();a.left<s.right&&a.right>s.left&&a.top<s.bottom&&a.bottom>s.top&&n.add(Ge(i,l))}}return n}};function ye(e){let{r:t}=g(e),n=t<640?3:4,r=e.element.querySelector("g.star-labels"),o=Array.from(r.querySelectorAll("text")),i=null,l,a,s,m=0,u=new _;for(let d=0;d<e.stars.length;d++){if(l=e.stars[d],!l.bayerKey)continue;if(l.magnitude>n)break;if(s=c(l.ra,l.dec,e),s===null)continue;a=o[m],a||(i||(i=document.createDocumentFragment()),a=document.createElementNS(p,"text"),i.appendChild(a),o.push(a));let x=Y(l,e),b=s[0]+x+2,h=s[1]+2;u.push(m,b,h),a.setAttribute("x",b.toFixed(3)),a.setAttribute("y",h.toFixed(3)),a.textContent=l.bayerKey,m++}i&&r.appendChild(i);let f=u.resolve(o);for(let d=m;d<o.length;d++)o[d].remove();for(let d of f)o[d]?.remove()}var{floor:ve,random:N,sin:Se,cos:Ce,PI:xe}=Math;function Oe(){return`#${["","",""].map(()=>ve(50+120*N()).toString(16)).join("")}`}var $e=30,we=!1,je='html[data-mode="fantasy"] #screen .stars circle';function Ee(e){if(e.mode!=="fantasy"||we)return;let t=e.element.parentElement,n=t.querySelector("defs");if(!n)return;let r=document.createDocumentFragment(),o="";for(let l=0;l<$e;l++){let a="",s=Array.from({length:2}).map(()=>Oe());for(let u=0;u<2;u++)for(let f=.25*u;f<5;f++){let d=2*xe*N(),x=5+f*Ce(d),b=5+f*Se(d),h=d+xe*(.5+.5*N()),M=5+f*Ce(h),y=5+f*Se(h),S=s[ve(N()*s.length)];a+=`<path d="M${x} ${b} A ${f} ${f} 0 1 0 ${M} ${y}" class="p" stroke="${S}" stroke-width="${(.75+N()).toFixed(3)}" stroke-opacity="${(.35+.55*N()).toFixed(3)}"/>`}let m=document.createElementNS(p,"pattern");m.setAttribute("id",`p_${l}`),m.setAttribute("viewBox","0 0 10 10"),m.setAttribute("width","100%"),m.setAttribute("height","100%"),m.innerHTML=a,r.append(m),o+=`${je}:nth-child(${$e}n+${l}){fill:url(#p_${l});}`}let i=document.createElement("style");i.innerHTML=o,t.append(i),n.append(r),we=!0}function Me(e,t){return t.mode==="fantasy"?Math.min(.5+.2*(6.75-e.magnitude),1):Math.min(.2+.15*(6.75-e.magnitude),1)}function Le(e){let t=e.element.querySelector("g.stars"),n=Array.from(t.querySelectorAll("circle")),r=null,o,i,l,a=0,s=e.moving?.5:.1;for(let m=0;m<e.stars.length;m++){if(o=e.stars[m],l=c(o.ra,o.dec,e),l===null)continue;let u=Y(o,e);u<s||(i=n[a++],i||(r||(r=document.createDocumentFragment()),i=document.createElementNS(p,"circle"),r.appendChild(i)),i.setAttribute("cx",l[0].toFixed(3)),i.setAttribute("cy",l[1].toFixed(3)),i.setAttribute("r",u.toFixed(2)),i.setAttribute("fill-opacity",Me(o,e).toFixed(2)),i.setAttribute("data-spcl",o.spectralClass??""))}r&&t.appendChild(r);for(let m=a;m<n.length;m++)n[m].remove()}function v(e){e.element.dataset.moving=String(e.moving??""),de(e),ge(e),Le(e),ye(e),Ee(e),ue(e),ce(e)}var Ae="stars.",E={read(e){try{let t=localStorage.getItem(`${Ae}${e}`);return t===null?null:JSON.parse(t)}catch{return null}},write(e,t){try{localStorage.setItem(`${Ae}${e}`,JSON.stringify(t))}catch{}}};var{PI:Ne,asin:De}=Math,P=!1;function Fe(e,t,n){if(P)return;P=!0;let{tilt:r}=e,{r:o}=g(e),i=De(t/o),l=De(n/o),a=r[0]+i,s=r[1]+l;r[0]=D(a),s>=-Ne/2&&s<=Ne/2&&(r[1]=s),requestAnimationFrame(()=>{v(e),E.write("tilt",r),P=!1})}function Pe(e){let{element:t}=e,n=null,r=null,o=Date.now();function i(u,f){H(),n=u,r=f,P=!1}function l(u,f){P=!1,e.moving=!1,n!==null&&r!==null&&Fe(e,u-n,f-r),n=null,r=null}function a(u,f){let d=Date.now();n===null||r===null||d-o<20||(e.moving||(e.moving=!0),Fe(e,u-n,f-r),n=u,r=f,o=d)}let s=null,m=null;t.addEventListener("mousedown",u=>{i(u.offsetX,u.offsetY),!s&&!m&&(s=f=>{f.preventDefault(),a(f.offsetX,f.offsetY)},t.addEventListener("mousemove",s))}),t.addEventListener("mouseup",u=>{l(u.offsetX,u.offsetY),s&&(t.removeEventListener("mousemove",s),s=null)}),t.addEventListener("touchstart",u=>{i(u.changedTouches[0].pageX,u.changedTouches[0].pageY),!m&&!s&&(m=f=>{f.preventDefault(),a(f.changedTouches[0].pageX,f.changedTouches[0].pageY)},t.addEventListener("touchmove",m))}),t.addEventListener("touchend",u=>{l(u.changedTouches[0].pageX,u.changedTouches[0].pageY),m&&(t.removeEventListener("touchmove",m),m=null)})}function Te(e){let t=document.querySelector("#screen form");for(let n of t.querySelectorAll('[name="mode"]'))n.checked=n.value===e.mode;t.addEventListener("change",n=>{let r=n.target;if(r instanceof HTMLInputElement&&r.name==="mode"){let o=r.value;document.documentElement.dataset.mode=o,e.mode=o,v(e),E.write("mode",o),window.sendEvent?.(["set mode",o])}})}function Q({element:e}){let t=e.parentElement;if(!t)return;e.setAttribute("style","display: none");let{width:n,height:r}=t.getBoundingClientRect();e.setAttribute("width",String(n)),e.setAttribute("height",String(r)),e.setAttribute("viewBox",`0 0 ${n} ${r}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}var Ve=[1.7,1.05];async function Qe(){let e=document.querySelector("#screen svg"),t=await te(),n=document.documentElement.dataset.mode||E.read("mode"),r={...t,element:e,tilt:E.read("tilt")??Ve,mode:n};document.documentElement.dataset.mode!==n&&(document.documentElement.dataset.mode=n);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{H(),Q(r),v(r)})}),Q(r),Te(r),v(r),Pe(r),ae(r),window.sendEvent?.(["load mode",n])}Qe();})();
