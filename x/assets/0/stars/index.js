"use strict";(()=>{var G="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",v={stars:`${G}/stars_m6_bsc5.csv`,constellations:`${G}/constellations.csv`,hintLines:`${G}/constellation_lines.csv`},d="http://www.w3.org/2000/svg",X={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},Q=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"],j={O:"#c0ffff",B:"#c0ffff",A:"#ffffff",F:"#ffffff",G:"#f9f9d8",K:"#ffe0c0",M:"#f9cdcd"};function N(e){let n=e?.match(/^([^\d]+)(\d+)?$/);if(!n)return e;let[,r="",t=""]=n;return X[r]&&(r=X[r]),t&&(t=Q[Number(t)]??t),`${r}${t}`}var H=class{ra;dec;magnitude;id;spectralClass;bayerKey;bayerName;properName;constructor({ra:n,dec:r,magnitude:t,id:o,spectralClass:l,bayerName:i,properName:m}){if(this.ra=n,this.dec=r,this.magnitude=t,this.id=o,this.spectralClass=l,this.properName=m,i){let[a,...s]=i.split(" "),u=N(a);this.bayerKey=u,this.bayerName=u?`${u}${s.length===0?"":` ${s.join(" ")}`}`:void 0}}get name(){let{bayerName:n}=this;if(n!==void 0)return this.properName?`${this.properName}, ${n}`:n}};function x(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function W(e){return e.trim().split(/\r?\n/).slice(1).map(n=>{let[r,t,o,l,i,m,a]=n.split(",");return new H({ra:Number(r),dec:Number(t),magnitude:Number(o),id:i,spectralClass:l,bayerName:x(m),properName:x(a)})})}var q=class{abbr;name;label;constructor({abbr:n,name:r,label:t}){this.abbr=n,this.name=r,this.label=t}};function J(e){return e.trim().split(/\r?\n/).slice(1).map(n=>{let[r,t,o,l]=n.split(",");return new q({abbr:r,name:x(l),label:{ra:Number(t),dec:Number(o)}})})}function Pe(e){let n={};for(let r of e){let t=r.bayerName||`#${r.id}`;n[t]=[r.ra,r.dec,r.magnitude]}return n}function Te(e,n){return e[2]-n[2]}var ke=[1,2,3],ve=["A","B"];function He(e,n,r){let t=[];for(let l of ke){let i=r[`${N(`${e}${l}`)} ${n}`];i&&t.push(i)}let o=N(e);for(let l of ve){let i=r[`${o} ${n} ${l}`];i&&t.push(i)}return t.sort(Te)[0]}function U(e,n){let r=Pe(n);return e.trim().split(/\r?\n/).slice(1).map(t=>{let o=t.split(","),l=[],i=o[0],m=x(o[1]).split(" ");for(let a of m){let s=null;if(a.includes("=")&&(s=r[`#${a.split("=").at(-1)}`]),s){l.push([s[0],s[1]]);continue}let u="",f="";if(a.includes("_")){let c=a.indexOf("_");u=a.slice(0,c),f=a.slice(c+1).replace(/_/g," ")}else u=a,f=i;u&&f&&(s=r[`${N(u)} ${f}`],s||(s=He(u,f,r))),s&&l.push([s[0],s[1]])}return l})}async function qe(e){return fetch(e).then(n=>n.text())}async function Z(){let[e,n,r]=await Promise.all([v.stars,v.constellations,v.hintLines].map(qe)),t=W(e),o=J(n),l=U(r,t);return{stars:t,constellations:o,hintLines:l}}var R=null,ee="";function h({element:e}){let n=e.getAttribute("data-size");if(n===ee&&R!==null)return R;let r=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return R={width:r,height:t,r:.65*Math.sqrt(r*r+t*t),x0:r/2,y0:t/2},ee=n,R}function B(){document.querySelector("#screenmenu")?.classList.add("hidden")}var te=!1,re='html[data-mode="dark"] #screen .stars circle';function ne(e){if(e.mode!=="dark"||te)return;let n=e.element.parentElement,r=n.querySelector("defs"),t=r?.querySelector("#spcl")?.outerHTML;if(!r||!t)return;let o=document.createElement("style"),l="",i="",m="";i+=`${re}:not([r^="0."]){fill:url(#spcl);}`;for(let[a,s]of Object.entries(j)){let u=`${re}[data-spcl^="${a}"]`;l+=`${u}[r^="0."]{fill:${s};}`,i+=`${u}:not([r^="0."]){fill:url(#spcl_${a});}`,m+=`
${t}`.replace('id="spcl"',`id="spcl_${a}"`).replaceAll("currentColor",s)}r.innerHTML+=m,o.innerHTML=l,o.innerHTML=i,n.prepend(o),te=!0}var{sin:F,cos:C}=Math;function p(e,n,r,t=.25){let{tilt:[o,l]}=r,{width:i,height:m,x0:a,y0:s,r:u}=h(r),f=u*C(n)*C(e),c=u*F(n),E=u*C(n)*F(e),L=f*C(o)+E*F(o),S=c,A=-f*F(o)+E*C(o),g=L,b=S*C(l)-A*F(l),k=S*F(l)+A*C(l);return g=a+g,b=s-b,k<0||g<-t*i||g>(1+t)*i||b<-t*m||b>(1+t)*m?null:[g,b,k]}var{PI:y}=Math,K=y/100,P=y/12,oe=y/50;function ie(e){let n=e.element.querySelector("g.grid"),r=n.querySelector("path");r||(r=document.createElementNS(d,"path"),n.appendChild(r));let t,o="",l="";for(let i=-y/2+P;i<=y/2-P+K;i+=P){let m="",a=!1;for(let s=0;s<=2*y+K;s+=oe){if(t=p(s,i,e,.5),l=m&&!a?" L":"M",t===null){a=!0;continue}a&&(a=!1),m+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${m}`}for(let i=0;i<=2*y-P+K;i+=P){let m="",a=!1;for(let s=-y/2;s<=y/2+K;s+=oe){if(t=p(i,s,e,.5),l=m&&!a?" L":"M",t===null){a=!0;continue}a&&(a=!1),m+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${m}`}r.setAttribute("d",o)}function z(e,n){return n.mode==="fantasy"?2*(6.75-e.magnitude):n.mode==="light"?.6*(6.75-e.magnitude):.7*(6.75-e.magnitude)}function le(e,n){return n.mode==="fantasy"?Math.min(.5+.2*(6.75-e.magnitude),1):Math.min(.2+.15*(6.75-e.magnitude),1)}function ae(e){let n=e.element.querySelector("g.stars"),r=Array.from(n.querySelectorAll("circle")),t=null,o,l,i,m=0;for(let a=0;a<e.stars.length;a++)o=e.stars[a],i=p(o.ra,o.dec,e),i!==null&&(l=r[m++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(d,"circle"),t.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",z(o,e).toFixed(2)),l.setAttribute("fill-opacity",le(o,e).toFixed(2)),l.setAttribute("data-spcl",o.spectralClass??""));t&&n.appendChild(t);for(let a=m;a<r.length;a++)r[a].remove()}function se(e){let{r:n}=h(e),r=n<640?3:4,t=e.element.querySelector("g.star-labels"),o=Array.from(t.querySelectorAll("text")),l=null,i,m,a,s=0;for(let u=0;u<e.stars.length;u++){if(i=e.stars[u],!i.bayerKey||i.magnitude>r||(a=p(i.ra,i.dec,e),a===null))continue;m=o[s++],m||(l||(l=document.createDocumentFragment()),m=document.createElementNS(d,"text"),l.appendChild(m));let f=z(i,e);m.setAttribute("x",(a[0]+f+2).toFixed(3)),m.setAttribute("y",(a[1]+2).toFixed(3)),m.textContent=i.bayerKey}l&&t.appendChild(l);for(let u=s;u<o.length;u++)o[u].remove()}var{floor:ce,random:D,sin:me,cos:ue,PI:fe}=Math;function Re(){return`#${["","",""].map(()=>ce(50+120*D()).toString(16)).join("")}`}var pe=30,de=!1,Be='html[data-mode="fantasy"] #screen .stars circle';function he(e){if(e.mode!=="fantasy"||de)return;let n=e.element.parentElement,r=n.querySelector("defs");if(!r)return;let t=document.createDocumentFragment(),o="";for(let i=0;i<pe;i++){let m="",a=Array.from({length:2}).map(()=>Re());for(let u=0;u<2;u++)for(let f=.25*u;f<5;f++){let c=2*fe*D(),E=5+f*ue(c),L=5+f*me(c),S=c+fe*(.5+.5*D()),A=5+f*ue(S),g=5+f*me(S),b=a[ce(D()*a.length)];m+=`<path d="M${E} ${L} A ${f} ${f} 0 1 0 ${A} ${g}" class="p" stroke="${b}" stroke-width="${(.75+D()).toFixed(3)}" stroke-opacity="${(.35+.55*D()).toFixed(3)}"/>`}let s=document.createElementNS(d,"pattern");s.setAttribute("id",`p_${i}`),s.setAttribute("viewBox","0 0 10 10"),s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.innerHTML=m,t.append(s),o+=`${Be}:nth-child(${pe}n+${i}){fill:url(#p_${i});}`}let l=document.createElement("style");l.innerHTML=o,n.append(l),r.append(t),de=!0}function ge(e){let n=e.element.querySelector("g.constellation-labels"),r=Array.from(n.querySelectorAll("text")),t=null,o,l,i,m=0;for(let a=0;a<e.constellations.length;a++)o=e.constellations[a],o.name&&(i=p(o.label.ra,o.label.dec,e),i!==null&&(l=r[m++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(d,"text"),t.appendChild(l)),l.setAttribute("x",i[0].toFixed(3)),l.setAttribute("y",i[1].toFixed(3)),l.textContent=o.name));t&&n.appendChild(t);for(let a=m;a<r.length;a++)r[a].remove()}function be(e){let n=e.element.querySelector("g.hint-lines"),r=Array.from(n.querySelectorAll("path")),t=null,o,l,i,m,a=0;for(let s=0;s<e.hintLines.length;s++){o=e.hintLines[s],l="";for(let u of o)m=p(u[0],u[1],e,1),m!==null&&(l+=`${l?" L":"M"}${m[0]},${m[1]}`);l&&(i=r[a++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(d,"path"),t.appendChild(i)),i.setAttribute("d",l))}t&&n.appendChild(t);for(let s=a;s<r.length;s++)r[s].remove()}function $(e){ie(e),ne(e),ae(e),se(e),he(e),ge(e),be(e)}var ye="stars.",w={read(e){try{let n=localStorage.getItem(`${ye}${e}`);return n===null?null:JSON.parse(n)}catch{return null}},write(e,n){try{localStorage.setItem(`${ye}${e}`,JSON.stringify(n))}catch{}}};function T(e,n=0,r=2*Math.PI,t){for(;e<n;)e+=r-n;if(t)for(;e>r;)e-=r-n;else for(;e>=r;)e-=r-n;return e}var{PI:Se,asin:xe}=Math,M=!1;function Ce(e,n,r){let{tilt:t}=e,{r:o}=h(e),l=xe(n/o),i=xe(r/o),m=t[0]+l,a=t[1]+i;t[0]=T(m),a>=-Se/2&&a<=Se/2&&(t[1]=a),M||(requestAnimationFrame(()=>{$(e),w.write("tilt",t),M=!1}),M=!0)}function Ke(e){let{element:n}=e,r=null,t=null;n.addEventListener("mousedown",o=>{r=o.offsetX,t=o.offsetY,M=!1}),n.addEventListener("mouseup",()=>{r=null,t=null,M=!1}),n.addEventListener("mousemove",o=>{r!==null&&t!==null&&(Ce(e,o.offsetX-r,o.offsetY-t),r=o.offsetX,t=o.offsetY)})}function ze(e){let{element:n}=e,r=null,t=null;n.addEventListener("touchstart",o=>{r=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY,M=!1,B()}),n.addEventListener("touchend",()=>{r=null,t=null,M=!1}),n.addEventListener("touchmove",o=>{r!==null&&t!==null&&(Ce(e,o.changedTouches[0].pageX-r,o.changedTouches[0].pageY-t),r=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY)})}function $e(e){Ke(e),ze(e)}var{sin:_,cos:I,asin:_e,atan2:Ie,sqrt:Ge,PI:we}=Math;function Me(e,n,r){let{tilt:[t,o]}=r,{r:l,x0:i,y0:m}=h(r),a=e-i,s=m-n,u=l*l-a*a-s*s;if(u<0)return null;let f=Ge(u),c=a,E=s*I(-o)-f*_(-o),L=s*_(-o)+f*I(-o),S=c*I(-t)+L*_(-t),A=E,g=-c*_(-t)+L*I(-t),b=T(Ie(g,S)),k=T(_e(A/l),-we/2,we/2,!0);return[b,k]}function Y(e,n){let r=document.createElement("td");return r.className=`${n?"":"x "}${e}`,r.textContent=n||"\u2022",r}function Ee(e){let n=document.createDocumentFragment(),r=document.createElement("table"),t=e.some(({properName:o})=>!!o);for(let o of e){let l=document.createElement("tr");t&&l.append(Y("n",o.properName)),l.append(Y("b",o.bayerName||`HD ${o.id}`)),l.append(Y("m",`${o.magnitude}\u1D50`)),r.append(l)}return n.append(r),n}var O=240;function Le(e,n,r,t){let{width:o,height:l}=h(t),i=document.querySelector("#screenmenu");if(i||(i=document.createElement("div"),i.id="screenmenu",t.element.parentElement?.appendChild(i)),r.children.length===0){i.classList.add("hidden");return}i.innerHTML="",i.style.width="",i.append(r),i.classList.remove("hidden");let{width:m,height:a}=i.getBoundingClientRect();m>O?(i.style.width=`${O}px`,i.classList.add("wide"),m=O):i.classList.remove("wide");let s=Math.min(e+4,o-m-6),u=Math.min(n+4,l-a-6);i.style.setProperty("--x",`${s}px`),i.style.setProperty("--y",`${u}px`)}var{abs:Ae}=Math,Ne=5;function Xe(e,n){return e.magnitude-n.magnitude}function Fe(e){document.addEventListener("click",n=>{if(!e.element.contains(n.target))return;let{left:r,top:t}=e.element.getBoundingClientRect(),o=n.offsetX-r,l=n.offsetY-t,i=Me(o,l,e);if(console.log("click",i),i===null)return;let m=[];for(let a of e.stars){let s=p(a.ra,a.dec,e);s!==null&&Ae(s[0]-o)<=Ne&&Ae(s[1]-l)<=Ne&&m.push(a)}m.sort(Xe);for(let a of m)console.log(`#${a.id}; ${a.name}`,a.magnitude),window.sendEvent?.(["click star",a.name??`#${a.id}`]);Le(o,l,Ee(m),e)})}function De(e){let n=document.querySelector("#screen form");for(let r of n.querySelectorAll('[name="mode"]'))r.checked=r.value===e.mode;n.addEventListener("change",r=>{let t=r.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let o=t.value;document.documentElement.dataset.mode=o,e.mode=o,$(e),w.write("mode",o),window.sendEvent?.(["set mode",o])}})}function V({element:e}){let n=e.parentElement;if(!n)return;e.setAttribute("style","display: none");let{width:r,height:t}=n.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${r} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}var Ye=[1.7,1.05];async function Oe(){let e=document.querySelector("#screen svg"),n=await Z(),r=w.read("mode")??document.documentElement.dataset.mode,t={...n,element:e,tilt:w.read("tilt")??Ye,mode:r};document.documentElement.dataset.mode!==r&&(document.documentElement.dataset.mode=r);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{B(),V(t),$(t)})}),V(t),De(t),$(t),$e(t),Fe(t),window.sendEvent?.(["load mode",r])}Oe();})();
