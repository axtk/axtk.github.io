"use strict";(()=>{var R="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",E={stars:`${R}/stars_m6.csv`,constellationLabels:`${R}/constellation_labels.csv`,constellationNames:`${R}/constellation_names.csv`,constellationLines:`${R}/constellation_lines.csv`},c="http://www.w3.org/2000/svg",_={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},W=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"],j={O:"#c0ffff",B:"#c0ffff",A:"#ffffff",F:"#ffffff",G:"#f9f9d8",K:"#ffe0c0",M:"#f9cdcd"};function N(e){let n=e?.match(/^([^\d]+)(\d+)?$/);if(!n)return e;let[,r="",t=""]=n;return _[r]&&(r=_[r]),t&&(t=W[Number(t)]??t),`${r}${t}`}var K=class{ra;dec;magnitude;id;spectralClass;bayerKey;constellation;properName;constructor({ra:n,dec:r,magnitude:t,id:o,spectralClass:i,bayerName:l,properName:a}){this.ra=n,this.dec=r,this.magnitude=t,this.id=o,this.spectralClass=i,this.properName=a,l&&([this.bayerKey,this.constellation]=l.split(" "),this.bayerKey=N(this.bayerKey))}get bayerName(){if(this.bayerKey!==void 0)return this.constellation===void 0?this.bayerKey:`${this.bayerKey} ${this.constellation}`}get name(){let{bayerName:n}=this;if(n!==void 0)return this.properName?`${this.properName}, ${n}`:n}};function v(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function J(e){return e.trim().split(/\r?\n/).slice(1).map(n=>{let[r,t,o,i,l,a,s]=n.split(",");return new K({ra:Number(r),dec:Number(t),magnitude:Number(o),id:i,spectralClass:l,bayerName:v(a),properName:v(s)})})}var z=class{ra;dec;name;constructor({ra:n,dec:r,name:t}){this.ra=n,this.dec=r,this.name=t}};function U(e){return e.trim().split(/\r?\n/).slice(1).map(n=>{let[r,t,o]=n.split(",");return new z({ra:Number(t),dec:Number(o),name:r})})}function Ee(e){let n={};for(let r of e){let t=r.bayerName||`#${r.id}`;n[t]=[r.ra,r.dec]}return n}function Z(e,n){let r=Ee(n);return e.trim().split(/\r?\n/).map(t=>{let o=t.split(","),i=[],l=o[0],a=o[1].slice(1,-1).split(" ");for(let s of a){let m=null;if(s.includes("=")&&(m=r[`#${s.split("=").at(-1)}`]),m){i.push(m);continue}if(s.includes("_")){let u=s.indexOf("_");m=r[`${N(s.slice(0,u))} ${s.slice(u+1)}`]}else m=r[`${N(s)} ${l}`];m&&i.push(m)}return i})}function ee(e){return e.trim().split(/\r?\n/).slice(1).reduce((n,r)=>{let[t,o]=r.split(",").map(v);return t&&o&&(n[t]=o),n},{})}async function Ne(e){return fetch(e).then(n=>n.text())}async function te(){let[e,n,r,t]=await Promise.all([E.stars,E.constellationLabels,E.constellationNames,E.constellationLines].map(Ne)),o=J(e),i=U(n),l=Z(t,o),a=ee(r);return{stars:o,constellationLabels:i,constellationNames:a,constellationLines:l}}var B=null,re="";function p({element:e}){let n=e.getAttribute("data-size");if(n===re&&B!==null)return B;let r=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return B={width:r,height:t,r:Math.sqrt(r*r+t*t)/1.65,x0:r/2,y0:t/2},re=n,B}function I(){document.querySelector("#screenmenu")?.classList.add("hidden")}var ne=!1;function oe(e){if(e.mode!=="dark"||ne)return;let n=e.element.parentElement,r=n.querySelector("defs"),t=r?.querySelector("#spcl")?.outerHTML;if(!r||!t)return;let o=document.createElement("style"),i="",l="";for(let[a,s]of Object.entries(j)){let m=`html[data-mode="dark"] #screen .stars circle[data-spcl^="${a}"]`;i+=`${m}{fill:url(#spcl_${a});}`,l+=`
${t}`.replace('id="spcl"',`id="spcl_${a}"`).replaceAll("currentColor",s)}r.innerHTML+=l,o.innerHTML=i,n.prepend(o),ne=!0}var{sin:A,cos:x}=Math;function f(e,n,r,t=.25){let{tilt:[o,i]}=r,{width:l,height:a,x0:s,y0:m,r:u}=p(r),d=u*x(n)*x(e),g=u*A(n),b=u*x(n)*A(e),D=d*x(o)+b*A(o),P=g,T=-d*A(o)+b*x(o),y=D,C=P*x(i)-T*A(i),q=P*A(i)+T*x(i);return y=s+y,C=m-C,q<0||y<-t*l||y>(1+t)*l||C<-t*a||C>(1+t)*a?null:[y,C,q]}var{PI:h}=Math,G=h/100,F=h/12,ie=h/50;function le(e){let n=e.element.querySelector("g.grid"),r=n.querySelector("path");r||(r=document.createElementNS(c,"path"),n.appendChild(r));let t,o="",i="";for(let l=-h/2+F;l<=h/2-F+G;l+=F){let a="",s=!1;for(let m=0;m<=2*h+G;m+=ie){if(t=f(m,l,e,.5),i=a&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),a+=`${i}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}for(let l=0;l<=2*h-F+G;l+=F){let a="",s=!1;for(let m=-h/2;m<=h/2+G;m+=ie){if(t=f(l,m,e,.5),i=a&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),a+=`${i}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}r.setAttribute("d",o)}function M(e,n){return n.mode==="fantasy"?2*(6.75-e.magnitude):n.mode==="light"?.6*(6.75-e.magnitude):.7*(6.75-e.magnitude)}var{floor:V,random:S,sin:se,cos:ae,PI:me}=Math;function ve(){return`#${["","",""].map(()=>V(50+120*S()).toString(16)).join("")}`}var Fe=30,H=[];function ke(){if(H.length===Fe)return H[V(S()*H.length)];let e="",n=Array.from({length:2}).map(()=>ve());for(let r=0;r<2;r++)for(let t=.25*r;t<5;t++){let o=2*me*S(),i=5+t*ae(o),l=5+t*se(o),a=o+me*(.5+.5*S()),s=5+t*ae(a),m=5+t*se(a),u=n[V(S()*n.length)];e+=`<path d="M${i} ${l} A ${t} ${t} 0 1 0 ${s} ${m}" stroke="${u}" stroke-width="${(.75+S()).toFixed(3)}" stroke-opacity="${(.35+.55*S()).toFixed(3)}"/>`}return H.push(e),e}function ue(e){let n=e.element.querySelector("g.stars"),r=Array.from(n.querySelectorAll("svg")),t=null;for(let u of n.querySelectorAll("circle"))u.remove();let o,i,l,a,s,m=0;for(let u=0;u<e.stars.length;u++)o=e.stars[u],l=f(o.ra,o.dec,e),l!==null&&(i=r[m++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"svg"),i.setAttribute("viewBox","0 0 10 10"),i.innerHTML=ke(),t.appendChild(i)),a=M(o,e),s=(2*a).toFixed(3),i.setAttribute("x",(l[0]-a).toFixed(3)),i.setAttribute("y",(l[1]-a).toFixed(3)),i.setAttribute("width",s),i.setAttribute("height",s),i.setAttribute("data-spcl",o.spectralClass));t&&n.appendChild(t);for(let u=m;u<r.length;u++)r[u].remove()}function fe(e){if(e.mode==="fantasy")return ue(e);let n=e.element.querySelector("g.stars"),r=Array.from(n.querySelectorAll("circle")),t=null;for(let s of n.querySelectorAll("svg"))s.remove();let o,i,l,a=0;for(let s=0;s<e.stars.length;s++)o=e.stars[s],l=f(o.ra,o.dec,e),l!==null&&(i=r[a++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"circle"),t.appendChild(i)),i.setAttribute("cx",l[0].toFixed(3)),i.setAttribute("cy",l[1].toFixed(3)),i.setAttribute("r",M(o,e).toFixed(3)),i.setAttribute("data-spcl",o.spectralClass??""));t&&n.appendChild(t);for(let s=a;s<r.length;s++)r[s].remove()}function ce(e){let{r:n}=p(e),r=n<640?3:4,t=e.element.querySelector("g.star-labels"),o=Array.from(t.querySelectorAll("text")),i=null,l,a,s,m=0;for(let u=0;u<e.stars.length;u++){if(l=e.stars[u],!l.bayerKey||l.magnitude>r||(s=f(l.ra,l.dec,e),s===null))continue;a=o[m++],a||(i||(i=document.createDocumentFragment()),a=document.createElementNS(c,"text"),i.appendChild(a));let d=M(l,e);a.setAttribute("x",(s[0]+d+2).toFixed(3)),a.setAttribute("y",(s[1]+2).toFixed(3)),a.textContent=l.bayerKey}i&&t.appendChild(i);for(let u=m;u<o.length;u++)o[u].remove()}function De(e,n){if(e.name)return n.constellationNames[e.name]??e.name}function pe(e){let n=e.element.querySelector("g.constellation-labels"),r=Array.from(n.querySelectorAll("text")),t=null,o,i,l,a,s=0;for(let m=0;m<e.constellationLabels.length;m++)o=e.constellationLabels[m],i=De(o,e),i&&(a=f(o.ra,o.dec,e),a!==null&&(l=r[s++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"text"),t.appendChild(l)),l.setAttribute("x",a[0].toFixed(3)),l.setAttribute("y",a[1].toFixed(3)),l.textContent=i));t&&n.appendChild(t);for(let m=s;m<r.length;m++)r[m].remove()}function de(e){let n=e.element.querySelector("g.constellation-lines"),r=Array.from(n.querySelectorAll("path")),t=null,o,i,l,a,s=0;for(let m=0;m<e.constellationLines.length;m++){o=e.constellationLines[m],i="";for(let u of o)a=f(u[0],u[1],e,1),a!==null&&(i+=`${i?" L":"M"}${a[0]},${a[1]}`);i&&(l=r[s++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"path"),t.appendChild(l)),l.setAttribute("d",i))}t&&n.appendChild(t);for(let m=s;m<r.length;m++)r[m].remove()}function $(e){oe(e),le(e),fe(e),ce(e),pe(e),de(e)}var he="stars.",L={read(e){try{let n=localStorage.getItem(`${he}${e}`);return n===null?null:JSON.parse(n)}catch{return null}},write(e,n){try{localStorage.setItem(`${he}${e}`,JSON.stringify(n))}catch{}}};function k(e,n=0,r=2*Math.PI,t){for(;e<n;)e+=r-n;if(t)for(;e>r;)e-=r-n;else for(;e>=r;)e-=r-n;return e}var{PI:ge,asin:be}=Math,w=!1;function ye(e,n,r){let{tilt:t}=e,{r:o}=p(e),i=be(n/o),l=be(r/o),a=t[0]+i,s=t[1]+l;t[0]=k(a),s>=-ge/2&&s<=ge/2&&(t[1]=s),w||(requestAnimationFrame(()=>{$(e),L.write("tilt",t),w=!1}),w=!0)}function Pe(e){let{element:n}=e,r=null,t=null;n.addEventListener("mousedown",o=>{r=o.offsetX,t=o.offsetY,w=!1}),n.addEventListener("mouseup",()=>{r=null,t=null,w=!1}),n.addEventListener("mousemove",o=>{r!==null&&t!==null&&(ye(e,o.offsetX-r,o.offsetY-t),r=o.offsetX,t=o.offsetY)})}function Te(e){let{element:n}=e,r=null,t=null;n.addEventListener("touchstart",o=>{r=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY,w=!1,I()}),n.addEventListener("touchend",()=>{r=null,t=null,w=!1}),n.addEventListener("touchmove",o=>{r!==null&&t!==null&&(ye(e,o.changedTouches[0].pageX-r,o.changedTouches[0].pageY-t),r=o.changedTouches[0].pageX,t=o.changedTouches[0].pageY)})}function Ce(e){Pe(e),Te(e)}var{sin:X,cos:Y,asin:qe,atan2:Re,sqrt:Ke,PI:xe}=Math;function Se(e,n,r){let{tilt:[t,o]}=r,{r:i,x0:l,y0:a}=p(r),s=e-l,m=a-n,u=i*i-s*s-m*m;if(u<0)return null;let d=Ke(u),g=s,b=m*Y(-o)-d*X(-o),D=m*X(-o)+d*Y(-o),P=g*Y(-t)+D*X(-t),T=b,y=-g*X(-t)+D*Y(-t),C=k(Re(y,P)),q=k(qe(T/i),-xe/2,xe/2,!0);return[C,q]}var O=240;function $e(e,n,r,t){let{width:o,height:i}=p(t),l=document.querySelector("#screenmenu");if(l||(l=document.createElement("div"),l.id="screenmenu",t.element.parentElement?.appendChild(l)),r.length===0){l.classList.add("hidden");return}let a=document.createElement("ul");for(let g of r){let b=document.createElement("li");b.textContent=g.name??`#${g.id}`,a.appendChild(b)}l.innerHTML="",l.style.width="",l.appendChild(a),l.classList.remove("hidden");let{width:s,height:m}=l.getBoundingClientRect();s>O?(l.style.width=`${O}px`,l.classList.add("wide"),s=O):l.classList.remove("wide");let u=Math.min(e+4,o-s-6),d=Math.min(n+4,i-m-6);l.style.setProperty("--x",`${u}px`),l.style.setProperty("--y",`${d}px`)}var{abs:Le}=Math,we=5;function ze(e,n){return e.magnitude-n.magnitude}function Ae(e){document.addEventListener("click",n=>{if(!e.element.contains(n.target))return;let{left:r,top:t}=e.element.getBoundingClientRect(),o=n.offsetX-r,i=n.offsetY-t,l=Se(o,i,e);if(console.log("click",l),l===null)return;let a=[];for(let s of e.stars){let m=f(s.ra,s.dec,e);m!==null&&Le(m[0]-o)<=we&&Le(m[1]-i)<=we&&a.push(s)}a.sort(ze);for(let s of a)console.log(`#${s.id}; ${s.name}`,s.magnitude),window.sendEvent?.(["click star",s.name??`#${s.id}`]);$e(o,i,a,e)})}function Me(e){let n=document.querySelector("#screen form");for(let r of n.querySelectorAll('[name="mode"]'))r.checked=r.value===e.mode;n.addEventListener("change",r=>{let t=r.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let o=e.mode,i=t.value;document.documentElement.dataset.mode=i,e.mode=i,(i==="fantasy"||o==="fantasy")&&$(e),L.write("mode",i),window.sendEvent?.(["set mode",i])}})}function Q({element:e}){let n=e.parentElement;if(!n)return;e.setAttribute("style","display: none");let{width:r,height:t}=n.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${r} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}async function Be(){let e=document.querySelector("#screen svg"),n=await te(),r=L.read("mode")??document.documentElement.dataset.mode,t={...n,element:e,tilt:L.read("tilt")??[-.12,0],mode:r};document.documentElement.dataset.mode!==r&&(document.documentElement.dataset.mode=r);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{I(),Q(t),$(t)})}),Q(t),Me(t),$(t),Ce(t),Ae(t),window.sendEvent?.(["load mode",r])}Be();})();
