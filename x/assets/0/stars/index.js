"use strict";(()=>{var O="https://raw.githubusercontent.com/axtk/axtk.github.io/refs/heads/main/x/assets/stars/data",k={stars:`${O}/stars_m6_bsc5.csv`,constellations:`${O}/constellations.csv`,hintLines:`${O}/constellation_lines.csv`},c="http://www.w3.org/2000/svg",X={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},W=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"],J={O:"#c0ffff",B:"#c0ffff",A:"#ffffff",F:"#ffffff",G:"#f9f9d8",K:"#ffe0c0",M:"#f9cdcd"};var q=class{abbr;name;label;constructor({abbr:r,name:n,label:t}){this.abbr=r,this.name=n,this.label=t}};function $(e){return!e||!e.startsWith('"')||!e.endsWith('"')?e:e.slice(1,-1)}function U(e){return e.trim().split(/\r?\n/).slice(1).map(r=>{let[n,t,o,i]=r.split(",");return new q({abbr:n,name:$(i),label:{ra:Number(t),dec:Number(o)}})})}function M(e){let r=e?.match(/^([^\d]+)(\d+)?$/);if(!r)return e;let[,n="",t=""]=r;return X[n]&&(n=X[n]),t&&(t=W[Number(t)]??t),`${n}${t}`}function ke(e){let r={};for(let n of e){let t=n.bayerName||`#${n.id}`;r[t]=n}return r}function Y(e){return e?[e.ra,e.dec]:null}function qe(e,r){return e.magnitude-r.magnitude}var Re=[1,2,3],He=["A","B"];function Be(e,r,n){let t=[];for(let i of Re){let l=n[`${M(`${e}${i}`)} ${r}`];l&&t.push(l)}let o=M(e);for(let i of He){let l=n[`${o} ${r} ${i}`];l&&t.push(l)}return t.sort(qe)[0]}function Z(e,r){let n=ke(r);return e.trim().split(/\r?\n/).slice(1).map(t=>{let o=t.split(","),i=[],l=o[0],a=$(o[1]).split(" ");for(let s of a){let m=null;if(s.includes("=")&&(m=Y(n[`#${s.split("=").at(-1)}`])),m){i.push(m);continue}let u="",f="";if(s.includes("_")){let d=s.indexOf("_");u=s.slice(0,d),f=s.slice(d+1).replace(/_/g," ")}else u=s,f=l;u&&f&&(m=Y(n[`${M(u)} ${f}`]),m||(m=Y(Be(u,f,n)))),m&&i.push(m)}return i})}var R=class{ra;dec;magnitude;id;spectralClass;bayerKey;bayerName;properName;constructor({ra:r,dec:n,magnitude:t,id:o,spectralClass:i,bayerName:l,properName:a}){if(this.ra=r,this.dec=n,this.magnitude=t,this.id=o,this.spectralClass=i,this.properName=a,l){let[s,...m]=l.split(" "),u=M(s);this.bayerKey=u,this.bayerName=u?`${u}${m.length===0?"":` ${m.join(" ")}`}`:void 0}}get name(){let{bayerName:r}=this;if(r!==void 0)return this.properName?`${this.properName}, ${r}`:r}};function Ie(e,r){return e.magnitude-r.magnitude}function ee(e){return e.trim().split(/\r?\n/).slice(1).map(r=>{let[n,t,o,i,l,a,s]=r.split(",");return new R({ra:Number(n),dec:Number(t),magnitude:Number(o),id:l,spectralClass:i,bayerName:$(a),properName:$(s)})}).sort(Ie)}async function ze(e){return fetch(e).then(r=>r.text())}async function te(){let[e,r,n]=await Promise.all([k.stars,k.constellations,k.hintLines].map(ze)),t=ee(e),o=U(r),i=Z(n,t);return{stars:t,constellations:o,hintLines:i}}function H(){document.querySelector("#screenmenu")?.classList.add("hidden")}var B=null,re="";function h({element:e}){let r=e.getAttribute("data-size");if(r===re&&B!==null)return B;let n=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return B={width:n,height:t,r:.65*Math.sqrt(n*n+t*t),x0:n/2,y0:t/2},re=r,B}function D(e,r=0,n=2*Math.PI,t){for(;e<r;)e+=n-r;if(t)for(;e>n;)e-=n-r;else for(;e>=n;)e-=n-r;return e}var{sin:I,cos:z,asin:Ke,atan2:_e,sqrt:Ge,PI:ne}=Math;function oe(e,r,n){let{tilt:[t,o]}=n,{r:i,x0:l,y0:a}=h(n),s=e-l,m=a-r,u=i*i-s*s-m*m;if(u<0)return null;let f=Ge(u),d=s,x=m*z(-o)-f*I(-o),b=m*I(-o)+f*z(-o),g=d*z(-t)+b*I(-t),E=x,y=-d*I(-t)+b*z(-t),S=D(_e(y,g)),T=D(Ke(E/i),-ne/2,ne/2,!0);return[S,T]}var{sin:A,cos:w}=Math;function p(e,r,n,t=.25){let{tilt:[o,i]}=n,{width:l,height:a,x0:s,y0:m,r:u}=h(n),f=u*w(r)*w(e),d=u*A(r),x=u*w(r)*A(e),b=f*w(o)+x*A(o),g=d,E=-f*A(o)+x*w(o),y=b,S=g*w(i)-E*A(i),T=g*A(i)+E*w(i);return y=s+y,S=m-S,T<0||y<-t*l||y>(1+t)*l||S<-t*a||S>(1+t)*a?null:[y,S,T]}function j(e,r){let n=document.createElement("td");return n.className=`${r?"":"x "}${e}`,n.textContent=r||"\u2022",n}function ie(e){let r=document.createDocumentFragment(),n=document.createElement("table"),t=e.some(({properName:o})=>!!o);for(let o of e){let i=document.createElement("tr");t&&i.append(j("n",o.properName)),i.append(j("b",o.bayerName||`HD ${o.id}`)),i.append(j("m",`${o.magnitude}\u1D50`)),n.append(i)}return r.append(n),r}var V=240;function le(e,r,n,t){let{width:o,height:i}=h(t),l=document.querySelector("#screenmenu");if(l||(l=document.createElement("div"),l.id="screenmenu",t.element.parentElement?.appendChild(l)),n.children.length===0){l.classList.add("hidden");return}l.innerHTML="",l.style.width="",l.append(n),l.classList.remove("hidden");let{width:a,height:s}=l.getBoundingClientRect();a>V?(l.style.width=`${V}px`,l.classList.add("wide"),a=V):l.classList.remove("wide");let m=Math.min(e+4,o-a-6),u=Math.min(r+4,i-s-6);l.style.setProperty("--x",`${m}px`),l.style.setProperty("--y",`${u}px`)}var{abs:se}=Math,me=5;function Oe(e,r){return e.magnitude-r.magnitude}function ae(e){document.addEventListener("click",r=>{if(!e.element.contains(r.target))return;let{left:n,top:t}=e.element.getBoundingClientRect(),o=r.offsetX-n,i=r.offsetY-t;if(oe(o,i,e)===null)return;let a=[];for(let s of e.stars){let m=p(s.ra,s.dec,e);m!==null&&se(m[0]-o)<=me&&se(m[1]-i)<=me&&a.push(s)}a.sort(Oe);for(let s of a)window.sendEvent?.(["click star",s.name??`#${s.id}`]);le(o,i,ie(a),e)})}function ue(e){let r=e.element.querySelector("g.constellation-labels"),n=Array.from(r.querySelectorAll("text")),t=null,o,i,l,a=0;for(let s=0;s<e.constellations.length;s++)o=e.constellations[s],o.name&&(l=p(o.label.ra,o.label.dec,e),l!==null&&(i=n[a++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"text"),t.appendChild(i)),i.setAttribute("x",l[0].toFixed(3)),i.setAttribute("y",l[1].toFixed(3)),i.textContent=o.name));t&&r.appendChild(t);for(let s=a;s<n.length;s++)n[s].remove()}var{PI:C}=Math,K=C/100,F=C/12,fe=C/50;function de(e){let r=e.element.querySelector("g.grid"),n=r.querySelector("path");n||(n=document.createElementNS(c,"path"),r.appendChild(n));let t,o="",i="";for(let l=-C/2+F;l<=C/2-F+K;l+=F){let a="",s=!1;for(let m=0;m<=2*C+K;m+=fe){if(t=p(m,l,e,.5),i=a&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),a+=`${i}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}for(let l=0;l<=2*C-F+K;l+=F){let a="",s=!1;for(let m=-C/2;m<=C/2+K;m+=fe){if(t=p(l,m,e,.5),i=a&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),a+=`${i}${t[0].toFixed(3)},${t[1].toFixed(3)}`}o+=`${o?" ":""}${a}`}n.setAttribute("d",o)}function pe(e){let r=e.element.querySelector("g.hint-lines"),n=Array.from(r.querySelectorAll("path")),t=null,o,i,l,a,s=0;for(let m=0;m<e.hintLines.length;m++){o=e.hintLines[m],i="";for(let u of o)a=p(u[0],u[1],e,1),a!==null&&(i+=`${i?" L":"M"}${a[0]},${a[1]}`);i&&(l=n[s++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"path"),t.appendChild(l)),l.setAttribute("d",i))}t&&r.appendChild(t);for(let m=s;m<n.length;m++)n[m].remove()}var ce=!1,he='html[data-mode="dark"] #screen .stars circle';function ge(e){if(e.mode!=="dark"||ce)return;let r=e.element.parentElement,n=r.querySelector("defs"),t=n?.querySelector("#spcl")?.outerHTML;if(!n||!t)return;let o=document.createElement("style"),i="",l="",a="";l+=`${he}:not([r^="0."]){fill:url(#spcl);}`;for(let[s,m]of Object.entries(J)){let u=`${he}[data-spcl^="${s}"]`;i+=`${u}[r^="0."]{fill:${m};}`,l+=`${u}:not([r^="0."]){fill:url(#spcl_${s});}`,a+=`
${t}`.replace('id="spcl"',`id="spcl_${s}"`).replaceAll("currentColor",m)}n.innerHTML+=a,o.innerHTML=i,o.innerHTML=l,r.prepend(o),ce=!0}function _(e,r){return r.mode==="fantasy"?2*(6.75-e.magnitude):r.mode==="light"?.6*(6.75-e.magnitude):.7*(6.75-e.magnitude)}var{ceil:Xe,floor:be,max:Ye}=Math,G=class{grid={};cellSize;rowLength;constructor(r,n=50){let{width:t}=h(r);this.cellSize=n,this.rowLength=Xe(t/n)}push(r,n,t){let o=be(t/this.cellSize)*this.rowLength+be(n/this.cellSize);this.grid[o]||(this.grid[o]=[]),this.grid[o].push(r)}_getNeightborCellIndices(r){let n=[];for(let t=-1;t<=1;t++)for(let o=-1;o<=1;o++){let i=this.grid[String(Number(r)+t*this.rowLength+o)];i&&n.push(...i)}return n}resolve(r){let n=new Set;for(let t of Object.keys(this.grid)){let o=this._getNeightborCellIndices(t);if(!(o.length<2))for(let i of o)for(let l of o){if(i===l||n.has(i)||n.has(l)||!r[i]||!r[l])continue;let a=r[i].getBoundingClientRect(),s=r[l].getBoundingClientRect();a.left<s.right&&a.right>s.left&&a.top<s.bottom&&a.bottom>s.top&&n.add(Ye(i,l))}}return n}};function ye(e){let{r}=h(e),n=r<640?3:4,t=e.element.querySelector("g.star-labels"),o=Array.from(t.querySelectorAll("text")),i=null,l,a,s,m=0,u=new G(e);for(let d=0;d<e.stars.length;d++){if(l=e.stars[d],!l.bayerKey)continue;if(l.magnitude>n)break;if(s=p(l.ra,l.dec,e),s===null)continue;a=o[m],a||(i||(i=document.createDocumentFragment()),a=document.createElementNS(c,"text"),i.appendChild(a),o.push(a));let x=_(l,e),b=s[0]+x+2,g=s[1]+2;u.push(m,b,g),a.setAttribute("x",b.toFixed(3)),a.setAttribute("y",g.toFixed(3)),a.textContent=l.bayerKey,m++}i&&t.appendChild(i);let f=u.resolve(o);for(let d=m;d<o.length;d++)o[d].remove();for(let d of f)o[d]?.remove()}var{floor:Le,random:N,sin:Se,cos:Ce,PI:xe}=Math;function je(){return`#${["","",""].map(()=>Le(50+120*N()).toString(16)).join("")}`}var $e=30,we=!1,Ve='html[data-mode="fantasy"] #screen .stars circle';function ve(e){if(e.mode!=="fantasy"||we)return;let r=e.element.parentElement,n=r.querySelector("defs");if(!n)return;let t=document.createDocumentFragment(),o="";for(let l=0;l<$e;l++){let a="",s=Array.from({length:2}).map(()=>je());for(let u=0;u<2;u++)for(let f=.25*u;f<5;f++){let d=2*xe*N(),x=5+f*Ce(d),b=5+f*Se(d),g=d+xe*(.5+.5*N()),E=5+f*Ce(g),y=5+f*Se(g),S=s[Le(N()*s.length)];a+=`<path d="M${x} ${b} A ${f} ${f} 0 1 0 ${E} ${y}" class="p" stroke="${S}" stroke-width="${(.75+N()).toFixed(3)}" stroke-opacity="${(.35+.55*N()).toFixed(3)}"/>`}let m=document.createElementNS(c,"pattern");m.setAttribute("id",`p_${l}`),m.setAttribute("viewBox","0 0 10 10"),m.setAttribute("width","100%"),m.setAttribute("height","100%"),m.innerHTML=a,t.append(m),o+=`${Ve}:nth-child(${$e}n+${l}){fill:url(#p_${l});}`}let i=document.createElement("style");i.innerHTML=o,r.append(i),n.append(t),we=!0}function Ee(e,r){return r.mode==="fantasy"?Math.min(.5+.2*(6.75-e.magnitude),1):Math.min(.2+.15*(6.75-e.magnitude),1)}function Me(e){let r=e.element.querySelector("g.stars"),n=Array.from(r.querySelectorAll("circle")),t=null,o,i,l,a=0,s=e.moving?.5:.1;for(let m=0;m<e.stars.length;m++){if(o=e.stars[m],l=p(o.ra,o.dec,e),l===null)continue;let u=_(o,e);u<s||(i=n[a++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"circle"),t.appendChild(i)),i.setAttribute("cx",l[0].toFixed(3)),i.setAttribute("cy",l[1].toFixed(3)),i.setAttribute("r",u.toFixed(2)),i.setAttribute("fill-opacity",Ee(o,e).toFixed(2)),i.setAttribute("data-spcl",o.spectralClass??""))}t&&r.appendChild(t);for(let m=a;m<n.length;m++)n[m].remove()}function L(e){e.element.dataset.moving=String(e.moving??""),de(e),ge(e),Me(e),ye(e),ve(e),ue(e),pe(e)}var Ae="stars.",v={read(e){try{let r=localStorage.getItem(`${Ae}${e}`);return r===null?null:JSON.parse(r)}catch{return null}},write(e,r){try{localStorage.setItem(`${Ae}${e}`,JSON.stringify(r))}catch{}}};var{PI:Ne,asin:De}=Math,P=!1;function Fe(e,r,n){if(P)return;P=!0;let{tilt:t}=e,{r:o}=h(e),i=De(r/o),l=De(n/o),a=t[0]+i,s=t[1]+l;t[0]=D(a),s>=-Ne/2&&s<=Ne/2&&(t[1]=s),requestAnimationFrame(()=>{L(e),v.write("tilt",t),P=!1})}function Pe(e){let{element:r}=e,n=null,t=null,o=Date.now();function i(u,f){H(),n=u,t=f,P=!1}function l(u,f){P=!1,e.moving=!1,n!==null&&t!==null&&Fe(e,u-n,f-t),n=null,t=null}function a(u,f){let d=Date.now();n===null||t===null||d-o<20||(e.moving||(e.moving=!0),Fe(e,u-n,f-t),n=u,t=f,o=d)}let s=null,m=null;r.addEventListener("mousedown",u=>{i(u.offsetX,u.offsetY),!s&&!m&&(s=f=>{f.preventDefault(),a(f.offsetX,f.offsetY)},r.addEventListener("mousemove",s))}),r.addEventListener("mouseup",u=>{l(u.offsetX,u.offsetY),s&&(r.removeEventListener("mousemove",s),s=null)}),r.addEventListener("touchstart",u=>{i(u.changedTouches[0].pageX,u.changedTouches[0].pageY),!m&&!s&&(m=f=>{f.preventDefault(),a(f.changedTouches[0].pageX,f.changedTouches[0].pageY)},r.addEventListener("touchmove",m))}),r.addEventListener("touchend",u=>{l(u.changedTouches[0].pageX,u.changedTouches[0].pageY),m&&(r.removeEventListener("touchmove",m),m=null)})}function Te(e){let r=document.querySelector("#screen form");for(let n of r.querySelectorAll('[name="mode"]'))n.checked=n.value===e.mode;r.addEventListener("change",n=>{let t=n.target;if(t instanceof HTMLInputElement&&t.name==="mode"){let o=t.value;document.documentElement.dataset.mode=o,e.mode=o,L(e),v.write("mode",o),window.sendEvent?.(["set mode",o])}})}function Q({element:e}){let r=e.parentElement;if(!r)return;e.setAttribute("style","display: none");let{width:n,height:t}=r.getBoundingClientRect();e.setAttribute("width",String(n)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${n} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}var Qe=[1.7,1.05];async function We(){let e=document.querySelector("#screen svg"),r=await te(),n=document.documentElement.dataset.mode||v.read("mode"),t={...r,element:e,tilt:v.read("tilt")??Qe,mode:n};document.documentElement.dataset.mode!==n&&(document.documentElement.dataset.mode=n);let o=null;window.addEventListener("resize",()=>{o!==null&&cancelAnimationFrame(o),o=requestAnimationFrame(()=>{H(),Q(t),L(t)})}),Q(t),Te(t),L(t),Pe(t),ae(t),window.sendEvent?.(["load mode",n])}We();})();
