"use strict";(()=>{function y(e){return e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e}function $(e,t=","){let n=[],r="",i=!1;for(let s of e){if(s===t&&!i){n.push(y(r)),r="";continue}s==='"'&&(i=!i),r+=s}return r&&n.push(y(r)),n}var b=null;function R(e){return!b&&e.index?.length&&(b=e.index.map(({content:t})=>{if(!t)return null;let n=t.split(/\r?\n/).map(i=>i.trim()).filter(i=>i!=="").slice(1);if(n.length===0)return null;let r={};for(let i of n){let[s,o,l]=$(i);s&&(r[s]={description:o,location:l})}return r}).filter(t=>t!==null)),b}function L({name:e},t){if(!e)return;let n=R(t);if(!n?.length)return;let r=e.replace(/(^[^\d]+_|\.\w+$)/g,"").split(/[-_]/).slice(0,2),i=r.join("_"),s=null,o=null;for(let l=0;l<n.length;l++){let u=n[l];if(u[i])return u[i].description;for(let a=r.length;a>0;a--){i=r.slice(0,a).join("_");for(let p of Object.keys(u)){let c=p.endsWith("*")?p.replace(/\*+$/,""):p;i.startsWith(c)&&(!o||o.length<p.length)&&(o=p,s=l)}}}if(s!==null&&o!==null)return n[s]?.[o]?.description}function _({name:e},t){if(!e)return;let r=e.replace(/(^[^\d]+_|\.\w+$)/g,"").split(/[-_]/)[0]?.match(/^(\d{4})[-_]?(\d\d)?[-_]?(\d\d)?$/);if(!(!r||r.length<2))return r.slice(1,t.dateFormat==="short"?3:4).filter(i=>i!==void 0).join("-")}function h(e){let t=new URLSearchParams(window.location.search),n=new URLSearchParams,r=t.get("u"),i=t.get("i"),s=t.get("t");r&&n.set("u",r),i&&n.set("i",i),s&&n.set("t",s);let o=n.toString();return o?o+(e??""):""}var x=null;function D(e){if(!(!e.items?.length||!e.container)&&(x||(x=e.container instanceof Element?e.container:document.querySelector(e.container)),!!x)){e.aspectRatio!==void 0&&x.style.setProperty("--aspect-ratio",String(e.aspectRatio));for(let t of e.items){let n=document.createElement("figure"),r=`https://night-salad.vercel.app/?u=${encodeURIComponent(t.url??"")}`,i=e.getDisplayedDate?.(t,e),s=e.getDescription?.(t,e),o=`?${h("&")}k=${encodeURIComponent(t.index??"")}&n=${encodeURIComponent(t.name??"")}`;t.id&&(n.id=t.id),t.name&&(n.dataset.name=t.name),n.innerHTML=`<picture><img src="${r}" alt="${t.name??""}" height="300" loading="lazy"></picture><figcaption><span class="content">`+(!e.hideDate&&i?`<span class="date">${i}</span> `:"")+(s?`<span class="description">${s}</span> `:"")+'</span><span class="controls">'+(e.mode==="list"?`<a href="${o}" title="\u041D\u0430 \u0432\u0435\u0441\u044C \u044D\u043A\u0440\u0430\u043D">\u231E\u231D</a>`:"")+"</span></figcaption>",x.appendChild(n)}for(let t of x.querySelectorAll("img")){if(t.complete){t.classList.add("complete");continue}t.addEventListener("load",()=>{t.classList.add("complete")})}}}var g=null;function U(e,t){if(t===void 0||!g)return;let n=g.querySelector(`[data-key="${e}"]`);n&&(n.href=t)}function k(e,t,n){if(n===void 0)return;let r=n<1?`?${h()}`:`?${h("&")}${`${encodeURIComponent(t)}=${encodeURIComponent(n)}`}`;U(e,r)}function q(e){if(e.navContainer&&(g||(g=e.navContainer instanceof Element?e.navContainer:document.querySelector(e.navContainer)),!!g)){if(e.mode==="list"){g.innerHTML='<a title="\u041D\u0430 \u043F\u0435\u0440\u0432\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443" data-key="start">\u25C0\u25C0</a> <a title="\u041D\u0430 \u043F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 [\u2190]" data-key="prev">\u25C0</a> '+(e.homePage?`<a href="${e.homePage}" title="\u041D\u0430 \u0433\u043B\u0430\u0432\u043D\u0443\u044E" data-key="quit">\u25C6</a> `:"")+'<a title="\u041D\u0430 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 [\u2192]" data-key="next">\u25B6</a> <a title="\u041D\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u044E\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443" data-key="end">\u25B6\u25B6</a>';let{startIndex:t,pageSize:n,total:r}=e;if(t!==void 0&&n&&r!==void 0){let i=(Math.ceil(r/n)-1)*n;k("start","s",t===0?void 0:0),k("prev","s",t===0?void 0:t-n),k("next","s",t<i?Math.min(t+n,i):void 0),k("end","s",t<i?i:void 0)}}if(e.mode==="standalone"){g.innerHTML='<a title="\u041F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0430\u044F [\u2190]" data-key="prev">\u25C0</a> <a title="\u041A \u0441\u043F\u0438\u0441\u043A\u0443" data-key="quit">\u2630</a> <a title="\u0421\u043B\u0435\u0434\u0443\u044E\u0449\u0430\u044F [\u2192]" data-key="next">\u25B6</a>';let{fileIndex:t,pageSize:n}=e;if(t!==void 0&&n){let r=Math.floor(t/n)*n;k("prev","k",t===0?void 0:t-1),k("next","k",t+1);let i=`?${r>0?`${h("&")}s=${r}`:h()}`,s=`#${e.items?.[0]?.id??""}`;U("quit",`${i}${s}`)}}}}function A(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function O(e){return typeof e=="string"&&/^(\w+:)?\/\//.test(e)}var G="https://0.cc";function z({request:e,target:t,endpoint:n}){let r=e?.method,i=e?.url??e?.path;if(t&&/^[A-Z]+\s/.test(t)){let[f,d]=t.split(/\s+/);r||(r=f),i||(i=d)}let s,o=O(i);if(i&&o)s=new URL(i);else if(s=new URL(n,G),o=O(n),i){let f=s.pathname;f||(s.pathname=i),f.endsWith("/")&&(f=f.slice(0,-1)),i.startsWith("/")&&(i=i.slice(1)),s.pathname=f+"/"+i}let l=e?.query,u=e?.params;if(l)for(let[f,d]of Object.entries(l))d!=null&&s.searchParams.append(f,String(d));if(u)for(let[f,d]of Object.entries(u))d!=null&&(s.pathname=s.pathname.replace(new RegExp(`:${A(f)}\\b`,"g"),String(d)));let{href:a,pathname:p,search:c,hash:m}=s;return{method:r,url:o?a:p+c+m}}function H(e){if(!e)return;let t={};for(let[n,r]of Object.entries(e))r!=null&&(t[n]=typeof r=="string"?r:JSON.stringify(r));return t}var J=class{handler;constructor(e){this.handler=e}send(e,t){if(!this.handler)throw new Error("Missing request handler");return this.handler(e,t)}use(e){this.handler=e}getEntry(e){let t={};for(let[n,r]of Object.entries(e))t[n]=i=>this.send(r,i);return t}getQueryEntry(e){let t={};for(let[n,r]of Object.entries(e))t[n]=i=>this.send(r,{query:i});return t}},B="RequestError",F="Unspecified";function C(e,t){if(!(!e||typeof e!="object"||!(t in e)))return e[t]}var K=class P extends Error{data;status;statusText;constructor(t){let n={status:C(t,"status"),statusText:C(t,"statusText"),message:C(t,"message"),name:C(t,"name"),data:C(t,"data")},r=[n.status,n.statusText].filter(Boolean).join(" ");super(n.message||r||F),this.name=n.name??B,this.status=Number(n.status??0),this.statusText=String(n.statusText??""),this.data=n.data,Object.setPrototypeOf(this,P.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,P)}},Y="https://cloud-api.yandex.net/v1",Z=class extends K{};function X(e={}){let t;return"transformInput"in e?t=e.transformInput:t=({target:n,request:r})=>{let{method:i,url:s}=z({request:r,target:n,endpoint:e.endpoint??Y});return[s,{method:i,headers:H({Accept:"application/json","Content-Type":"application/json",Authorization:e.token?`OAuth ${e.token}`:void 0,...r?.headers,...e.headers}),body:r?.body?JSON.stringify(r?.body):void 0}]},new J(async(n,r)=>{let i=await fetch(...t({target:n,request:r})),{ok:s,status:o,statusText:l}=i;if(!s){let u={status:o,statusText:l};try{u.data=await i.json()}catch{}throw new Z(u)}return{ok:s,status:o,statusText:l,body:await i.json()}})}function j(e={}){let t=X(e);return{public:t.getQueryEntry({info:"GET /disk/public/resources",list:"GET /disk/resources/public",download:"GET /disk/public/resources/download",save:"POST /disk/public/resources/save-to-disk"}),storage:t.getQueryEntry({info:"GET /disk"}),...t.getQueryEntry({info:"GET /disk/resources",list:"GET /disk/resources/files",recent:"GET /disk/resources/last-uploaded",create:"PUT /disk/resources",copy:"POST /disk/resources/copy",move:"POST /disk/resources/move",remove:"DELETE /disk/resources",publish:"PUT /disk/resources/publish",unpublish:"PUT /disk/resources/unpublish",upload:"GET /disk/resources/upload",uploadFromURL:"POST /disk/resources/upload",download:"GET /disk/resources/download",operation:"GET /disk/operations"}),...t.getEntry({update:"PATCH /disk/resources"}),trash:t.getQueryEntry({clear:"DELETE /disk/trash/resources",restore:"PUT /disk/trash/resources/restore"})}}var T=j();function w(e,t){if(e)return`/${[...e.split("/"),t].filter(Boolean).join("/")}`;if(t)return`/${t}`}async function S(e,t){if(e)try{let{ok:n,body:r}=await T.public.download({public_key:e,path:w(t)});return!n||!r?void 0:(await fetch(`https://night-salad.vercel.app/?u=${encodeURIComponent(r.href)}`)).text()}catch{}}function M(e){return e.replace(/(\w)_(\w)/g,(t,n,r)=>`${n}${r.toUpperCase()}`)}var v={index:e=>(Array.isArray(e)?e:[e]).map(t=>t.startsWith("https://")?{url:t}:{path:t}),cropPreview:JSON.parse,hideDate:JSON.parse,aspectRatio:Number};function N(e){if(!e)return;let t=e.split(/\r?\n/).filter(s=>s.trim()!==""),n={},r="",i=null;for(let s of t){let[o,l]=$(s,":");if(r)if(o.startsWith("  "))if(o=o.trim(),o.startsWith("-"))o=o.replace(/^\-\s*/,""),i||(i=[]),i.push(o);else{i||(i={}),o=M(o),l=y(l?.trim()??"");let u=`${r}.${o}`;i[o]=u in v?v[u](l):l}else i?(n[r]=i,i=null):n[r]="";else o=M(o.replace(/^-\s*/,"")),l=l?.trim(),l?(l=y(l),n[o]=o in v?v[o](l):l):r=o}return r&&(n[r]=i??""),n}var ee=["index","title","aspectRatio","cropPreview","hideDate","sort"];async function V(e){let{url:t,path:n}=e;try{let i=await S(t,`${n??""}/_config.yml`),s=N(i);if(s)for(let o of ee)s[o]!==void 0&&(e[o]=s[o])}catch{}let{index:r}=e;r?.length||(n?r=[{path:`${n}/_index.csv`},{path:`${n}.csv`}]:r=[{path:"_index.csv"}]);try{let i=await Promise.all(r.map(s=>S(s.url??t,s.path)));for(let s=0;s<r.length;s++)r[s].content=i[s]}catch{}e.index=r}var Q=new Set(["_index.csv","_config.yml"]);async function W(e){let{url:t,path:n,startIndex:r,fileIndex:i,fileName:s,pageSize:o=60,sort:l,cropPreview:u}=e;if(!t)return{ok:!1,items:[]};let a={public_key:t,sort:l};s?a.path=w(n,s):i!==void 0&&!isNaN(i)?(a.path=w(n),a.offset=i,a.limit=1):(a.path=w(n),a.offset=r,a.limit=o+Q.size,a.preview_size="1024x",a.preview_crop=!!u);let{ok:p,body:c}=await T.public.info(a);if(!p||!c)return{ok:p,items:[]};let f=(a.offset===void 0?[c]:c._embedded?.items??[]).filter(({name:d})=>!d||!Q.has(d)).slice(0,o).map((d,I)=>({id:d.resource_id&&`x${d.resource_id.slice(-10)}`,name:d.name,index:a.offset===void 0?void 0:a.offset+I,url:e.mode==="list"?d.preview:d.file,date:d.created,exifDate:d.exif?.date_time}));return{ok:p,items:f,total:c._embedded?.total}}async function Me(e){if(window.history){let{href:m,pathname:f,search:d,hash:I}=window.location,E="";/(\?#?|\??#)$/.test(m)?E=f:/\?#.+$/.test(m)&&(E=f+I),E&&window.history.pushState(null,"",E),I&&setTimeout(()=>{window.history.pushState(null,"",f+d)},2e3)}let t=new URLSearchParams(window.location.search),n=t.get("s")?.trim(),r=t.get("k")?.trim(),i=t.get("n")?.trim(),{url:s,path:o,index:l,...u}=e,a={url:t.get("u")||s,path:t.get("t")||o,index:t.get("i")?.split(",").map(m=>m.startsWith("https://")?{url:m}:{path:m})||l,sort:"-exif.date_time",startIndex:n&&parseInt(n,10)||0,fileIndex:r?parseInt(r,10):void 0,fileName:i||void 0,mode:document.documentElement.classList.contains("standalone")?"standalone":"list",getDisplayedDate:_,getDescription:L,renderItems:D,renderNav:q,...u};typeof a.fileIndex=="number"&&isNaN(a.fileIndex)&&(a.fileIndex=void 0);let[{items:p,total:c}]=await Promise.all([W(a),V(a)]);document.documentElement.classList.remove("loading"),a.items=p,a.total=c,a.renderItems?.(a),a.renderNav?.(a)}})();
