"use strict";(()=>{var M=Math.PI/180,K=180/Math.PI,j=3600*180/Math.PI;function Vt(){let e=(document.querySelector('form [name="p"]')?.value.trim()??"").split(/\s*[,;]\s*/),r=parseFloat(e[0])*M,n=parseFloat(e[1])*M;return e[0]?.endsWith("S")&&(r*=-1),e[1]?.endsWith("W")&&(n*=-1),{lat:r,lon:n}}function zt(){return document.querySelector('form [name="t"]')?.value.trim()}function et(){return{location:Vt(),time:zt()}}var b=class{phi;theta;r;constructor(e,r,n=1){this.phi=e,this.theta=r,this.r=n}};var{abs:X}=Math;function rt(t,e,r){return(t<0||e<0||r<0?-1:1)*(X(t)+X(e)/60+X(r)/3600)}var{floor:L}=Math;function R(t){t=t instanceof Date?t:new Date(t);let e=t.getUTCFullYear(),r=t.getUTCMonth()+1,n=t.getUTCDate(),l=t.getUTCHours(),o=t.getUTCMinutes(),i=t.getUTCSeconds();r<=2&&(r+=12,e--);let s;1e4*e+100*r+n<=15821004?s=-2+L((e+4716)/4)-1179:s=L(e/400)-L(e/100)+L(e/4);let m=365*e-679004+s+L(30.6001*(r+1))+n,u=rt(l,o,i)/24;return m+u}var{PI:Ft,floor:Gt}=Math,Q=86400,Nt=2*Ft;function nt(t){let e=R(t),r=Gt(e),n=Q*(e-r),l=(r-51544.5)/36525,o=(e-51544.5)/36525,i=24110.54841+8640184812866e-6*l+1.0027379093*n+(.093104-62e-7*o)*o*o;return Nt/Q*(i%Q)}var{PI:Ht,sqrt:ot,atan2:it,sin:lt,cos:st}=Math,C=class t{x;y;z;constructor(e=0,r=0,n=0){this.x=e,this.y=r,this.z=n}toPolar(){let{x:e,y:r,z:n}=this,l=e*e+r*r,o=ot(l+n*n),i=it(r,e),s=it(n,ot(l));return i<0&&(i+=2*Ht),new b(i,s,o)}static fromPolar(e){let{phi:r,theta:n,r:l}=e,o=l*st(n);return new t(o*st(r),o*lt(r),l*lt(n))}};function Jt(t,e){let r=0;for(let n=0,l=Math.min(t.length,e.length);n<l;n++)r+=t[n]*e[n];return r}var O=class t{value;rows;columns;constructor(e){this.value=e;let r=[];for(let n=0,l=e.length;n<l;n++)for(let o=0,i=e[n].length;o<i;o++)r[o]||(r[o]=new Array(l)),r[o][n]=e[n][o];this.rows=e,this.columns=r}multiplyByVec(e){return this.multiplyBy(t.fromVector(e)).toCartesianVector()}multiplyBy(e){let r=[];for(let n=0,l=this.rows.length;n<l;n++)for(let o=0,i=e.columns.length;o<i;o++)r[n]||(r[n]=new Array(i)),r[n][o]=Jt(this.rows[n],e.columns[o]);return new t(r)}toCartesianVector(){return new C(this.columns[0][0],this.columns[0][1],this.columns[0][2])}static fromVector(e){if(e instanceof C)return new t([[e.x],[e.y],[e.z]]);if(e instanceof b)return t.fromVector(C.fromPolar(e))}};var{sin:I,cos:V}=Math,P=class extends O{constructor(e){super([[1,0,0],[0,+V(e),+I(e)],[0,-I(e),+V(e)]])}},z=class extends O{constructor(e){super([[+V(e),0,-I(e)],[0,1,0],[+I(e),0,+V(e)]])}};function F({phi:t,theta:e},r,{lat:n,lon:l}){let o=nt(r)+l-t,i=new b(o,e);return new z(Math.PI/2-n).multiplyByVec(i).toPolar()}function y(t){return t-Math.floor(t)}var{sin:ut}=Math,Z=2*Math.PI;function G(t,e=0){let r=(R(t)-51544.5)/36525+e,n=Z*y(.993133+99.997361*r),l=Z*y(.7859453+n/Z+(6893*ut(n)+72*ut(2*n)+6191.2*r)/1296e3);return new b(l,0)}var Bt=23.43929111*M;function mt(t){let e=G(t);return new P(-Bt).multiplyByVec(e).toPolar()}function D(t,e){return F(mt(t),t,e)}var{sin:p}=Math,q=2*Math.PI;function N(t){let e=(R(t)-51544.5)/36525,r=y(.606433+1336.855225*e),n=q*y(.374897+1325.55241*e),l=q*y(.993133+99.997361*e),o=q*y(.827361+1236.853086*e),i=q*y(.259086+1342.227825*e),s=22640*p(n)-4586*p(n-2*o)+2370*p(2*o)+769*p(2*n)-668*p(l)-412*p(2*i)-212*p(2*n-2*o)-206*p(n+l-2*o)+192*p(n+2*o)-165*p(l-2*o)-125*p(o)-110*p(n+l)+148*p(n-l)-55*p(2*i-2*o),m=i+(s+412*p(2*i)+541*p(l))/j,u=i-2*o,c=-526*p(u)+44*p(n+u)-31*p(-n+u)-23*p(l+u)+11*p(-l+u)-25*p(-2*n+i)+21*p(-n+i);return new b(q*y(r+s/1296e3),(18520*p(m)+c)/j)}var Ut=23.43929111*M;function at(t){let e=N(t);return new P(-Ut).multiplyByVec(e).toPolar()}function E(t,e){return F(at(t),t,e)}var tt=2*Math.PI,Wt=-8.32/(1440*36525);function ct(t){return(N(t).phi-G(t,Wt).phi+tt)%tt/tt}var Yt=2*Math.PI,gt=1e3,J=60*gt,v=60*J;function S({phi:t,theta:e}){let r=(t+Math.PI)%Yt*K,n=e*K;return[r,n]}function Kt(t){return typeof t=="number"?t:t===void 0||t===""?Date.now():(t instanceof Date?t:new Date(t)).getTime()}var H=-.25;function pt(t,e){e.t>=e.t0&&t.time===null&&t.prevAlt!==null&&t.prevTime!==null&&Math.sign(e.alt-H)!==Math.sign(t.prevAlt-H)&&(Math.abs(e.alt-H)<Math.abs(t.prevAlt-H)?(t.time=e.t,t.alt=e.alt):(t.time=t.prevTime,t.alt=t.prevAlt),t.type=t.prevAlt<e.alt?"rise":"set"),t.prevAlt=e.alt,t.prevTime=e.t}var ft=-2.5*v,dt=22.5*v,ht={time:null,type:null,alt:null,prevAlt:null,prevTime:null};function bt(t,e){let r=Kt(e),n=[],l=[],o={...ht};for(let u=ft;u<dt;u+=J){let c=r+u,a=S(D(c,t));pt(o,{t0:r,t:c,alt:a[1]}),n.push(a),l.push(S(E(c,t)))}let i=o.time;if(i!==null){o={...ht};for(let u=-J;u<J;u+=gt){let c=i+u,a=S(D(c,t));pt(o,{t0:r,t:c,alt:a[1]})}}let s=[],m=[];for(let u=0;u>=ft;u-=v)s.push(S(D(r+u,t))),m.push(S(E(r+u,t)));for(let u=v;u<dt;u+=v)s.push(S(D(r+u,t))),m.push(S(E(r+u,t)));return{sun:{position:S(D(r,t)),track:n,ticks:s,next:{alt:o.alt,time:o.time,type:o.type}},moon:{position:S(E(r,t)),track:l,ticks:m,phase:ct(r)}}}function yt({location:t,time:e}){return!t||isNaN(t.lat)||isNaN(t.lon)?!1:e===void 0||e===""||typeof e=="number"?!0:!isNaN(new Date(e).getTime())}function St({element:t}){let e=t.parentElement;if(!e)return;t.setAttribute("style","display: none");let{width:r,height:n}=e.getBoundingClientRect();t.setAttribute("width",String(r)),t.setAttribute("height",String(n)),t.setAttribute("viewBox",`0 0 ${r} ${n}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}var B=null,xt="";function f({element:t}){let e=t.getAttribute("data-size");return e===xt&&B!==null||(B={width:Number(t.getAttribute("width")),height:Number(t.getAttribute("height"))},xt=e),B}var h="http://www.w3.org/2000/svg",x={default:20,sun:42},T=24,At=0,U=23.5/180*Math.PI;function Mt([t,e],r){let{width:n,height:l}=f(r),o=(r.location.lat<U?.5-t/n:t/n)*360,i=(.5-(e-T)/(l-2*T))*180;return o<0&&(o+=360),[o,i]}var jt=5,wt=["N","E","S","W"];function kt(t){let e=t.element.querySelector(".directions"),{width:r,height:n}=f(t),l=Array.from(e.querySelectorAll(".tick")),o=Array.from(e.querySelectorAll(".tick-label"));for(;l.length<5;){let i=document.createElementNS(h,"line");i.setAttribute("class","tick"),e.appendChild(i),l.push(i)}for(;o.length<5;){let i=document.createElementNS(h,"text");e.appendChild(i),o.push(i)}for(let i=0;i<l.length;i++){let s=l[i],m=i/4*r;s.setAttribute("x1",String(m)),s.setAttribute("y1",String(n/2-jt)),s.setAttribute("x2",String(m)),s.setAttribute("y2",String(n/2))}for(let i=0;i<o.length;i++){let s=o[i],m=i/4*r,[u]=Mt([m,0],t);s.setAttribute("x",String(m)),s.setAttribute("y",String(n/2+12)),s.textContent=wt[Math.floor(u/90)%wt.length],m<1?s.setAttribute("class","leftmost tick-label"):m>r-1?s.setAttribute("class","rightmost tick-label"):s.setAttribute("class","tick-label")}}function Xt(){return new Promise((t,e)=>{if(!navigator.geolocation)return e(new Error("Geolocation is not supported by the browser."));navigator.geolocation.getCurrentPosition(r=>{if(!r||!r.coords)return e(new Error("Failed to retrieve current location."));t({lat:r.coords.latitude,lon:r.coords.longitude})},()=>{e(new Error(`Failed to retrieve current location.
Make sure geolocation is enabled.`))})})}var Qt={p:"55.76\xB0 N, 37.62\xB0 E"};function Rt(){let t=new URLSearchParams(window.location.search);for(let r of["p","t"]){let n=(t.get(r)??"").trim(),l=document.querySelector(`form [name="${r}"]`);l instanceof HTMLInputElement&&(l.value=n||(Qt[r]??""))}let e=document.querySelector("#set-current-location");e&&e.addEventListener("click",()=>{Xt().then(r=>{let{searchParams:n}=new URL(window.location.href);n.set("p",`${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`),window.location.search=n.toString()}).catch(r=>{alert(r.message)})})}function g([t,e],r){let{width:n,height:l}=f(r),o=(r.location.lat<U?.5-t/360:t/360)*n,i=T+(.5-e/180)*(l-2*T);return o<0&&(o+=n),[o,i]}function Ct(t){let e=t.element.querySelector(".horizon"),{width:r,height:n}=f(t),l=[Array.from(e.querySelectorAll(".under")),Array.from(e.querySelectorAll(".above"))];for(let o=0;o<l.length;o++)for(;l[o].length<3;){let i=document.createElementNS(h,"rect");i.setAttribute("class",o===0?"under":"above"),i.setAttribute("x","0"),e.appendChild(i),l[o].push(i)}for(let o=0;o<3;o++){let i=l[0][o],s=l[1][o],m=g([0,-o*6],t)[1];i.setAttribute("y",String(m)),i.setAttribute("width",String(r)),i.setAttribute("height",String(n-m-At)),s.setAttribute("y","0"),s.setAttribute("width",String(r)),s.setAttribute("height",String(m))}}function Pt(t,e,r){let n=r.element.querySelector(`.markers [data-id="${e}"]`),l=x[e]??x.default,[o,i]=g(t,r);return n.setAttribute("data-id",e),n.setAttribute("x",String(o-l/2)),n.setAttribute("y",String(i-l/2)),n.setAttribute("width",String(l)),n.setAttribute("height",String(l)),n}function Dt(t){let{tracks:{sun:e,moon:r}}=t;Pt(e.position,"sun",t),Pt(r.position,"moon",t)}function Tt(t,e,r){let{width:n,height:l}=f(r),o=r.element.querySelector("g.marker-lines"),i=Array.from(o.querySelectorAll(`line[data-id="${e}"]`));for(;i.length<4;){let a=document.createElementNS(h,"line");a.setAttribute("data-id",e),o.appendChild(a),i.push(a)}let[s,m]=g(t,r),u=(x[e]??x.default)/2,c=[[[0,m],[s-u,m]],[[s+u,m],[n,m]],[[s,e==="sun"?0:l/2],[s,m-u]],[[s,m+u],[s,e==="sun"?l/2:l]]];for(let a=0;a<i.length;a++){let A=c[a][1][0]-c[a][0][0],Y=c[a][1][1]-c[a][0][1];A<1&&Y<1?i[a].setAttribute("class","hidden"):i[a].hasAttribute("class")&&i[a].removeAttribute("class"),i[a].setAttribute("x1",String(c[a][0][0])),i[a].setAttribute("y1",String(c[a][0][1])),i[a].setAttribute("x2",String(c[a][1][0])),i[a].setAttribute("y2",String(c[a][1][1]))}}function Lt(t){let{tracks:{sun:e,moon:r}}=t;Tt(e.position,"sun",t),Tt(r.position,"moon",t)}var w=x.moon??x.default,d=w/2;function Ot(t){let e=t.element.querySelector("g.markers"),r=e.querySelector('[data-id="moon-phase"]');r||(r=document.createElementNS(h,"svg"),r.setAttribute("data-id","moon-phase"),r.setAttribute("viewBox",`0 0 ${w} ${w}`),r.setAttribute("width",String(w)),r.setAttribute("height",String(w)),e.appendChild(r));let n=r.querySelector("path");n||(n=document.createElementNS(h,"path"),n.setAttribute("class","phase-shadow"),r.appendChild(n));let{position:l,phase:o}=t.tracks.moon;o>=1&&(o-=1);let i=Math.floor(o/.25),s=d*(o%.25/.25),m,u,c,a;switch(i){case 0:m=d,c=1,u=d-s,a=1;break;case 1:m=d,c=1,u=s,a=0;break;case 2:m=d-s,c=0,u=d,a=1;break;default:m=s,c=1,u=d,a=1}n.setAttribute("d",`M ${d},${w} A ${m} ${d} 180 0 ${c} ${d},0 A ${u} ${d} 180 0 ${a} ${d},${w}`);let[A,Y]=g(l,t);r.setAttribute("x",String(A-d)),r.setAttribute("y",String(Y-d))}function qt(t,e){let{width:r}=f(e),n=document.querySelector(`.pos[data-id="${t}"]`),{position:l}=e.tracks[t];if(n.querySelector(".az .value").textContent=`${l[0].toFixed(1)}\xB0`,n.querySelector(".h .value").textContent=`${l[1].toFixed(1)}\xB0`,t==="moon")n.querySelector(".ph .value").textContent=`${Math.round(e.tracks.moon.phase*100)}%`;else if(t==="sun"){let{next:s}=e.tracks.sun;if(s.time!==null&&s.type!==null){let m=new Date(s.time);n.querySelector(".next .value").textContent=`${String(m.getHours()).padStart(2,"0")}:${String(m.getMinutes()).padStart(2,"0")}`,n.querySelector(".next .type").textContent=s.type==="rise"?"Rise":"Set"}}let[o]=g(l,e),{width:i}=n.querySelector("span").getBoundingClientRect();n.style.setProperty("--x",`${Math.min(o-6,r-i)}px`)}function Et(t){qt("sun",t),qt("moon",t)}function vt(t,e,r){let{width:n,height:l}=f(r),o=document.createElementNS(h,"path"),i="",s=null,m=null;for(let u=0;u<t.length;u++){let c=i?" L":"M",[a,A]=g(t[u],r);(s!==null&&Math.abs(a-s)>.95*n||m!==null&&Math.abs(A-m)>.95*l)&&(c=" M"),i+=`${c}${a},${A}`,s=a,m=A}return o.setAttribute("d",i),o.setAttribute("class","track"),o.setAttribute("data-id",e),o}function $t(t,e,r){let n=document.createDocumentFragment();for(let l of t){let o=document.createElementNS(h,"circle"),[i,s]=g(l,r);o.setAttribute("cx",String(i)),o.setAttribute("cy",String(s)),o.setAttribute("r","1.5"),o.setAttribute("class","tick"),o.setAttribute("data-id",e),n.appendChild(o)}return n}function It(t){let{element:e,tracks:{sun:r,moon:n}}=t,l=e.querySelector("g.tracks");l.innerHTML="",l.appendChild(vt(r.track,"sun",t)),l.appendChild($t(r.ticks,"sun",t)),l.appendChild(vt(n.track,"moon",t)),l.appendChild($t(n.ticks,"moon",t))}var $=null,k=null;function W(t){if(!k&&(Rt(),k=et(),!yt(k))){document.documentElement.classList.add("error");return}let e={...k,element:document.querySelector("#screen svg"),tracks:bt(k.location,k.time)};St(e),Ct(e),kt(e),It(e),Dt(e),Lt(e),Et(e),Ot(e),t&&!k.time&&($!==null&&clearTimeout($),$=setTimeout(()=>W(!0),15e3))}function Zt(){let t=null;window.addEventListener("resize",()=>{t!==null&&clearTimeout(t),t=setTimeout(()=>W(),200)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?W(!0):$!==null&&clearTimeout($)}),W(!0)}Zt();})();
