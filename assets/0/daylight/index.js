"use strict";(()=>{var M=Math.PI/180,K=180/Math.PI,j=3600*180/Math.PI;function Vt(){let t=(document.querySelector('form [name="p"]')?.value.trim()??"").split(/\s*[,;]\s*/),r=parseFloat(t[0])*M,n=parseFloat(t[1])*M;return t[0]?.endsWith("S")&&(r*=-1),t[1]?.endsWith("W")&&(n*=-1),{lat:r,lon:n}}function zt(){return document.querySelector('form [name="t"]')?.value.trim()}function et(){return{location:Vt(),time:zt()}}var y=class{phi;theta;r;constructor(t,r,n=1){this.phi=t,this.theta=r,this.r=n}};var{abs:X}=Math;function rt(e,t,r){return(e<0||t<0||r<0?-1:1)*(X(e)+X(t)/60+X(r)/3600)}var{floor:O}=Math;function k(e){e=e instanceof Date?e:new Date(e);let t=e.getUTCFullYear(),r=e.getUTCMonth()+1,n=e.getUTCDate(),s=e.getUTCHours(),o=e.getUTCMinutes(),i=e.getUTCSeconds();r<=2&&(r+=12,t--);let m;1e4*t+100*r+n<=15821004?m=-2+O((t+4716)/4)-1179:m=O(t/400)-O(t/100)+O(t/4);let l=365*t-679004+m+O(30.6001*(r+1))+n,a=rt(s,o,i)/24;return l+a}var{PI:Ft,floor:Gt}=Math,Q=86400,Nt=2*Ft;function nt(e){let t=k(e),r=Gt(t),n=Q*(t-r),s=(r-51544.5)/36525,o=(t-51544.5)/36525,i=24110.54841+8640184812866e-6*s+1.0027379093*n+(.093104-62e-7*o)*o*o;return Nt/Q*(i%Q)}var{PI:Ht,sqrt:ot,atan2:it,sin:st,cos:lt}=Math,C=class e{x;y;z;constructor(t=0,r=0,n=0){this.x=t,this.y=r,this.z=n}toPolar(){let{x:t,y:r,z:n}=this,s=t*t+r*r,o=ot(s+n*n),i=it(r,t),m=it(n,ot(s));return i<0&&(i+=2*Ht),new y(i,m,o)}static fromPolar(t){let{phi:r,theta:n,r:s}=t,o=s*lt(n);return new e(o*lt(r),o*st(r),s*st(n))}};function Jt(e,t){let r=0;for(let n=0,s=Math.min(e.length,t.length);n<s;n++)r+=e[n]*t[n];return r}var E=class e{value;rows;columns;constructor(t){this.value=t;let r=[];for(let n=0,s=t.length;n<s;n++)for(let o=0,i=t[n].length;o<i;o++)r[o]||(r[o]=new Array(s)),r[o][n]=t[n][o];this.rows=t,this.columns=r}multiplyByVec(t){return this.multiplyBy(e.fromVector(t)).toCartesianVector()}multiplyBy(t){let r=[];for(let n=0,s=this.rows.length;n<s;n++)for(let o=0,i=t.columns.length;o<i;o++)r[n]||(r[n]=new Array(i)),r[n][o]=Jt(this.rows[n],t.columns[o]);return new e(r)}toCartesianVector(){return new C(this.columns[0][0],this.columns[0][1],this.columns[0][2])}static fromVector(t){if(t instanceof C)return new e([[t.x],[t.y],[t.z]]);if(t instanceof y)return e.fromVector(C.fromPolar(t))}};var{sin:z,cos:F}=Math,T=class extends E{constructor(t){super([[1,0,0],[0,+F(t),+z(t)],[0,-z(t),+F(t)]])}},G=class extends E{constructor(t){super([[+F(t),0,-z(t)],[0,1,0],[+z(t),0,+F(t)]])}};function N({phi:e,theta:t},r,{lat:n,lon:s}){let o=nt(r)+s-e,i=new y(o,t);return new G(Math.PI/2-n).multiplyByVec(i).toPolar()}function S(e){return e-Math.floor(e)}var{sin:mt}=Math,Z=2*Math.PI;function H(e,t=0){let r=(k(e)-51544.5)/36525+t,n=Z*S(.993133+99.997361*r),s=Z*S(.7859453+n/Z+(6893*mt(n)+72*mt(2*n)+6191.2*r)/1296e3);return new y(s,0)}var Bt=23.43929111*M;function ut(e){let t=H(e);return new T(-Bt).multiplyByVec(t).toPolar()}function P(e,t){return N(ut(e),e,t)}var{sin:p}=Math,q=2*Math.PI;function J(e){let t=(k(e)-51544.5)/36525,r=S(.606433+1336.855225*t),n=q*S(.374897+1325.55241*t),s=q*S(.993133+99.997361*t),o=q*S(.827361+1236.853086*t),i=q*S(.259086+1342.227825*t),m=22640*p(n)-4586*p(n-2*o)+2370*p(2*o)+769*p(2*n)-668*p(s)-412*p(2*i)-212*p(2*n-2*o)-206*p(n+s-2*o)+192*p(n+2*o)-165*p(s-2*o)-125*p(o)-110*p(n+s)+148*p(n-s)-55*p(2*i-2*o),l=i+(m+412*p(2*i)+541*p(s))/j,a=i-2*o,c=-526*p(a)+44*p(n+a)-31*p(-n+a)-23*p(s+a)+11*p(-s+a)-25*p(-2*n+i)+21*p(-n+i);return new y(q*S(r+m/1296e3),(18520*p(l)+c)/j)}var Ut=23.43929111*M;function at(e){let t=J(e);return new T(-Ut).multiplyByVec(t).toPolar()}function $(e,t){return N(at(e),e,t)}var tt=2*Math.PI,Wt=-8.32/(1440*36525);function ct(e){return(J(e).phi-H(e,Wt).phi+tt)%tt/tt}var Yt=2*Math.PI,gt=1e3,I=60*gt,D=60*I;function x({phi:e,theta:t}){let r=(e+Math.PI)%Yt*K,n=t*K;return[r,n]}function Kt(e){return typeof e=="number"?e:e===void 0||e===""?Date.now():(e instanceof Date?e:new Date(e)).getTime()}var B=-.25;function pt(e,t){if((e.refTime===null||t.time>=e.refTime)&&e.prevAlt!==null&&e.prevTime!==null&&Math.sign(t.alt-B)!==Math.sign(e.prevAlt-B)){let r=Math.abs(e.prevAlt-B)<Math.abs(t.alt-B),n={time:r?e.prevTime:t.time,alt:r?e.prevAlt:t.alt,type:e.prevAlt<t.alt?"rise":"set"};e.events.push(n),e.refTime=n.time}e.prevAlt=t.alt,e.prevTime=t.time}var ft=-2.5*D,dt=22.5*D,jt=25*D,ht={refTime:null,prevAlt:null,prevTime:null};function bt(e,t){let r=Kt(t),n=[],s=[],o={...ht,refTime:r-5*I,events:[]};for(let l=ft;l<jt;l+=I){let a=r+l,c=x(P(a,e));pt(o,{time:a,alt:c[1]}),l<dt&&(n.push(c),s.push(x($(a,e))))}for(let l of o.events){let a={...ht,events:[]};for(let u=-I;u<I;u+=gt){let b=l.time+u,L=x(P(b,e));pt(a,{time:b,alt:L[1]})}let c=a.events[0];c&&(l.time=c.time,l.alt=c.alt)}let i=[],m=[];for(let l=0;l>=ft;l-=D)i.push(x(P(r+l,e))),m.push(x($(r+l,e)));for(let l=D;l<dt;l+=D)i.push(x(P(r+l,e))),m.push(x($(r+l,e)));return{sun:{position:x(P(r,e)),track:n,ticks:i,events:o.events},moon:{position:x($(r,e)),track:s,ticks:m,phase:ct(r)}}}function yt({location:e,time:t}){return!e||isNaN(e.lat)||isNaN(e.lon)?!1:t===void 0||t===""||typeof t=="number"?!0:!isNaN(new Date(t).getTime())}function St({element:e}){let t=e.parentElement;if(!t)return;e.setAttribute("style","display: none");let{width:r,height:n}=t.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(n)),e.setAttribute("viewBox",`0 0 ${r} ${n}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}var U=null,xt="";function f({element:e}){let t=e.getAttribute("data-size");return t===xt&&U!==null||(U={width:Number(e.getAttribute("width")),height:Number(e.getAttribute("height"))},xt=t),U}var h="http://www.w3.org/2000/svg",A={default:20,sun:42},v=24,At=0,W=23.5/180*Math.PI;function Mt([e,t],r){let{width:n,height:s}=f(r),o=(r.location.lat<W?.5-e/n:e/n)*360,i=(.5-(t-v)/(s-2*v))*180;return o<0&&(o+=360),[o,i]}var Xt=5,wt=["N","E","S","W"];function Rt(e){let t=e.element.querySelector(".directions"),{width:r,height:n}=f(e),s=Array.from(t.querySelectorAll(".tick")),o=Array.from(t.querySelectorAll(".tick-label"));for(;s.length<5;){let i=document.createElementNS(h,"line");i.setAttribute("class","tick"),t.appendChild(i),s.push(i)}for(;o.length<5;){let i=document.createElementNS(h,"text");t.appendChild(i),o.push(i)}for(let i=0;i<s.length;i++){let m=s[i],l=i/4*r;m.setAttribute("x1",String(l)),m.setAttribute("y1",String(n/2-Xt)),m.setAttribute("x2",String(l)),m.setAttribute("y2",String(n/2))}for(let i=0;i<o.length;i++){let m=o[i],l=i/4*r,[a]=Mt([l,0],e);m.setAttribute("x",String(l)),m.setAttribute("y",String(n/2+12)),m.textContent=wt[Math.floor(a/90)%wt.length],l<1?m.setAttribute("class","leftmost tick-label"):l>r-1?m.setAttribute("class","rightmost tick-label"):m.setAttribute("class","tick-label")}}function Qt(){return new Promise((e,t)=>{if(!navigator.geolocation)return t(new Error("Geolocation is not supported by the browser."));navigator.geolocation.getCurrentPosition(r=>{if(!r||!r.coords)return t(new Error("Failed to retrieve current location."));e({lat:r.coords.latitude,lon:r.coords.longitude})},()=>{t(new Error(`Failed to retrieve current location.
Make sure geolocation is enabled.`))})})}var Zt={p:"55.76\xB0 N, 37.62\xB0 E"};function kt(){let e=new URLSearchParams(window.location.search);for(let r of["p","t"]){let n=(e.get(r)??"").trim(),s=document.querySelector(`form [name="${r}"]`);s instanceof HTMLInputElement&&(s.value=n||(Zt[r]??""))}let t=document.querySelector("#set-current-location");t&&t.addEventListener("click",()=>{Qt().then(r=>{let{searchParams:n}=new URL(window.location.href);n.set("p",`${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`),window.location.search=n.toString()}).catch(r=>{alert(r.message)})})}function g([e,t],r){let{width:n,height:s}=f(r),o=(r.location.lat<W?.5-e/360:e/360)*n,i=v+(.5-t/180)*(s-2*v);return o<0&&(o+=n),[o,i]}function Ct(e){let t=e.element.querySelector(".horizon"),{width:r,height:n}=f(e),s=[Array.from(t.querySelectorAll(".under")),Array.from(t.querySelectorAll(".above"))];for(let o=0;o<s.length;o++)for(;s[o].length<3;){let i=document.createElementNS(h,"rect");i.setAttribute("class",o===0?"under":"above"),i.setAttribute("x","0"),t.appendChild(i),s[o].push(i)}for(let o=0;o<3;o++){let i=s[0][o],m=s[1][o],l=g([0,-o*6],e)[1];i.setAttribute("y",String(l)),i.setAttribute("width",String(r)),i.setAttribute("height",String(n-l-At)),m.setAttribute("y","0"),m.setAttribute("width",String(r)),m.setAttribute("height",String(l))}}function Tt(e,t,r){let n=r.element.querySelector(`.markers [data-id="${t}"]`),s=A[t]??A.default,[o,i]=g(e,r);return n.setAttribute("data-id",t),n.setAttribute("x",String(o-s/2)),n.setAttribute("y",String(i-s/2)),n.setAttribute("width",String(s)),n.setAttribute("height",String(s)),n}function Pt(e){let{tracks:{sun:t,moon:r}}=e;Tt(t.position,"sun",e),Tt(r.position,"moon",e)}function Dt(e,t,r){let{width:n,height:s}=f(r),o=r.element.querySelector("g.marker-lines"),i=Array.from(o.querySelectorAll(`line[data-id="${t}"]`));for(;i.length<4;){let u=document.createElementNS(h,"line");u.setAttribute("data-id",t),o.appendChild(u),i.push(u)}let[m,l]=g(e,r),a=(A[t]??A.default)/2,c=[[[0,l],[m-a,l]],[[m+a,l],[n,l]],[[m,t==="sun"?0:s/2],[m,l-a]],[[m,l+a],[m,t==="sun"?s/2:s]]];for(let u=0;u<i.length;u++){let b=c[u][1][0]-c[u][0][0],L=c[u][1][1]-c[u][0][1];b<1&&L<1?i[u].setAttribute("class","hidden"):i[u].hasAttribute("class")&&i[u].removeAttribute("class"),i[u].setAttribute("x1",String(c[u][0][0])),i[u].setAttribute("y1",String(c[u][0][1])),i[u].setAttribute("x2",String(c[u][1][0])),i[u].setAttribute("y2",String(c[u][1][1]))}}function vt(e){let{tracks:{sun:t,moon:r}}=e;Dt(t.position,"sun",e),Dt(r.position,"moon",e)}var w=A.moon??A.default,d=w/2;function Lt(e){let t=e.element.querySelector("g.markers"),r=t.querySelector('[data-id="moon-phase"]');r||(r=document.createElementNS(h,"svg"),r.setAttribute("data-id","moon-phase"),r.setAttribute("viewBox",`0 0 ${w} ${w}`),r.setAttribute("width",String(w)),r.setAttribute("height",String(w)),t.appendChild(r));let n=r.querySelector("path");n||(n=document.createElementNS(h,"path"),n.setAttribute("class","phase-shadow"),r.appendChild(n));let{position:s,phase:o}=e.tracks.moon;o>=1&&(o-=1);let i=Math.floor(o/.25),m=d*(o%.25/.25),l,a,c,u;switch(i){case 0:l=d,c=1,a=d-m,u=1;break;case 1:l=d,c=1,a=m,u=0;break;case 2:l=d-m,c=0,a=d,u=1;break;default:l=m,c=1,a=d,u=1}n.setAttribute("d",`M ${d},${w} A ${l} ${d} 180 0 ${c} ${d},0 A ${a} ${d} 180 0 ${u} ${d},${w}`);let[b,L]=g(s,e);r.setAttribute("x",String(b-d)),r.setAttribute("y",String(L-d))}function Ot(e,t){let{width:r}=f(t),n=document.querySelector(`.pos[data-id="${e}"]`),{position:s}=t.tracks[e];if(n.querySelector(".az .value").textContent=`${s[0].toFixed(1)}\xB0`,n.querySelector(".alt .value").textContent=`${s[1].toFixed(1)}\xB0`,e==="moon")n.querySelector(".ph .value").textContent=`${Math.round(t.tracks.moon.phase*100)}%`;else if(e==="sun"){let m=t.tracks.sun.events.slice(0,2),l="";for(let{time:a,type:c}of m){let u=new Date(a),b=`${String(u.getHours()).padStart(2,"0")}:${String(u.getMinutes()).padStart(2,"0")}`;l+=`${l?" ":""}<span class="event"><span class="type">${c==="rise"?"Rise":"Set"}</span> <span class="value">${b}</span></span>`}n.querySelector(".events").innerHTML=l}let[o]=g(s,t),{width:i}=n.querySelector("span").getBoundingClientRect();n.style.setProperty("--x",`${Math.min(o-6,r-i)}px`)}function Et(e){Ot("sun",e),Ot("moon",e)}function qt(e,t,r){let{width:n,height:s}=f(r),o=document.createElementNS(h,"path"),i="",m=null,l=null;for(let a=0;a<e.length;a++){let c=i?" L":"M",[u,b]=g(e[a],r);(m!==null&&Math.abs(u-m)>.95*n||l!==null&&Math.abs(b-l)>.95*s)&&(c=" M"),i+=`${c}${u},${b}`,m=u,l=b}return o.setAttribute("d",i),o.setAttribute("class","track"),o.setAttribute("data-id",t),o}function $t(e,t,r){let n=document.createDocumentFragment();for(let s of e){let o=document.createElementNS(h,"circle"),[i,m]=g(s,r);o.setAttribute("cx",String(i)),o.setAttribute("cy",String(m)),o.setAttribute("r","1.5"),o.setAttribute("class","tick"),o.setAttribute("data-id",t),n.appendChild(o)}return n}function It(e){let{element:t,tracks:{sun:r,moon:n}}=e,s=t.querySelector("g.tracks");s.innerHTML="",s.appendChild(qt(r.track,"sun",e)),s.appendChild($t(r.ticks,"sun",e)),s.appendChild(qt(n.track,"moon",e)),s.appendChild($t(n.ticks,"moon",e))}var V=null,R=null;function Y(e){if(!R&&(kt(),R=et(),!yt(R))){document.documentElement.classList.add("error");return}let t={...R,element:document.querySelector("#screen svg"),tracks:bt(R.location,R.time)};St(t),Ct(t),Rt(t),It(t),Pt(t),vt(t),Et(t),Lt(t),e&&!R.time&&(V!==null&&clearTimeout(V),V=setTimeout(()=>Y(!0),15e3))}function _t(){let e=null;window.addEventListener("resize",()=>{e!==null&&clearTimeout(e),e=setTimeout(()=>Y(),200)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?Y(!0):V!==null&&clearTimeout(V)}),Y(!0)}_t();})();
