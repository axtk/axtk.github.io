"use strict";(()=>{var w=Math.PI/180,J=180/Math.PI,B=3600*180/Math.PI;function Tt(){let t=(document.querySelector('form [name="p"]')?.value.trim()??"").split(/\s*[,;]\s*/),r=parseFloat(t[0])*w,o=parseFloat(t[1])*w;return t[0]?.endsWith("S")&&(r*=-1),t[1]?.endsWith("W")&&(o*=-1),{lat:r,lon:o}}function Et(){return document.querySelector('form [name="t"]')?.value.trim()}function Q(){return{location:Tt(),time:Et()}}var b=class{phi;theta;r;constructor(t,r,o=1){this.phi=t,this.theta=r,this.r=o}};var{abs:U}=Math;function Z(e,t,r){return(e<0||t<0||r<0?-1:1)*(U(e)+U(t)/60+U(r)/3600)}var{floor:C}=Math;function k(e){e=e instanceof Date?e:new Date(e);let t=e.getUTCFullYear(),r=e.getUTCMonth()+1,o=e.getUTCDate(),i=e.getUTCHours(),n=e.getUTCMinutes(),s=e.getUTCSeconds();r<=2&&(r+=12,t--);let l;1e4*t+100*r+o<=15821004?l=-2+C((t+4716)/4)-1179:l=C(t/400)-C(t/100)+C(t/4);let u=365*t-679004+l+C(30.6001*(r+1))+o,a=Z(i,n,s)/24;return u+a}var{PI:qt,floor:Vt}=Math,W=86400,$t=2*qt;function _(e){let t=k(e),r=Vt(t),o=W*(t-r),i=(r-51544.5)/36525,n=(t-51544.5)/36525,s=24110.54841+8640184812866e-6*i+1.0027379093*o+(.093104-62e-7*n)*n*n;return $t/W*(s%W)}var{PI:It,sqrt:tt,atan2:et,sin:rt,cos:ot}=Math,D=class e{x;y;z;constructor(t=0,r=0,o=0){this.x=t,this.y=r,this.z=o}toPolar(){let{x:t,y:r,z:o}=this,i=t*t+r*r,n=tt(i+o*o),s=et(r,t),l=et(o,tt(i));return s<0&&(s+=2*It),new b(s,l,n)}static fromPolar(t){let{phi:r,theta:o,r:i}=t,n=i*ot(o);return new e(n*ot(r),n*rt(r),i*rt(o))}};function zt(e,t){let r=0;for(let o=0,i=Math.min(e.length,t.length);o<i;o++)r+=e[o]*t[o];return r}var O=class e{value;rows;columns;constructor(t){this.value=t;let r=[];for(let o=0,i=t.length;o<i;o++)for(let n=0,s=t[o].length;n<s;n++)r[n]||(r[n]=new Array(i)),r[n][o]=t[o][n];this.rows=t,this.columns=r}multiplyByVec(t){return this.multiplyBy(e.fromVector(t)).toCartesianVector()}multiplyBy(t){let r=[];for(let o=0,i=this.rows.length;o<i;o++)for(let n=0,s=t.columns.length;n<s;n++)r[o]||(r[o]=new Array(s)),r[o][n]=zt(this.rows[o],t.columns[n]);return new e(r)}toCartesianVector(){return new D(this.columns[0][0],this.columns[0][1],this.columns[0][2])}static fromVector(t){if(t instanceof D)return new e([[t.x],[t.y],[t.z]]);if(t instanceof b)return e.fromVector(D.fromPolar(t))}};var{sin:V,cos:$}=Math,P=class extends O{constructor(t){super([[1,0,0],[0,+$(t),+V(t)],[0,-V(t),+$(t)]])}},I=class extends O{constructor(t){super([[+$(t),0,-V(t)],[0,1,0],[+V(t),0,+$(t)]])}};function z({phi:e,theta:t},r,{lat:o,lon:i}){let n=_(r)+i-e,s=new b(n,t);return new I(Math.PI/2-o).multiplyByVec(s).toPolar()}function y(e){return e-Math.floor(e)}var{sin:nt}=Math,Y=2*Math.PI;function G(e,t=0){let r=(k(e)-51544.5)/36525+t,o=Y*y(.993133+99.997361*r),i=Y*y(.7859453+o/Y+(6893*nt(o)+72*nt(2*o)+6191.2*r)/1296e3);return new b(i,0)}var Gt=23.43929111*w;function it(e){let t=G(e);return new P(-Gt).multiplyByVec(t).toPolar()}function L(e,t){return z(it(e),e,t)}var{sin:c}=Math,T=2*Math.PI;function F(e){let t=(k(e)-51544.5)/36525,r=y(.606433+1336.855225*t),o=T*y(.374897+1325.55241*t),i=T*y(.993133+99.997361*t),n=T*y(.827361+1236.853086*t),s=T*y(.259086+1342.227825*t),l=22640*c(o)-4586*c(o-2*n)+2370*c(2*n)+769*c(2*o)-668*c(i)-412*c(2*s)-212*c(2*o-2*n)-206*c(o+i-2*n)+192*c(o+2*n)-165*c(i-2*n)-125*c(n)-110*c(o+i)+148*c(o-i)-55*c(2*s-2*n),u=s+(l+412*c(2*s)+541*c(i))/B,a=s-2*n,p=-526*c(a)+44*c(o+a)-31*c(-o+a)-23*c(i+a)+11*c(-i+a)-25*c(-2*o+s)+21*c(-o+s);return new b(T*y(r+l/1296e3),(18520*c(u)+p)/B)}var Ft=23.43929111*w;function st(e){let t=F(e);return new P(-Ft).multiplyByVec(t).toPolar()}function E(e,t){return z(st(e),e,t)}var j=2*Math.PI,Nt=-8.32/(1440*36525);function lt(e){return(F(e).phi-G(e,Nt).phi+j)%j/j}var vt=2*Math.PI,at=6e4,q=60*at;function S({phi:e,theta:t}){let r=(e+Math.PI)%vt*J,o=t*J;return[r,o]}function Ht(e){return typeof e=="number"?e:e===void 0||e===""?Date.now():(e instanceof Date?e:new Date(e)).getTime()}var mt=-2.5*q,ut=22.5*q;function ct(e,t){let r=Ht(t),o=[],i=[];for(let l=mt;l<ut;l+=at)o.push(S(L(r+l,e))),i.push(S(E(r+l,e)));let n=[],s=[];for(let l=0;l>=mt;l-=q)n.push(S(L(r+l,e))),s.push(S(E(r+l,e)));for(let l=q;l<ut;l+=q)n.push(S(L(r+l,e))),s.push(S(E(r+l,e)));return{sun:{position:S(L(r,e)),track:o,ticks:n},moon:{position:S(E(r,e)),track:i,ticks:s,phase:lt(r)}}}function pt({location:e,time:t}){return!e||isNaN(e.lat)||isNaN(e.lon)?!1:t===void 0||t===""||typeof t=="number"?!0:!isNaN(new Date(t).getTime())}function ft({element:e}){let t=e.parentElement;if(!t)return;e.setAttribute("style","display: none");let{width:r,height:o}=t.getBoundingClientRect();e.setAttribute("width",String(r)),e.setAttribute("height",String(o)),e.setAttribute("viewBox",`0 0 ${r} ${o}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}var N=null,dt="";function f({element:e}){let t=e.getAttribute("data-size");return t===dt&&N!==null||(N={width:Number(e.getAttribute("width")),height:Number(e.getAttribute("height"))},dt=t),N}var h="http://www.w3.org/2000/svg",x={default:20,sun:42},R=24,ht=0,v=23.5/180*Math.PI;function gt([e,t],r){let{width:o,height:i}=f(r),n=(r.location.lat<v?.5-e/o:e/o)*360,s=(.5-(t-R)/(i-2*R))*180;return n<0&&(n+=360),[n,s]}var Jt=5,bt=["N","E","S","W"];function yt(e){let t=e.element.querySelector(".directions"),{width:r,height:o}=f(e),i=Array.from(t.querySelectorAll(".tick")),n=Array.from(t.querySelectorAll(".tick-label"));for(;i.length<5;){let s=document.createElementNS(h,"line");s.setAttribute("class","tick"),t.appendChild(s),i.push(s)}for(;n.length<5;){let s=document.createElementNS(h,"text");t.appendChild(s),n.push(s)}for(let s=0;s<i.length;s++){let l=i[s],u=s/4*r;l.setAttribute("x1",String(u)),l.setAttribute("y1",String(o/2-Jt)),l.setAttribute("x2",String(u)),l.setAttribute("y2",String(o/2))}for(let s=0;s<n.length;s++){let l=n[s],u=s/4*r,[a]=gt([u,0],e);l.setAttribute("x",String(u)),l.setAttribute("y",String(o/2+12)),l.textContent=bt[Math.floor(a/90)%bt.length],u<1?l.setAttribute("class","leftmost tick-label"):u>r-1?l.setAttribute("class","rightmost tick-label"):l.setAttribute("class","tick-label")}}function Bt(){return new Promise((e,t)=>{if(!navigator.geolocation)return t(new Error("Geolocation is not supported by the browser."));navigator.geolocation.getCurrentPosition(r=>{if(!r||!r.coords)return t(new Error("Failed to retrieve current location."));e({lat:r.coords.latitude,lon:r.coords.longitude})},()=>{t(new Error(`Failed to retrieve current location.
Make sure geolocation is enabled.`))})})}var Ut={p:"55.76\xB0 N, 37.62\xB0 E"};function xt(){let e=new URLSearchParams(window.location.search);for(let r of["p","t"]){let o=(e.get(r)??"").trim(),i=document.querySelector(`form [name="${r}"]`);i instanceof HTMLInputElement&&(i.value=o||(Ut[r]??""))}let t=document.querySelector("#set-current-location");t&&t.addEventListener("click",()=>{Bt().then(r=>{let{searchParams:o}=new URL(window.location.href);o.set("p",`${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`),window.location.search=o.toString()}).catch(r=>{alert(r.message)})})}function g([e,t],r){let{width:o,height:i}=f(r),n=(r.location.lat<v?.5-e/360:e/360)*o,s=R+(.5-t/180)*(i-2*R);return n<0&&(n+=o),[n,s]}function St(e){let t=e.element.querySelector(".horizon"),{width:r,height:o}=f(e),i=Array.from(t.querySelectorAll(".twilight"));for(;i.length<3;){let n=document.createElementNS(h,"rect");n.setAttribute("class","twilight"),n.setAttribute("x","0"),t.appendChild(n),i.push(n)}for(let n=0;n<i.length;n++){let s=i[n],l=g([0,-n*6],e)[1];s.setAttribute("y",String(l)),s.setAttribute("width",String(r)),s.setAttribute("height",String(o-l-ht))}}function At(e,t,r){let o=r.element.querySelector(`.markers [data-id="${t}"]`),i=x[t]??x.default,[n,s]=g(e,r);return o.setAttribute("data-id",t),o.setAttribute("x",String(n-i/2)),o.setAttribute("y",String(s-i/2)),o.setAttribute("width",String(i)),o.setAttribute("height",String(i)),o}function wt(e){let{tracks:{sun:t,moon:r}}=e;At(t.position,"sun",e),At(r.position,"moon",e)}function Mt(e,t,r){let{width:o,height:i}=f(r),n=r.element.querySelector("g.marker-lines"),s=Array.from(n.querySelectorAll(`line[data-id="${t}"]`));for(;s.length<4;){let m=document.createElementNS(h,"line");m.setAttribute("data-id",t),n.appendChild(m),s.push(m)}let[l,u]=g(e,r),a=(x[t]??x.default)/2,p=[[[0,u],[l-a,u]],[[l+a,u],[o,u]],[[l,t==="sun"?0:i/2],[l,u-a]],[[l,u+a],[l,t==="sun"?i/2:i]]];for(let m=0;m<s.length;m++){let A=p[m][1][0]-p[m][0][0],H=p[m][1][1]-p[m][0][1];A<1&&H<1?s[m].setAttribute("class","hidden"):s[m].hasAttribute("class")&&s[m].removeAttribute("class"),s[m].setAttribute("x1",String(p[m][0][0])),s[m].setAttribute("y1",String(p[m][0][1])),s[m].setAttribute("x2",String(p[m][1][0])),s[m].setAttribute("y2",String(p[m][1][1]))}}function kt(e){let{tracks:{sun:t,moon:r}}=e;Mt(t.position,"sun",e),Mt(r.position,"moon",e)}var M=x.moon??x.default,d=M/2;function Dt(e){let t=e.element.querySelector("g.markers"),r=t.querySelector('[data-id="moon-phase"]');r||(r=document.createElementNS(h,"svg"),r.setAttribute("data-id","moon-phase"),r.setAttribute("viewBox",`0 0 ${M} ${M}`),r.setAttribute("width",String(M)),r.setAttribute("height",String(M)),t.appendChild(r));let o=r.querySelector("path");o||(o=document.createElementNS(h,"path"),o.setAttribute("class","phase-shadow"),r.appendChild(o));let{position:i,phase:n}=e.tracks.moon;n>=1&&(n-=1);let s=Math.floor(n/.25),l=d*(n%.25/.25),u,a,p,m;switch(s){case 0:u=d,p=1,a=d-l,m=1;break;case 1:u=d,p=1,a=l,m=0;break;case 2:u=d-l,p=0,a=d,m=1;break;default:u=l,p=1,a=d,m=1}o.setAttribute("d",`M ${d},${M} A ${u} ${d} 180 0 ${p} ${d},0 A ${a} ${d} 180 0 ${m} ${d},${M}`);let[A,H]=g(i,e);r.setAttribute("x",String(A-d)),r.setAttribute("y",String(H-d))}function Pt(e,t){let{width:r}=f(t),o=document.querySelector(`.pos[data-id="${e}"]`),{position:i}=t.tracks[e];o.querySelector(".az .value").textContent=`${i[0].toFixed(1)}\xB0`,o.querySelector(".h .value").textContent=`${i[1].toFixed(1)}\xB0`,e==="moon"&&(o.querySelector(".ph .value").textContent=t.tracks.moon.phase.toFixed(2));let[n]=g(i,t),{width:s}=o.querySelector("span").getBoundingClientRect();o.style.setProperty("--x",`${Math.min(n-6,r-s)}px`)}function Rt(e){Pt("sun",e),Pt("moon",e)}function Ct(e,t,r){let{width:o,height:i}=f(r),n=document.createElementNS(h,"path"),s="",l=null,u=null;for(let a=0;a<e.length;a++){let p=s?" L":"M",[m,A]=g(e[a],r);(l!==null&&Math.abs(m-l)>.95*o||u!==null&&Math.abs(A-u)>.95*i)&&(p=" M"),s+=`${p}${m},${A}`,l=m,u=A}return n.setAttribute("d",s),n.setAttribute("class","track"),n.setAttribute("data-id",t),n}function Ot(e,t,r){let o=document.createDocumentFragment();for(let i of e){let n=document.createElementNS(h,"circle"),[s,l]=g(i,r);n.setAttribute("cx",String(s)),n.setAttribute("cy",String(l)),n.setAttribute("r","1.5"),n.setAttribute("class","tick"),n.setAttribute("data-id",t),o.appendChild(n)}return o}function Lt(e){let{element:t,tracks:{sun:r,moon:o}}=e,i=t.querySelector("g.tracks");i.innerHTML="",i.appendChild(Ct(r.track,"sun",e)),i.appendChild(Ot(r.ticks,"sun",e)),i.appendChild(Ct(o.track,"moon",e)),i.appendChild(Ot(o.ticks,"moon",e))}function X(e){xt();let t=Q(),r=pt(t);if(document.documentElement.classList.toggle("error",!r),!r)return;let o={...t,element:document.querySelector("#screen svg"),tracks:ct(t.location,t.time)};ft(o),St(o),yt(o),Lt(o),wt(o),kt(o),Rt(o),Dt(o),e&&!t.time&&setTimeout(()=>X(!0),15e3)}function Wt(){let e=null;window.addEventListener("resize",()=>{e!==null&&clearTimeout(e),e=setTimeout(()=>X(),200)}),X(!0)}Wt();})();
