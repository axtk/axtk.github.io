"use strict";(()=>{var M=Math.PI/180,K=180/Math.PI,j=3600*180/Math.PI;function Vt(){let e=(document.querySelector('form [name="p"]')?.value.trim()??"").split(/\s*[,;]\s*/),r=parseFloat(e[0])*M,n=parseFloat(e[1])*M;return e[0]?.endsWith("S")&&(r*=-1),e[1]?.endsWith("W")&&(n*=-1),{lat:r,lon:n}}function zt(){return document.querySelector('form [name="t"]')?.value.trim()}function et(){return{location:Vt(),time:zt()}}var y=class{phi;theta;r;constructor(e,r,n=1){this.phi=e,this.theta=r,this.r=n}};var{abs:X}=Math;function rt(t,e,r){return(t<0||e<0||r<0?-1:1)*(X(t)+X(e)/60+X(r)/3600)}var{floor:O}=Math;function k(t){t=t instanceof Date?t:new Date(t);let e=t.getUTCFullYear(),r=t.getUTCMonth()+1,n=t.getUTCDate(),l=t.getUTCHours(),o=t.getUTCMinutes(),i=t.getUTCSeconds();r<=2&&(r+=12,e--);let s;1e4*e+100*r+n<=15821004?s=-2+O((e+4716)/4)-1179:s=O(e/400)-O(e/100)+O(e/4);let u=365*e-679004+s+O(30.6001*(r+1))+n,c=rt(l,o,i)/24;return u+c}var{PI:Ft,floor:Gt}=Math,Q=86400,Nt=2*Ft;function nt(t){let e=k(t),r=Gt(e),n=Q*(e-r),l=(r-51544.5)/36525,o=(e-51544.5)/36525,i=24110.54841+8640184812866e-6*l+1.0027379093*n+(.093104-62e-7*o)*o*o;return Nt/Q*(i%Q)}var{PI:Ht,sqrt:ot,atan2:it,sin:lt,cos:st}=Math,C=class t{x;y;z;constructor(e=0,r=0,n=0){this.x=e,this.y=r,this.z=n}toPolar(){let{x:e,y:r,z:n}=this,l=e*e+r*r,o=ot(l+n*n),i=it(r,e),s=it(n,ot(l));return i<0&&(i+=2*Ht),new y(i,s,o)}static fromPolar(e){let{phi:r,theta:n,r:l}=e,o=l*st(n);return new t(o*st(r),o*lt(r),l*lt(n))}};function Jt(t,e){let r=0;for(let n=0,l=Math.min(t.length,e.length);n<l;n++)r+=t[n]*e[n];return r}var q=class t{value;rows;columns;constructor(e){this.value=e;let r=[];for(let n=0,l=e.length;n<l;n++)for(let o=0,i=e[n].length;o<i;o++)r[o]||(r[o]=new Array(l)),r[o][n]=e[n][o];this.rows=e,this.columns=r}multiplyByVec(e){return this.multiplyBy(t.fromVector(e)).toCartesianVector()}multiplyBy(e){let r=[];for(let n=0,l=this.rows.length;n<l;n++)for(let o=0,i=e.columns.length;o<i;o++)r[n]||(r[n]=new Array(i)),r[n][o]=Jt(this.rows[n],e.columns[o]);return new t(r)}toCartesianVector(){return new C(this.columns[0][0],this.columns[0][1],this.columns[0][2])}static fromVector(e){if(e instanceof C)return new t([[e.x],[e.y],[e.z]]);if(e instanceof y)return t.fromVector(C.fromPolar(e))}};var{sin:V,cos:z}=Math,P=class extends q{constructor(e){super([[1,0,0],[0,+z(e),+V(e)],[0,-V(e),+z(e)]])}},F=class extends q{constructor(e){super([[+z(e),0,-V(e)],[0,1,0],[+V(e),0,+z(e)]])}};function G({phi:t,theta:e},r,{lat:n,lon:l}){let o=nt(r)+l-t,i=new y(o,e);return new F(Math.PI/2-n).multiplyByVec(i).toPolar()}function S(t){return t-Math.floor(t)}var{sin:ut}=Math,Z=2*Math.PI;function N(t,e=0){let r=(k(t)-51544.5)/36525+e,n=Z*S(.993133+99.997361*r),l=Z*S(.7859453+n/Z+(6893*ut(n)+72*ut(2*n)+6191.2*r)/1296e3);return new y(l,0)}var Bt=23.43929111*M;function mt(t){let e=N(t);return new P(-Bt).multiplyByVec(e).toPolar()}function D(t,e){return G(mt(t),t,e)}var{sin:p}=Math,E=2*Math.PI;function H(t){let e=(k(t)-51544.5)/36525,r=S(.606433+1336.855225*e),n=E*S(.374897+1325.55241*e),l=E*S(.993133+99.997361*e),o=E*S(.827361+1236.853086*e),i=E*S(.259086+1342.227825*e),s=22640*p(n)-4586*p(n-2*o)+2370*p(2*o)+769*p(2*n)-668*p(l)-412*p(2*i)-212*p(2*n-2*o)-206*p(n+l-2*o)+192*p(n+2*o)-165*p(l-2*o)-125*p(o)-110*p(n+l)+148*p(n-l)-55*p(2*i-2*o),u=i+(s+412*p(2*i)+541*p(l))/j,c=i-2*o,a=-526*p(c)+44*p(n+c)-31*p(-n+c)-23*p(l+c)+11*p(-l+c)-25*p(-2*n+i)+21*p(-n+i);return new y(E*S(r+s/1296e3),(18520*p(u)+a)/j)}var Ut=23.43929111*M;function at(t){let e=H(t);return new P(-Ut).multiplyByVec(e).toPolar()}function v(t,e){return G(at(t),t,e)}var tt=2*Math.PI,Wt=-8.32/(1440*36525);function ct(t){return(H(t).phi-N(t,Wt).phi+tt)%tt/tt}var Yt=2*Math.PI,gt=1e3,T=60*gt,$=60*T;function x({phi:t,theta:e}){let r=(t+Math.PI)%Yt*K,n=e*K;return[r,n]}function Kt(t){return typeof t=="number"?t:t===void 0||t===""?Date.now():(t instanceof Date?t:new Date(t)).getTime()}var J=-.25;function pt(t,e){e.t>=e.t0&&t.time===null&&t.prevAlt!==null&&t.prevTime!==null&&Math.sign(e.alt-J)!==Math.sign(t.prevAlt-J)&&(Math.abs(e.alt-J)<Math.abs(t.prevAlt-J)?(t.time=e.t,t.alt=e.alt):(t.time=t.prevTime,t.alt=t.prevAlt),t.type=t.prevAlt<e.alt?"rise":"set"),t.prevAlt=e.alt,t.prevTime=e.t}var ft=-2.5*$,dt=22.5*$,ht={time:null,type:null,alt:null,prevAlt:null,prevTime:null};function bt(t,e){let r=Kt(e),n=r-5*T,l=[],o=[],i={...ht};for(let a=ft;a<dt;a+=T){let m=r+a,b=x(D(m,t));pt(i,{t0:n,t:m,alt:b[1]}),l.push(b),o.push(x(v(m,t)))}let s=i.time;if(s!==null){i={...ht},n-=T;for(let a=-T;a<T;a+=gt){let m=s+a,b=x(D(m,t));pt(i,{t0:n,t:m,alt:b[1]})}}let u=[],c=[];for(let a=0;a>=ft;a-=$)u.push(x(D(r+a,t))),c.push(x(v(r+a,t)));for(let a=$;a<dt;a+=$)u.push(x(D(r+a,t))),c.push(x(v(r+a,t)));return{sun:{position:x(D(r,t)),track:l,ticks:u,next:{alt:i.alt,time:i.time,type:i.type}},moon:{position:x(v(r,t)),track:o,ticks:c,phase:ct(r)}}}function yt({location:t,time:e}){return!t||isNaN(t.lat)||isNaN(t.lon)?!1:e===void 0||e===""||typeof e=="number"?!0:!isNaN(new Date(e).getTime())}function St({element:t}){let e=t.parentElement;if(!e)return;t.setAttribute("style","display: none");let{width:r,height:n}=e.getBoundingClientRect();t.setAttribute("width",String(r)),t.setAttribute("height",String(n)),t.setAttribute("viewBox",`0 0 ${r} ${n}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}var B=null,xt="";function f({element:t}){let e=t.getAttribute("data-size");return e===xt&&B!==null||(B={width:Number(t.getAttribute("width")),height:Number(t.getAttribute("height"))},xt=e),B}var h="http://www.w3.org/2000/svg",A={default:20,sun:42},L=24,At=0,U=23.5/180*Math.PI;function Mt([t,e],r){let{width:n,height:l}=f(r),o=(r.location.lat<U?.5-t/n:t/n)*360,i=(.5-(e-L)/(l-2*L))*180;return o<0&&(o+=360),[o,i]}var jt=5,wt=["N","E","S","W"];function Rt(t){let e=t.element.querySelector(".directions"),{width:r,height:n}=f(t),l=Array.from(e.querySelectorAll(".tick")),o=Array.from(e.querySelectorAll(".tick-label"));for(;l.length<5;){let i=document.createElementNS(h,"line");i.setAttribute("class","tick"),e.appendChild(i),l.push(i)}for(;o.length<5;){let i=document.createElementNS(h,"text");e.appendChild(i),o.push(i)}for(let i=0;i<l.length;i++){let s=l[i],u=i/4*r;s.setAttribute("x1",String(u)),s.setAttribute("y1",String(n/2-jt)),s.setAttribute("x2",String(u)),s.setAttribute("y2",String(n/2))}for(let i=0;i<o.length;i++){let s=o[i],u=i/4*r,[c]=Mt([u,0],t);s.setAttribute("x",String(u)),s.setAttribute("y",String(n/2+12)),s.textContent=wt[Math.floor(c/90)%wt.length],u<1?s.setAttribute("class","leftmost tick-label"):u>r-1?s.setAttribute("class","rightmost tick-label"):s.setAttribute("class","tick-label")}}function Xt(){return new Promise((t,e)=>{if(!navigator.geolocation)return e(new Error("Geolocation is not supported by the browser."));navigator.geolocation.getCurrentPosition(r=>{if(!r||!r.coords)return e(new Error("Failed to retrieve current location."));t({lat:r.coords.latitude,lon:r.coords.longitude})},()=>{e(new Error(`Failed to retrieve current location.
Make sure geolocation is enabled.`))})})}var Qt={p:"55.76\xB0 N, 37.62\xB0 E"};function kt(){let t=new URLSearchParams(window.location.search);for(let r of["p","t"]){let n=(t.get(r)??"").trim(),l=document.querySelector(`form [name="${r}"]`);l instanceof HTMLInputElement&&(l.value=n||(Qt[r]??""))}let e=document.querySelector("#set-current-location");e&&e.addEventListener("click",()=>{Xt().then(r=>{let{searchParams:n}=new URL(window.location.href);n.set("p",`${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`),window.location.search=n.toString()}).catch(r=>{alert(r.message)})})}function g([t,e],r){let{width:n,height:l}=f(r),o=(r.location.lat<U?.5-t/360:t/360)*n,i=L+(.5-e/180)*(l-2*L);return o<0&&(o+=n),[o,i]}function Ct(t){let e=t.element.querySelector(".horizon"),{width:r,height:n}=f(t),l=[Array.from(e.querySelectorAll(".under")),Array.from(e.querySelectorAll(".above"))];for(let o=0;o<l.length;o++)for(;l[o].length<3;){let i=document.createElementNS(h,"rect");i.setAttribute("class",o===0?"under":"above"),i.setAttribute("x","0"),e.appendChild(i),l[o].push(i)}for(let o=0;o<3;o++){let i=l[0][o],s=l[1][o],u=g([0,-o*6],t)[1];i.setAttribute("y",String(u)),i.setAttribute("width",String(r)),i.setAttribute("height",String(n-u-At)),s.setAttribute("y","0"),s.setAttribute("width",String(r)),s.setAttribute("height",String(u))}}function Pt(t,e,r){let n=r.element.querySelector(`.markers [data-id="${e}"]`),l=A[e]??A.default,[o,i]=g(t,r);return n.setAttribute("data-id",e),n.setAttribute("x",String(o-l/2)),n.setAttribute("y",String(i-l/2)),n.setAttribute("width",String(l)),n.setAttribute("height",String(l)),n}function Dt(t){let{tracks:{sun:e,moon:r}}=t;Pt(e.position,"sun",t),Pt(r.position,"moon",t)}function Tt(t,e,r){let{width:n,height:l}=f(r),o=r.element.querySelector("g.marker-lines"),i=Array.from(o.querySelectorAll(`line[data-id="${e}"]`));for(;i.length<4;){let m=document.createElementNS(h,"line");m.setAttribute("data-id",e),o.appendChild(m),i.push(m)}let[s,u]=g(t,r),c=(A[e]??A.default)/2,a=[[[0,u],[s-c,u]],[[s+c,u],[n,u]],[[s,e==="sun"?0:l/2],[s,u-c]],[[s,u+c],[s,e==="sun"?l/2:l]]];for(let m=0;m<i.length;m++){let b=a[m][1][0]-a[m][0][0],Y=a[m][1][1]-a[m][0][1];b<1&&Y<1?i[m].setAttribute("class","hidden"):i[m].hasAttribute("class")&&i[m].removeAttribute("class"),i[m].setAttribute("x1",String(a[m][0][0])),i[m].setAttribute("y1",String(a[m][0][1])),i[m].setAttribute("x2",String(a[m][1][0])),i[m].setAttribute("y2",String(a[m][1][1]))}}function Lt(t){let{tracks:{sun:e,moon:r}}=t;Tt(e.position,"sun",t),Tt(r.position,"moon",t)}var w=A.moon??A.default,d=w/2;function Ot(t){let e=t.element.querySelector("g.markers"),r=e.querySelector('[data-id="moon-phase"]');r||(r=document.createElementNS(h,"svg"),r.setAttribute("data-id","moon-phase"),r.setAttribute("viewBox",`0 0 ${w} ${w}`),r.setAttribute("width",String(w)),r.setAttribute("height",String(w)),e.appendChild(r));let n=r.querySelector("path");n||(n=document.createElementNS(h,"path"),n.setAttribute("class","phase-shadow"),r.appendChild(n));let{position:l,phase:o}=t.tracks.moon;o>=1&&(o-=1);let i=Math.floor(o/.25),s=d*(o%.25/.25),u,c,a,m;switch(i){case 0:u=d,a=1,c=d-s,m=1;break;case 1:u=d,a=1,c=s,m=0;break;case 2:u=d-s,a=0,c=d,m=1;break;default:u=s,a=1,c=d,m=1}n.setAttribute("d",`M ${d},${w} A ${u} ${d} 180 0 ${a} ${d},0 A ${c} ${d} 180 0 ${m} ${d},${w}`);let[b,Y]=g(l,t);r.setAttribute("x",String(b-d)),r.setAttribute("y",String(Y-d))}function qt(t,e){let{width:r}=f(e),n=document.querySelector(`.pos[data-id="${t}"]`),{position:l}=e.tracks[t];if(n.querySelector(".az .value").textContent=`${l[0].toFixed(1)}\xB0`,n.querySelector(".h .value").textContent=`${l[1].toFixed(1)}\xB0`,t==="moon")n.querySelector(".ph .value").textContent=`${Math.round(e.tracks.moon.phase*100)}%`;else if(t==="sun"){let{next:s}=e.tracks.sun;if(s.time!==null&&s.type!==null){let u=new Date(s.time);n.querySelector(".next .value").textContent=`${String(u.getHours()).padStart(2,"0")}:${String(u.getMinutes()).padStart(2,"0")}`,n.querySelector(".next .type").textContent=s.type==="rise"?"Rise":"Set"}}let[o]=g(l,e),{width:i}=n.querySelector("span").getBoundingClientRect();n.style.setProperty("--x",`${Math.min(o-6,r-i)}px`)}function Et(t){qt("sun",t),qt("moon",t)}function vt(t,e,r){let{width:n,height:l}=f(r),o=document.createElementNS(h,"path"),i="",s=null,u=null;for(let c=0;c<t.length;c++){let a=i?" L":"M",[m,b]=g(t[c],r);(s!==null&&Math.abs(m-s)>.95*n||u!==null&&Math.abs(b-u)>.95*l)&&(a=" M"),i+=`${a}${m},${b}`,s=m,u=b}return o.setAttribute("d",i),o.setAttribute("class","track"),o.setAttribute("data-id",e),o}function $t(t,e,r){let n=document.createDocumentFragment();for(let l of t){let o=document.createElementNS(h,"circle"),[i,s]=g(l,r);o.setAttribute("cx",String(i)),o.setAttribute("cy",String(s)),o.setAttribute("r","1.5"),o.setAttribute("class","tick"),o.setAttribute("data-id",e),n.appendChild(o)}return n}function It(t){let{element:e,tracks:{sun:r,moon:n}}=t,l=e.querySelector("g.tracks");l.innerHTML="",l.appendChild(vt(r.track,"sun",t)),l.appendChild($t(r.ticks,"sun",t)),l.appendChild(vt(n.track,"moon",t)),l.appendChild($t(n.ticks,"moon",t))}var I=null,R=null;function W(t){if(!R&&(kt(),R=et(),!yt(R))){document.documentElement.classList.add("error");return}let e={...R,element:document.querySelector("#screen svg"),tracks:bt(R.location,R.time)};St(e),Ct(e),Rt(e),It(e),Dt(e),Lt(e),Et(e),Ot(e),t&&!R.time&&(I!==null&&clearTimeout(I),I=setTimeout(()=>W(!0),15e3))}function Zt(){let t=null;window.addEventListener("resize",()=>{t!==null&&clearTimeout(t),t=setTimeout(()=>W(),200)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?W(!0):I!==null&&clearTimeout(I)}),W(!0)}Zt();})();
