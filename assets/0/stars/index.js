"use strict";(()=>{var k="https://raw.githubusercontent.com/axtk/x/refs/heads/main/assets/stars/data",F={stars:`${k}/stars_m6.json`,constellationLabels:`${k}/constellation_labels.json`,constellationNames:`${k}/constellation_names.json`,constellationLines:`${k}/constellation_lines.json`},c="http://www.w3.org/2000/svg",B={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},X=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];function pt(t){let o={};for(let n of t){let e=n[5]?.split(", ").at(-1)||`#${n[3]}`;o[e]=[n[0],n[1]]}return o}async function Y(){let[t,o,n,e]=await Promise.all([F.stars,F.constellationLabels,F.constellationNames,F.constellationLines].map(i=>fetch(i).then(m=>m.json()))),r=pt(t),l=[];for(let[i,m]of Object.entries(e))for(let s of m){let a=[];for(let u of s){let p;u.includes(" #")||u.startsWith("#")?p=u.split(" ").at(-1):!u.includes(" ")&&i!=="_"?p=`${u} ${i}`:p=u,p&&r[p]&&a.push(r[p])}a.length!==0&&l.push(a)}return{stars:t,constellationLabels:o,constellationNames:n,constellationLines:l}}var P=null,V="";function S({element:t}){let o=t.getAttribute("data-size");if(o===V&&P!==null)return P;let n=Number(t.getAttribute("width")),e=Number(t.getAttribute("height"));return P={width:n,height:e,r:Math.sqrt(n*n+e*e)/1.65,x0:n/2,y0:e/2},V=o,P}var{sin:x,cos:b}=Math;function f(t,o,n){let{tilt:[e,r]}=n,{width:l,height:i,x0:m,y0:s,r:a}=S(n),u=a*b(o)*b(t),p=a*x(o),$=a*b(o)*x(t),I=u*b(e)+$*x(e),L=p,D=-u*x(e)+$*b(e),E=I,w=L*b(r)-D*x(r),q=L*x(r)+D*b(r);return q<0||E<-.75*l||E>1.75*l||w<-.75*i||w>1.75*i?null:[m+E,s-w,q]}var{PI:d}=Math,N=d/100,M=d/12,_=d/50;function K(t){let o=t.element.querySelector("g.grid"),n=o.querySelector("path");n||(n=document.createElementNS(c,"path"),o.appendChild(n));let e,r="",l="";for(let i=-d/2+M;i<=d/2-M+N;i+=M){let m="",s=!1;for(let a=0;a<=2*d+N;a+=_){if(e=f(a,i,t),l=m&&!s?" L":"M",e===null){s=!0;continue}s&&(s=!1),m+=`${l}${e[0].toFixed(3)},${e[1].toFixed(3)}`}r+=`${r?" ":""}${m}`}for(let i=0;i<=2*d-M+N;i+=M){let m="",s=!1;for(let a=-d/2;a<=d/2+N;a+=_){if(e=f(i,a,t),l=m&&!s?" L":"M",e===null){s=!0;continue}s&&(s=!1),m+=`${l}${e[0].toFixed(3)},${e[1].toFixed(3)}`}r+=`${r?" ":""}${m}`}n.setAttribute("d",r)}function A(t,o){return o.mode==="fantasy"?2*(6.75-t[2]):.5*(6.75-t[2])}var{floor:G,random:g,sin:H,cos:O,PI:J}=Math;function dt(){return`#${["","",""].map(()=>G(50+120*g()).toString(16)).join("")}`}var bt=30,T=[];function gt(){if(T.length===bt)return T[G(g()*T.length)];let t="",o=Array.from({length:2}).map(()=>dt());for(let n=0;n<2;n++)for(let e=.25*n;e<5;e++){let r=2*J*g(),l=5+e*O(r),i=5+e*H(r),m=r+J*(.5+.5*g()),s=5+e*O(m),a=5+e*H(m),u=o[G(g()*o.length)];t+=`<path d="M${l} ${i} A ${e} ${e} 0 1 0 ${s} ${a}" stroke="${u}" stroke-width="${(.75+g()).toFixed(3)}" stroke-opacity="${(.35+.55*g()).toFixed(3)}"/>`}return T.push(t),t}function W(t){let o=t.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("svg")),e=null;for(let u of o.querySelectorAll("circle"))u.remove();let r,l,i,m,s,a=0;for(let u=0;u<t.stars.length;u++)r=t.stars[u],i=f(r[0],r[1],t),i!==null&&(l=n[a++],l||(e||(e=document.createDocumentFragment()),l=document.createElementNS(c,"svg"),l.setAttribute("viewBox","0 0 10 10"),l.innerHTML=gt(),e.appendChild(l)),m=A(r,t),s=(2*m).toFixed(3),l.setAttribute("x",(i[0]-m).toFixed(3)),l.setAttribute("y",(i[1]-m).toFixed(3)),l.setAttribute("width",s),l.setAttribute("height",s),l.setAttribute("data-spcl",r[4]));e&&o.appendChild(e);for(let u=a;u<n.length;u++)n[u].remove()}function Q(t){if(t.mode==="fantasy")return W(t);let o=t.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("circle")),e=null;for(let s of o.querySelectorAll("svg"))s.remove();let r,l,i,m=0;for(let s=0;s<t.stars.length;s++)r=t.stars[s],i=f(r[0],r[1],t),i!==null&&(l=n[m++],l||(e||(e=document.createDocumentFragment()),l=document.createElementNS(c,"circle"),e.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",A(r,t).toFixed(3)),l.setAttribute("data-spcl",r[4]));e&&o.appendChild(e);for(let s=m;s<n.length;s++)n[s].remove()}function ht(t){if(!t[5])return;let n=t[5].split(", ").at(-1)?.split(" ")?.[0]?.match(/^([^\d]+)(\d+)?$/);if(!n||n.length<2)return;let e=B[n[1]]??n[1]??"";if(!e)return;let r=n[2]?X[Number(n[2])]??"":"";return`${e}${r}`}function U(t){let o=t.element.querySelector("g.star-labels"),n=Array.from(o.querySelectorAll("text")),e=null,r,l,i,m,s=0;for(let a=0;a<t.stars.length;a++){if(r=t.stars[a],l=ht(r),!l||(m=f(r[0],r[1],t),m===null))continue;i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(c,"text"),e.appendChild(i));let u=A(r,t);i.setAttribute("x",(m[0]+u+2).toFixed(3)),i.setAttribute("y",(m[1]+2).toFixed(3)),i.setAttribute("data-x",r[2]<3?"1":"0"),i.textContent=l}e&&o.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function yt(t,o){if(t[2])return o.constellationNames[t[2]]??t[2]}function Z(t){let o=t.element.querySelector("g.constellation-labels"),n=Array.from(o.querySelectorAll("text")),e=null,r,l,i,m,s=0;for(let a=0;a<t.constellationLabels.length;a++)r=t.constellationLabels[a],l=yt(r,t),!(!r[2]||!l)&&(m=f(r[0],r[1],t),m!==null&&(i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(c,"text"),e.appendChild(i)),i.setAttribute("x",m[0].toFixed(3)),i.setAttribute("y",m[1].toFixed(3)),i.textContent=l));e&&o.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function tt(t){let o=t.element.querySelector("g.constellation-lines"),n=Array.from(o.querySelectorAll("path")),e=null,r,l,i,m,s=0;for(let a=0;a<t.constellationLines.length;a++){r=t.constellationLines[a],l="";for(let u of r)m=f(u[0],u[1],t),m!==null&&(l+=`${l?" L":"M"}${m[0]},${m[1]}`);l&&(i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(c,"path"),e.appendChild(i)),i.setAttribute("d",l))}e&&o.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function h(t){K(t),Q(t),U(t),Z(t),tt(t)}var et="stars.",y={read(t){try{let o=localStorage.getItem(`${et}${t}`);return o===null?null:JSON.parse(o)}catch{return null}},write(t,o){try{localStorage.setItem(`${et}${t}`,JSON.stringify(o))}catch{}}};function v(t,o=0,n=2*Math.PI,e){for(;t<o;)t+=n-o;if(e)for(;t>n;)t-=n-o;else for(;t>=n;)t-=n-o;return t}var{PI:nt,asin:rt}=Math,C=!1;function ot(t,o,n){let{tilt:e}=t,{r}=S(t),l=rt(o/r),i=rt(n/r),m=e[0]+l,s=e[1]+i;e[0]=v(m),s>=-nt/2&&s<=nt/2&&(e[1]=s),C||(requestAnimationFrame(()=>{h(t),y.write("tilt",e),C=!1}),C=!0)}function Ct(t){let{element:o}=t,n=null,e=null;o.addEventListener("mousedown",r=>{n=r.offsetX,e=r.offsetY,C=!1}),o.addEventListener("mouseup",()=>{n=null,e=null,C=!1}),o.addEventListener("mousemove",r=>{n!==null&&e!==null&&(ot(t,r.offsetX-n,r.offsetY-e),n=r.offsetX,e=r.offsetY)})}function St(t){let{element:o}=t,n=null,e=null;o.addEventListener("touchstart",r=>{n=r.changedTouches[0].pageX,e=r.changedTouches[0].pageY,C=!1}),o.addEventListener("touchend",()=>{n=null,e=null,C=!1}),o.addEventListener("touchmove",r=>{n!==null&&e!==null&&(ot(t,r.changedTouches[0].pageX-n,r.changedTouches[0].pageY-e),n=r.changedTouches[0].pageX,e=r.changedTouches[0].pageY)})}function lt(t){Ct(t),St(t)}var{sin:R,cos:z,asin:xt,atan2:At,sqrt:$t,PI:it}=Math;function st(t,o,n){let{tilt:[e,r]}=n,{r:l,x0:i,y0:m}=S(n),s=t-i,a=m-o,u=l*l-s*s-a*a;if(u<0)return null;let p=$t(u),$=s,I=a*z(-r)-p*R(-r),L=a*R(-r)+p*z(-r),D=$*z(-e)+L*R(-e),E=I,w=-$*R(-e)+L*z(-e),q=v(At(w,D)),ct=v(xt(E/l),-it/2,it/2,!0);return[q,ct]}var{abs:at}=Math,mt=5;function Lt(t,o){return t[2]-o[2]}function ut(t){document.addEventListener("click",o=>{if(!t.element.contains(o.target))return;let{left:n,top:e}=t.element.getBoundingClientRect(),r=o.offsetX-n,l=o.offsetY-e,i=st(r,l,t);if(console.log("click",i),i===null)return;let m=[];for(let s of t.stars){let a=f(s[0],s[1],t);a!==null&&at(a[0]-r)<=mt&&at(a[1]-l)<=mt&&m.push(s)}m.sort(Lt);for(let s of m)console.log(`#${s[3]}; ${s[5]}`,s[2]),window.sendEvent?.(["click star",String(s[5]??s[3])])})}function ft(t){let o=document.querySelector("#screen form");for(let n of o.querySelectorAll('[name="mode"]'))n.checked=n.value===t.mode;o.addEventListener("change",n=>{let e=n.target;if(e instanceof HTMLInputElement&&e.name==="mode"){let r=t.mode,l=e.value;document.documentElement.dataset.mode=l,t.mode=l,(l==="fantasy"||r==="fantasy")&&h(t),y.write("mode",l),window.sendEvent?.(["set mode",l])}})}function j({element:t}){let o=t.parentElement;if(!o)return;t.setAttribute("style","display: none");let{width:n,height:e}=o.getBoundingClientRect();t.setAttribute("width",String(n)),t.setAttribute("height",String(e)),t.setAttribute("viewBox",`0 0 ${n} ${e}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}async function Et(){let t=document.querySelector("#screen svg"),o=await Y(),n=y.read("mode")??document.documentElement.dataset.mode,e={...o,element:t,tilt:y.read("tilt")??[-.12,0],mode:n};document.documentElement.dataset.mode!==n&&(document.documentElement.dataset.mode=n);let r=null;window.addEventListener("resize",()=>{r!==null&&cancelAnimationFrame(r),r=requestAnimationFrame(()=>{j(e),h(e)})}),j(e),ft(e),h(e),lt(e),ut(e)}Et();})();
