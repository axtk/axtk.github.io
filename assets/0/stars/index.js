"use strict";(()=>{var v="https://raw.githubusercontent.com/axtk/x/refs/heads/main/assets/stars/data",F={stars:`${v}/stars_m6.json`,constellationLabels:`${v}/constellation_labels.json`,constellationNames:`${v}/constellation_names.json`,constellationLines:`${v}/constellation_lines.json`},c="http://www.w3.org/2000/svg",X={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},Y=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];function ae(e){let o={};for(let n of e){let t=n[5]?.split(", ").at(-1)||`#${n[3]}`;o[t]=[n[0],n[1]]}return o}async function V(){let[e,o,n,t]=await Promise.all([F.stars,F.constellationLabels,F.constellationNames,F.constellationLines].map(i=>fetch(i).then(u=>u.json()))),r=ae(e),l=[];for(let[i,u]of Object.entries(t))for(let s of u){let a=[];for(let m of s){let p;m.includes(" #")||m.startsWith("#")?p=m.split(" ").at(-1):!m.includes(" ")&&i!=="_"?p=`${m} ${i}`:p=m,p&&r[p]&&a.push(r[p])}a.length!==0&&l.push(a)}return{stars:e,constellationLabels:o,constellationNames:n,constellationLines:l}}var q=null,B="";function C({element:e}){let o=e.getAttribute("data-size");if(o===B&&q!==null)return q;let n=Number(e.getAttribute("width")),t=Number(e.getAttribute("height"));return q={width:n,height:t,r:Math.sqrt(n*n+t*t)/1.65,x0:n/2,y0:t/2},B=o,q}var{sin:y,cos:b}=Math;function f(e,o,n){let{tilt:[t,r]}=n,{width:l,height:i,x0:u,y0:s,r:a}=C(n),m=a*b(o)*b(e),p=a*y(o),A=a*b(o)*y(e),z=m*b(t)+A*y(t),L=p,M=-m*y(t)+A*b(t),$=z,E=L*b(r)-M*y(r),D=L*y(r)+M*b(r);return D<0||$<-.75*l||$>1.75*l||E<-.75*i||E>1.75*i?null:[u+$,s-E,D]}var{PI:d}=Math,k=d/100,w=d/12,_=d/50;function I(e){let o=e.element.querySelector("g.grid"),n=o.querySelector("path");n||(n=document.createElementNS(c,"path"),o.appendChild(n));let t,r="",l="";for(let i=-d/2+w;i<=d/2-w+k;i+=w){let u="",s=!1;for(let a=0;a<=2*d+k;a+=_){if(t=f(a,i,e),l=u&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),u+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}r+=`${r?" ":""}${u}`}for(let i=0;i<=2*d-w+k;i+=w){let u="",s=!1;for(let a=-d/2;a<=d/2+k;a+=_){if(t=f(i,a,e),l=u&&!s?" L":"M",t===null){s=!0;continue}s&&(s=!1),u+=`${l}${t[0].toFixed(3)},${t[1].toFixed(3)}`}r+=`${r?" ":""}${u}`}n.setAttribute("d",r)}function S(e,o){return o.mode==="fantasy"?2*(6.75-e[2]):.5*(6.75-e[2])}var{floor:T,random:g,sin:K,cos:H,PI:O}=Math;function ue(){return`#${["","",""].map(()=>T(50+120*g()).toString(16)).join("")}`}var me=30,P=[];function fe(){if(P.length===me)return P[T(g()*P.length)];let e="",o=Array.from({length:2}).map(()=>ue());for(let n=0;n<2;n++)for(let t=.25*n;t<5;t++){let r=2*O*g(),l=5+t*H(r),i=5+t*K(r),u=r+O*(.5+.5*g()),s=5+t*H(u),a=5+t*K(u),m=o[T(g()*o.length)];e+=`<path d="M${l} ${i} A ${t} ${t} 0 1 0 ${s} ${a}" stroke="${m}" stroke-width="${(.75+g()).toFixed(3)}" stroke-opacity="${(.35+.55*g()).toFixed(3)}"/>`}return P.push(e),e}function W(e){let o=e.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("svg")),t=null;for(let m of o.querySelectorAll("circle"))m.remove();let r,l,i,u,s,a=0;for(let m=0;m<e.stars.length;m++)r=e.stars[m],i=f(r[0],r[1],e),i!==null&&(l=n[a++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"svg"),l.setAttribute("viewBox","0 0 10 10"),l.innerHTML=fe(),t.appendChild(l)),u=S(r,e),s=(2*u).toFixed(3),l.setAttribute("x",(i[0]-u).toFixed(3)),l.setAttribute("y",(i[1]-u).toFixed(3)),l.setAttribute("width",s),l.setAttribute("height",s),l.setAttribute("data-spcl",r[4]));t&&o.appendChild(t);for(let m=a;m<n.length;m++)n[m].remove()}function J(e){if(e.mode==="fantasy")return W(e);let o=e.element.querySelector("g.stars"),n=Array.from(o.querySelectorAll("circle")),t=null;for(let s of o.querySelectorAll("svg"))s.remove();let r,l,i,u=0;for(let s=0;s<e.stars.length;s++)r=e.stars[s],i=f(r[0],r[1],e),i!==null&&(l=n[u++],l||(t||(t=document.createDocumentFragment()),l=document.createElementNS(c,"circle"),t.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",S(r,e).toFixed(3)),l.setAttribute("data-spcl",r[4]));t&&o.appendChild(t);for(let s=u;s<n.length;s++)n[s].remove()}function ce(e){if(!e[5])return;let n=e[5].split(", ").at(-1)?.split(" ")?.[0]?.match(/^([^\d]+)(\d+)?$/);if(!n||n.length<2)return;let t=X[n[1]]??n[1]??"";if(!t)return;let r=n[2]?Y[Number(n[2])]??"":"";return`${t}${r}`}function Q(e){let o=e.element.querySelector("g.star-labels"),n=Array.from(o.querySelectorAll("text")),t=null,r,l,i,u,s=0;for(let a=0;a<e.stars.length;a++){if(r=e.stars[a],l=ce(r),!l||(u=f(r[0],r[1],e),u===null))continue;i=n[s++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"text"),t.appendChild(i));let m=S(r,e);i.setAttribute("x",(u[0]+m+2).toFixed(3)),i.setAttribute("y",(u[1]+2).toFixed(3)),i.setAttribute("data-x",r[2]<3?"1":"0"),i.textContent=l}t&&o.appendChild(t);for(let a=s;a<n.length;a++)n[a].remove()}function pe(e,o){if(e[2])return o.constellationNames[e[2]]??e[2]}function U(e){let o=e.element.querySelector("g.constellation-labels"),n=Array.from(o.querySelectorAll("text")),t=null,r,l,i,u,s=0;for(let a=0;a<e.constellationLabels.length;a++)r=e.constellationLabels[a],l=pe(r,e),!(!r[2]||!l)&&(u=f(r[0],r[1],e),u!==null&&(i=n[s++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"text"),t.appendChild(i)),i.setAttribute("x",u[0].toFixed(3)),i.setAttribute("y",u[1].toFixed(3)),i.textContent=l));t&&o.appendChild(t);for(let a=s;a<n.length;a++)n[a].remove()}function Z(e){let o=e.element.querySelector("g.constellation-lines"),n=Array.from(o.querySelectorAll("path")),t=null,r,l,i,u,s=0;for(let a=0;a<e.constellationLines.length;a++){r=e.constellationLines[a],l="";for(let m of r)u=f(m[0],m[1],e),u!==null&&(l+=`${l?" L":"M"}${u[0]},${u[1]}`);l&&(i=n[s++],i||(t||(t=document.createDocumentFragment()),i=document.createElementNS(c,"path"),t.appendChild(i)),i.setAttribute("d",l))}t&&o.appendChild(t);for(let a=s;a<n.length;a++)n[a].remove()}function x(e){I(e),J(e),Q(e),U(e),Z(e)}var{PI:G,asin:ee}=Math;function de(e,o=0,n=2*G){for(;e<o;)e+=n-o;for(;e>=n;)e-=n-o;return e}var h=!1;function te(e,o,n){let{tilt:t}=e,{r}=C(e),l=ee(o/r),i=ee(n/r),u=t[0]+l,s=t[1]+i;t[0]=de(u),s>=-G/2&&s<=G/2&&(t[1]=s),h||(requestAnimationFrame(()=>{x(e),h=!1}),h=!0)}function be(e){let{element:o}=e,n=null,t=null;o.addEventListener("mousedown",r=>{n=r.offsetX,t=r.offsetY,h=!1}),o.addEventListener("mouseup",()=>{n=null,t=null,h=!1}),o.addEventListener("mousemove",r=>{n!==null&&t!==null&&(te(e,r.offsetX-n,r.offsetY-t),n=r.offsetX,t=r.offsetY)})}function ge(e){let{element:o}=e,n=null,t=null;o.addEventListener("touchstart",r=>{n=r.changedTouches[0].pageX,t=r.changedTouches[0].pageY,h=!1}),o.addEventListener("touchend",()=>{n=null,t=null,h=!1}),o.addEventListener("touchmove",r=>{n!==null&&t!==null&&(te(e,r.changedTouches[0].pageX-n,r.changedTouches[0].pageY-t),n=r.changedTouches[0].pageX,t=r.changedTouches[0].pageY)})}function ne(e){be(e),ge(e)}var{sin:N,cos:R,asin:he,atan2:Ce,sqrt:ye}=Math;function re(e,o,n){let{tilt:[t,r]}=n,{r:l,x0:i,y0:u}=C(n),s=e-i,a=u-o,m=l*l-s*s-a*a;if(m<0)return null;let p=ye(m),A=s,z=a*R(-r)-p*N(-r),L=a*N(-r)+p*R(-r),M=A*R(-t)+L*N(-t),$=z,E=-A*N(-t)+L*R(-t),D=he($/l),se=Ce(E,M);return[D,se]}var{abs:oe}=Math,le=5;function Se(e,o){return e[2]-o[2]}function ie(e){document.addEventListener("click",o=>{if(!e.element.contains(o.target))return;let{left:n,top:t}=e.element.getBoundingClientRect(),r=o.offsetX-n,l=o.offsetY-t,i=re(r,l,e);if(console.log("click",i),i===null)return;let u=[];for(let s of e.stars){let a=f(s[0],s[1],e);a!==null&&oe(a[0]-r)<=le&&oe(a[1]-l)<=le&&u.push(s)}u.sort(Se);for(let s of u)console.log(`#${s[3]}; ${s[5]}`,s[2]),window.sendEvent?.(["click star",String(s[5]??s[3])])})}function j({element:e}){let o=e.parentElement;if(!o)return;e.setAttribute("style","display: none");let{width:n,height:t}=o.getBoundingClientRect();e.setAttribute("width",String(n)),e.setAttribute("height",String(t)),e.setAttribute("viewBox",`0 0 ${n} ${t}`),e.setAttribute("data-size",Math.random().toString(36).slice(2)),e.removeAttribute("style")}async function xe(){let e=document.querySelector("#screen svg"),n={...await V(),element:e,tilt:[-.12,0],mode:document.documentElement.dataset.mode},t=null;window.addEventListener("resize",()=>{t!==null&&cancelAnimationFrame(t),t=requestAnimationFrame(()=>{j(n),x(n)})}),document.querySelector("#screen form").addEventListener("change",r=>{let l=r.target;if(l instanceof HTMLInputElement&&l.name==="mode"){let i=n.mode,u=l.value;document.documentElement.dataset.mode=u,n.mode=u,(u==="fantasy"||i==="fantasy")&&x(n),window.sendEvent?.(["set mode",u])}}),j(n),x(n),ne(n),ie(n)}xe();})();
