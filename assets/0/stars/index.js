"use strict";(()=>{var q="https://raw.githubusercontent.com/axtk/x/refs/heads/main/assets/stars/data",w={stars:`${q}/stars_m6.json`,constellationLabels:`${q}/constellation_labels.json`,constellationNames:`${q}/constellation_names.json`,constellationLines:`${q}/constellation_lines.json`},c="http://www.w3.org/2000/svg",B={alp:"\u03B1",bet:"\u03B2",gam:"\u03B3",del:"\u03B4",eps:"\u03B5",zet:"\u03B6",eta:"\u03B7",the:"\u03B8",iot:"\u03B9",kap:"\u03BA",lam:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",omi:"\u03BF",pi:"\u03C0",rho:"\u03C1",sig:"\u03C3",tau:"\u03C4",ups:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",ome:"\u03C9",omg:"\u03C9"},X=["\u2070","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"];function mt(t){let r={};for(let n of t){let e=n[5]?.split(", ").at(-1)||`#${n[3]}`;r[e]=[n[0],n[1]]}return r}async function Y(){let[t,r,n,e]=await Promise.all([w.stars,w.constellationLabels,w.constellationNames,w.constellationLines].map(i=>fetch(i).then(u=>u.json()))),o=mt(t),l=[];for(let[i,u]of Object.entries(e))for(let s of u){let a=[];for(let m of s){let p;m.includes(" #")||m.startsWith("#")?p=m.split(" ").at(-1):!m.includes(" ")&&i!=="_"?p=`${m} ${i}`:p=m,p&&o[p]&&a.push(o[p])}a.length!==0&&l.push(a)}return{stars:t,constellationLabels:r,constellationNames:n,constellationLines:l}}var k=null,I="";function C({element:t}){let r=t.getAttribute("data-size");if(r===I&&k!==null)return k;let n=Number(t.getAttribute("width")),e=Number(t.getAttribute("height"));return k={width:n,height:e,r:Math.sqrt(n*n+e*e)/1.65,x0:n/2,y0:e/2},I=r,k}var{sin:y,cos:b}=Math;function f(t,r,n){let{tilt:[e,o]}=n,{width:l,height:i,x0:u,y0:s,r:a}=C(n),m=a*b(r)*b(t),p=a*y(r),A=a*b(r)*y(t),T=m*b(e)+A*y(e),L=p,D=-m*y(e)+A*b(e),$=T,E=L*b(o)-D*y(o),v=L*y(o)+D*b(o);return v<0||$<-.75*l||$>1.75*l||E<-.75*i||E>1.75*i?null:[u+$,s-E,v]}var{PI:d}=Math,P=d/100,F=d/12,V=d/50;function _(t){let r=t.element.querySelector("g.grid"),n=r.querySelector("path");n||(n=document.createElementNS(c,"path"),r.appendChild(n));let e,o="",l="";for(let i=-d/2+F;i<=d/2-F+P;i+=F){let u="",s=!1;for(let a=0;a<=2*d+P;a+=V){if(e=f(a,i,t),l=u&&!s?" L":"M",e===null){s=!0;continue}s&&(s=!1),u+=`${l}${e[0].toFixed(3)},${e[1].toFixed(3)}`}o+=`${o?" ":""}${u}`}for(let i=0;i<=2*d-F+P;i+=F){let u="",s=!1;for(let a=-d/2;a<=d/2+P;a+=V){if(e=f(i,a,t),l=u&&!s?" L":"M",e===null){s=!0;continue}s&&(s=!1),u+=`${l}${e[0].toFixed(3)},${e[1].toFixed(3)}`}o+=`${o?" ":""}${u}`}n.setAttribute("d",o)}function S(t,r){return r.mode==="fantasy"?2*(6.75-t[2]):.5*(6.75-t[2])}var{floor:G,random:g,sin:K,cos:H,PI:O}=Math;function ft(){return`#${["","",""].map(()=>G(50+120*g()).toString(16)).join("")}`}var ct=30,N=[];function pt(){if(N.length===ct)return N[G(g()*N.length)];let t="",r=Array.from({length:2}).map(()=>ft());for(let n=0;n<2;n++)for(let e=.25*n;e<5;e++){let o=2*O*g(),l=5+e*H(o),i=5+e*K(o),u=o+O*(.5+.5*g()),s=5+e*H(u),a=5+e*K(u),m=r[G(g()*r.length)];t+=`<path d="M${l} ${i} A ${e} ${e} 0 1 0 ${s} ${a}" stroke="${m}" stroke-width="${(.75+g()).toFixed(3)}" stroke-opacity="${(.35+.55*g()).toFixed(3)}"/>`}return N.push(t),t}function W(t){let r=t.element.querySelector("g.stars"),n=Array.from(r.querySelectorAll("svg")),e=null;for(let m of r.querySelectorAll("circle"))m.remove();let o,l,i,u,s,a=0;for(let m=0;m<t.stars.length;m++)o=t.stars[m],i=f(o[0],o[1],t),i!==null&&(l=n[a++],l||(e||(e=document.createDocumentFragment()),l=document.createElementNS(c,"svg"),l.setAttribute("viewBox","0 0 10 10"),l.innerHTML=pt(),e.appendChild(l)),u=S(o,t),s=(2*u).toFixed(3),l.setAttribute("x",(i[0]-u).toFixed(3)),l.setAttribute("y",(i[1]-u).toFixed(3)),l.setAttribute("width",s),l.setAttribute("height",s),l.setAttribute("data-spcl",o[4]));e&&r.appendChild(e);for(let m=a;m<n.length;m++)n[m].remove()}function J(t){if(t.mode==="fantasy")return W(t);let r=t.element.querySelector("g.stars"),n=Array.from(r.querySelectorAll("circle")),e=null;for(let s of r.querySelectorAll("svg"))s.remove();let o,l,i,u=0;for(let s=0;s<t.stars.length;s++)o=t.stars[s],i=f(o[0],o[1],t),i!==null&&(l=n[u++],l||(e||(e=document.createDocumentFragment()),l=document.createElementNS(c,"circle"),e.appendChild(l)),l.setAttribute("cx",i[0].toFixed(3)),l.setAttribute("cy",i[1].toFixed(3)),l.setAttribute("r",S(o,t).toFixed(3)),l.setAttribute("data-spcl",o[4]));e&&r.appendChild(e);for(let s=u;s<n.length;s++)n[s].remove()}function dt(t){if(!t[5])return;let n=t[5].split(", ").at(-1)?.split(" ")?.[0]?.match(/^([^\d]+)(\d+)?$/);if(!n||n.length<2)return;let e=B[n[1]]??n[1]??"";if(!e)return;let o=n[2]?X[Number(n[2])]??"":"";return`${e}${o}`}function Q(t){let r=t.element.querySelector("g.star-labels"),n=Array.from(r.querySelectorAll("text")),e=null,o,l,i,u,s=0;for(let a=0;a<t.stars.length;a++){if(o=t.stars[a],l=dt(o),!l||(u=f(o[0],o[1],t),u===null))continue;i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(c,"text"),e.appendChild(i));let m=S(o,t);i.setAttribute("x",(u[0]+m+2).toFixed(3)),i.setAttribute("y",(u[1]+2).toFixed(3)),i.setAttribute("data-x",o[2]<3?"1":"0"),i.textContent=l}e&&r.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function bt(t,r){if(t[2])return r.constellationNames[t[2]]??t[2]}function U(t){let r=t.element.querySelector("g.constellation-labels"),n=Array.from(r.querySelectorAll("text")),e=null,o,l,i,u,s=0;for(let a=0;a<t.constellationLabels.length;a++)o=t.constellationLabels[a],l=bt(o,t),!(!o[2]||!l)&&(u=f(o[0],o[1],t),u!==null&&(i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(c,"text"),e.appendChild(i)),i.setAttribute("x",u[0].toFixed(3)),i.setAttribute("y",u[1].toFixed(3)),i.textContent=l));e&&r.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function Z(t){let r=t.element.querySelector("g.constellation-lines"),n=Array.from(r.querySelectorAll("path")),e=null,o,l,i,u,s=0;for(let a=0;a<t.constellationLines.length;a++){o=t.constellationLines[a],l="";for(let m of o)u=f(m[0],m[1],t),u!==null&&(l+=`${l?" L":"M"}${u[0]},${u[1]}`);l&&(i=n[s++],i||(e||(e=document.createDocumentFragment()),i=document.createElementNS(c,"path"),e.appendChild(i)),i.setAttribute("d",l))}e&&r.appendChild(e);for(let a=s;a<n.length;a++)n[a].remove()}function x(t){_(t),J(t),Q(t),U(t),Z(t)}function M(t,r=0,n=2*Math.PI,e){for(;t<r;)t+=n-r;if(e)for(;t>n;)t-=n-r;else for(;t>=n;)t-=n-r;return t}var{PI:tt,asin:et}=Math,h=!1;function nt(t,r,n){let{tilt:e}=t,{r:o}=C(t),l=et(r/o),i=et(n/o),u=e[0]+l,s=e[1]+i;e[0]=M(u),s>=-tt/2&&s<=tt/2&&(e[1]=s),h||(requestAnimationFrame(()=>{x(t),h=!1}),h=!0)}function gt(t){let{element:r}=t,n=null,e=null;r.addEventListener("mousedown",o=>{n=o.offsetX,e=o.offsetY,h=!1}),r.addEventListener("mouseup",()=>{n=null,e=null,h=!1}),r.addEventListener("mousemove",o=>{n!==null&&e!==null&&(nt(t,o.offsetX-n,o.offsetY-e),n=o.offsetX,e=o.offsetY)})}function ht(t){let{element:r}=t,n=null,e=null;r.addEventListener("touchstart",o=>{n=o.changedTouches[0].pageX,e=o.changedTouches[0].pageY,h=!1}),r.addEventListener("touchend",()=>{n=null,e=null,h=!1}),r.addEventListener("touchmove",o=>{n!==null&&e!==null&&(nt(t,o.changedTouches[0].pageX-n,o.changedTouches[0].pageY-e),n=o.changedTouches[0].pageX,e=o.changedTouches[0].pageY)})}function ot(t){gt(t),ht(t)}var{sin:R,cos:z,asin:Ct,atan2:yt,sqrt:St,PI:rt}=Math;function lt(t,r,n){let{tilt:[e,o]}=n,{r:l,x0:i,y0:u}=C(n),s=t-i,a=u-r,m=l*l-s*s-a*a;if(m<0)return null;let p=St(m),A=s,T=a*z(-o)-p*R(-o),L=a*R(-o)+p*z(-o),D=A*z(-e)+L*R(-e),$=T,E=-A*R(-e)+L*z(-e),v=M(yt(E,D)),ut=M(Ct($/l),-rt/2,rt/2,!0);return[v,ut]}var{abs:it}=Math,st=5;function xt(t,r){return t[2]-r[2]}function at(t){document.addEventListener("click",r=>{if(!t.element.contains(r.target))return;let{left:n,top:e}=t.element.getBoundingClientRect(),o=r.offsetX-n,l=r.offsetY-e,i=lt(o,l,t);if(console.log("click",i),i===null)return;let u=[];for(let s of t.stars){let a=f(s[0],s[1],t);a!==null&&it(a[0]-o)<=st&&it(a[1]-l)<=st&&u.push(s)}u.sort(xt);for(let s of u)console.log(`#${s[3]}; ${s[5]}`,s[2]),window.sendEvent?.(["click star",String(s[5]??s[3])])})}function j({element:t}){let r=t.parentElement;if(!r)return;t.setAttribute("style","display: none");let{width:n,height:e}=r.getBoundingClientRect();t.setAttribute("width",String(n)),t.setAttribute("height",String(e)),t.setAttribute("viewBox",`0 0 ${n} ${e}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}async function At(){let t=document.querySelector("#screen svg"),n={...await Y(),element:t,tilt:[-.12,0],mode:document.documentElement.dataset.mode},e=null;window.addEventListener("resize",()=>{e!==null&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>{j(n),x(n)})}),document.querySelector("#screen form").addEventListener("change",o=>{let l=o.target;if(l instanceof HTMLInputElement&&l.name==="mode"){let i=n.mode,u=l.value;document.documentElement.dataset.mode=u,n.mode=u,(u==="fantasy"||i==="fantasy")&&x(n),window.sendEvent?.(["set mode",u])}}),j(n),x(n),ot(n),at(n)}At();})();
