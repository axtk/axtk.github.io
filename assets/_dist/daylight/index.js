"use strict";(()=>{var w=Math.PI/180,J=180/Math.PI,B=3600*180/Math.PI;var b=class{phi;theta;r;constructor(e,r,o=1){this.phi=e,this.theta=r,this.r=o}};var{abs:U}=Math;function X(t,e,r){return(t<0||e<0||r<0?-1:1)*(U(t)+U(e)/60+U(r)/3600)}var{floor:O}=Math;function k(t){t=t instanceof Date?t:new Date(t);let e=t.getUTCFullYear(),r=t.getUTCMonth()+1,o=t.getUTCDate(),i=t.getUTCHours(),n=t.getUTCMinutes(),s=t.getUTCSeconds();r<=2&&(r+=12,e--);let l;1e4*e+100*r+o<=15821004?l=-2+O((e+4716)/4)-1179:l=O(e/400)-O(e/100)+O(e/4);let a=365*e-679004+l+O(30.6001*(r+1))+o,u=X(i,n,s)/24;return a+u}var{PI:Ct,floor:Lt}=Math,W=86400,Tt=2*Ct;function Q(t){let e=k(t),r=Lt(e),o=W*(e-r),i=(r-51544.5)/36525,n=(e-51544.5)/36525,s=24110.54841+8640184812866e-6*i+1.0027379093*o+(.093104-62e-7*n)*n*n;return Tt/W*(s%W)}var{PI:Et,sqrt:Z,atan2:_,sin:tt,cos:et}=Math,D=class t{x;y;z;constructor(e=0,r=0,o=0){this.x=e,this.y=r,this.z=o}toPolar(){let{x:e,y:r,z:o}=this,i=e*e+r*r,n=Z(i+o*o),s=_(r,e),l=_(o,Z(i));return s<0&&(s+=2*Et),new b(s,l,n)}static fromPolar(e){let{phi:r,theta:o,r:i}=e,n=i*et(o);return new t(n*et(r),n*tt(r),i*tt(o))}};function qt(t,e){let r=0;for(let o=0,i=Math.min(t.length,e.length);o<i;o++)r+=t[o]*e[o];return r}var C=class t{value;rows;columns;constructor(e){this.value=e;let r=[];for(let o=0,i=e.length;o<i;o++)for(let n=0,s=e[o].length;n<s;n++)r[n]||(r[n]=new Array(i)),r[n][o]=e[o][n];this.rows=e,this.columns=r}multiplyByVec(e){return this.multiplyBy(t.fromVector(e)).toCartesianVector()}multiplyBy(e){let r=[];for(let o=0,i=this.rows.length;o<i;o++)for(let n=0,s=e.columns.length;n<s;n++)r[o]||(r[o]=new Array(s)),r[o][n]=qt(this.rows[o],e.columns[n]);return new t(r)}toCartesianVector(){return new D(this.columns[0][0],this.columns[0][1],this.columns[0][2])}static fromVector(e){if(e instanceof D)return new t([[e.x],[e.y],[e.z]]);if(e instanceof b)return t.fromVector(D.fromPolar(e))}};var{sin:$,cos:z}=Math,R=class extends C{constructor(e){super([[1,0,0],[0,+z(e),+$(e)],[0,-$(e),+z(e)]])}},G=class extends C{constructor(e){super([[+z(e),0,-$(e)],[0,1,0],[+$(e),0,+z(e)]])}};function V({phi:t,theta:e},r,{lat:o,lon:i}){let n=Q(r)+i-t,s=new b(n,e);return new G(Math.PI/2-o).multiplyByVec(s).toPolar()}function y(t){return t-Math.floor(t)}var{sin:rt}=Math,Y=2*Math.PI;function N(t,e=0){let r=(k(t)-51544.5)/36525+e,o=Y*y(.993133+99.997361*r),i=Y*y(.7859453+o/Y+(6893*rt(o)+72*rt(2*o)+6191.2*r)/1296e3);return new b(i,0)}var $t=23.43929111*w;function ot(t){let e=N(t);return new R(-$t).multiplyByVec(e).toPolar()}function L(t,e){return V(ot(t),t,e)}var{sin:c}=Math,T=2*Math.PI;function v(t){let e=(k(t)-51544.5)/36525,r=y(.606433+1336.855225*e),o=T*y(.374897+1325.55241*e),i=T*y(.993133+99.997361*e),n=T*y(.827361+1236.853086*e),s=T*y(.259086+1342.227825*e),l=22640*c(o)-4586*c(o-2*n)+2370*c(2*n)+769*c(2*o)-668*c(i)-412*c(2*s)-212*c(2*o-2*n)-206*c(o+i-2*n)+192*c(o+2*n)-165*c(i-2*n)-125*c(n)-110*c(o+i)+148*c(o-i)-55*c(2*s-2*n),a=s+(l+412*c(2*s)+541*c(i))/B,u=s-2*n,p=-526*c(u)+44*c(o+u)-31*c(-o+u)-23*c(i+u)+11*c(-i+u)-25*c(-2*o+s)+21*c(-o+s);return new b(T*y(r+l/1296e3),(18520*c(a)+p)/B)}var zt=23.43929111*w;function nt(t){let e=v(t);return new R(-zt).multiplyByVec(e).toPolar()}function E(t,e){return V(nt(t),t,e)}var j=2*Math.PI,Gt=-8.32/(1440*36525);function it(t){return(v(t).phi-N(t,Gt).phi+j)%j/j}var Vt=2*Math.PI,mt=6e4,q=60*mt;function x({phi:t,theta:e}){let r=(t+Math.PI)%Vt*J,o=e*J;return[r,o]}function Nt(t){return typeof t=="number"?t:t===void 0?Date.now():(t instanceof Date?t:new Date(t)).getTime()}var st=-2.5*q,lt=22.5*q;function at(t,e){let r=Nt(e),o=[],i=[];for(let l=st;l<lt;l+=mt)o.push(x(L(r+l,t))),i.push(x(E(r+l,t)));let n=[],s=[];for(let l=0;l>=st;l-=q)n.push(x(L(r+l,t))),s.push(x(E(r+l,t)));for(let l=q;l<lt;l+=q)n.push(x(L(r+l,t))),s.push(x(E(r+l,t)));return{sun:{position:x(L(r,t)),track:o,ticks:n},moon:{position:x(E(r,t)),track:i,ticks:s,phase:it(r)}}}function ut({element:t}){let e=t.parentElement;if(!e)return;t.setAttribute("style","display: none");let{width:r,height:o}=e.getBoundingClientRect();t.setAttribute("width",String(r)),t.setAttribute("height",String(o)),t.setAttribute("viewBox",`0 0 ${r} ${o}`),t.setAttribute("data-size",Math.random().toString(36).slice(2)),t.removeAttribute("style")}var F=null,ct="";function f({element:t}){let e=t.getAttribute("data-size");return e===ct&&F!==null||(F={width:Number(t.getAttribute("width")),height:Number(t.getAttribute("height"))},ct=e),F}var h="http://www.w3.org/2000/svg",S={default:20,sun:42},P=24,pt=0,I=23.5/180*Math.PI;function ft([t,e],r){let{width:o,height:i}=f(r),n=(r.location.lat<I?.5-t/o:t/o)*360,s=(.5-(e-P)/(i-2*P))*180;return n<0&&(n+=360),[n,s]}var vt=5,dt=["N","E","S","W"];function ht(t){let e=t.element.querySelector(".directions"),{width:r,height:o}=f(t),i=Array.from(e.querySelectorAll(".tick")),n=Array.from(e.querySelectorAll(".tick-label"));for(;i.length<5;){let s=document.createElementNS(h,"line");s.setAttribute("class","tick"),e.appendChild(s),i.push(s)}for(;n.length<5;){let s=document.createElementNS(h,"text");e.appendChild(s),n.push(s)}for(let s=0;s<i.length;s++){let l=i[s],a=s/4*r;l.setAttribute("x1",String(a)),l.setAttribute("y1",String(o/2-vt)),l.setAttribute("x2",String(a)),l.setAttribute("y2",String(o/2))}for(let s=0;s<n.length;s++){let l=n[s],a=s/4*r,[u]=ft([a,0],t);l.setAttribute("x",String(a)),l.setAttribute("y",String(o/2+12)),l.textContent=dt[Math.floor(u/90)%dt.length],a<1?l.setAttribute("class","leftmost tick-label"):a>r-1?l.setAttribute("class","rightmost tick-label"):l.setAttribute("class","tick-label")}}function Ft(){return new Promise((t,e)=>{if(!navigator.geolocation)return e(new Error("Geolocation is not supported by the browser."));navigator.geolocation.getCurrentPosition(r=>{if(!r||!r.coords)return e(new Error("Failed to retrieve current location."));t({lat:r.coords.latitude,lon:r.coords.longitude})},()=>{e(new Error(`Failed to retrieve current location.
Make sure geolocation is enabled.`))})})}var It={p:"55.76\xB0 N, 37.62\xB0 E"};function gt(){let t=new URLSearchParams(window.location.search);for(let r of["p","t"]){let o=(t.get(r)??"").trim(),i=document.querySelector(`form [name="${r}"]`);i instanceof HTMLInputElement&&(i.value=o||(It[r]??""))}let e=document.querySelector("#set-current-location");e&&e.addEventListener("click",()=>{Ft().then(r=>{let{searchParams:o}=new URL(window.location.href);o.set("p",`${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`),window.location.search=o.toString()}).catch(r=>{alert(r.message)})})}function g([t,e],r){let{width:o,height:i}=f(r),n=(r.location.lat<I?.5-t/360:t/360)*o,s=P+(.5-e/180)*(i-2*P);return n<0&&(n+=o),[n,s]}function bt(t){let e=t.element.querySelector(".horizon"),{width:r,height:o}=f(t),i=Array.from(e.querySelectorAll(".twilight"));for(;i.length<3;){let n=document.createElementNS(h,"rect");n.setAttribute("class","twilight"),n.setAttribute("x","0"),e.appendChild(n),i.push(n)}for(let n=0;n<i.length;n++){let s=i[n],l=g([0,-n*6],t)[1];s.setAttribute("y",String(l)),s.setAttribute("width",String(r)),s.setAttribute("height",String(o-l-pt))}}function yt(t,e,r){let o=r.element.querySelector(`.markers [data-id="${e}"]`),i=S[e]??S.default,[n,s]=g(t,r);return o.setAttribute("data-id",e),o.setAttribute("x",String(n-i/2)),o.setAttribute("y",String(s-i/2)),o.setAttribute("width",String(i)),o.setAttribute("height",String(i)),o}function St(t){let{tracks:{sun:e,moon:r}}=t;yt(e.position,"sun",t),yt(r.position,"moon",t)}function xt(t,e,r){let{width:o,height:i}=f(r),n=r.element.querySelector("g.marker-lines"),s=Array.from(n.querySelectorAll(`line[data-id="${e}"]`));for(;s.length<4;){let m=document.createElementNS(h,"line");m.setAttribute("data-id",e),n.appendChild(m),s.push(m)}let[l,a]=g(t,r),u=(S[e]??S.default)/2,p=[[[0,a],[l-u,a]],[[l+u,a],[o,a]],[[l,e==="sun"?0:i/2],[l,a-u]],[[l,a+u],[l,e==="sun"?i/2:i]]];for(let m=0;m<s.length;m++){let A=p[m][1][0]-p[m][0][0],H=p[m][1][1]-p[m][0][1];A<1&&H<1?s[m].setAttribute("class","hidden"):s[m].hasAttribute("class")&&s[m].removeAttribute("class"),s[m].setAttribute("x1",String(p[m][0][0])),s[m].setAttribute("y1",String(p[m][0][1])),s[m].setAttribute("x2",String(p[m][1][0])),s[m].setAttribute("y2",String(p[m][1][1]))}}function At(t){let{tracks:{sun:e,moon:r}}=t;xt(e.position,"sun",t),xt(r.position,"moon",t)}var M=S.moon??S.default,d=M/2;function wt(t){let e=t.element.querySelector("g.markers"),r=e.querySelector('[data-id="moon-phase"]');r||(r=document.createElementNS(h,"svg"),r.setAttribute("data-id","moon-phase"),r.setAttribute("viewBox",`0 0 ${M} ${M}`),r.setAttribute("width",String(M)),r.setAttribute("height",String(M)),e.appendChild(r));let o=r.querySelector("path");o||(o=document.createElementNS(h,"path"),o.setAttribute("class","phase-shadow"),r.appendChild(o));let{position:i,phase:n}=t.tracks.moon;n>=1&&(n-=1);let s=Math.floor(n/.25),l=d*(n%.25/.25),a,u,p,m;switch(s){case 0:a=d,p=1,u=d-l,m=1;break;case 1:a=d,p=1,u=l,m=0;break;case 2:a=d-l,p=0,u=d,m=1;break;default:a=l,p=1,u=d,m=1}o.setAttribute("d",`M ${d},${M} A ${a} ${d} 180 0 ${p} ${d},0 A ${u} ${d} 180 0 ${m} ${d},${M}`);let[A,H]=g(i,t);r.setAttribute("x",String(A-d)),r.setAttribute("y",String(H-d))}function Mt(t,e){let{width:r}=f(e),o=document.querySelector(`.pos[data-id="${t}"]`),{position:i}=e.tracks[t];o.querySelector(".az .value").textContent=`${i[0].toFixed(1)}\xB0`,o.querySelector(".h .value").textContent=`${i[1].toFixed(1)}\xB0`,t==="moon"&&(o.querySelector(".ph .value").textContent=e.tracks.moon.phase.toFixed(2));let[n]=g(i,e),{width:s}=o.querySelector("span").getBoundingClientRect();o.style.setProperty("--x",`${Math.min(n-6,r-s)}px`)}function kt(t){Mt("sun",t),Mt("moon",t)}function Dt(t,e,r){let{width:o,height:i}=f(r),n=document.createElementNS(h,"path"),s="",l=null,a=null;for(let u=0;u<t.length;u++){let p=s?" L":"M",[m,A]=g(t[u],r);(l!==null&&Math.abs(m-l)>.95*o||a!==null&&Math.abs(A-a)>.95*i)&&(p=" M"),s+=`${p}${m},${A}`,l=m,a=A}return n.setAttribute("d",s),n.setAttribute("class","track"),n.setAttribute("data-id",e),n}function Rt(t,e,r){let o=document.createDocumentFragment();for(let i of t){let n=document.createElementNS(h,"circle"),[s,l]=g(i,r);n.setAttribute("cx",String(s)),n.setAttribute("cy",String(l)),n.setAttribute("r","1.5"),n.setAttribute("class","tick"),n.setAttribute("data-id",e),o.appendChild(n)}return o}function Pt(t){let{element:e,tracks:{sun:r,moon:o}}=t,i=e.querySelector("g.tracks");i.innerHTML="",i.appendChild(Dt(r.track,"sun",t)),i.appendChild(Rt(r.ticks,"sun",t)),i.appendChild(Dt(o.track,"moon",t)),i.appendChild(Rt(o.ticks,"moon",t))}function Ht(){let e=(document.querySelector('form [name="p"]')?.value.trim()??"").split(/\s*[,;]\s*/),r=parseFloat(e[0])*w,o=parseFloat(e[1])*w;return e[0]?.endsWith("S")&&(r*=-1),e[1]?.endsWith("W")&&(o*=-1),{lat:r,lon:o}}function Jt(){return document.querySelector('form [name="t"]')?.value.trim()||Date.now()}function Bt(){let t=document.querySelector("#screen svg"),e=Ht(),r=Jt();return{element:t,tracks:at(e,r),location:e,time:r}}function Ut({location:t,time:e}){let r=t&&!isNaN(t.lat)&&!isNaN(t.lon)&&(typeof e=="number"||!isNaN((e instanceof Date?e:new Date(e)).getTime()));return document.documentElement.classList.toggle("error",!r),r}function Ot(){gt();let t=Bt();Ut(t)&&(ut(t),bt(t),ht(t),Pt(t),St(t),At(t),kt(t),wt(t))}function Wt(){let t=null;window.addEventListener("resize",()=>{t!==null&&clearTimeout(t),t=setTimeout(Ot,200)}),Ot()}Wt();})();
